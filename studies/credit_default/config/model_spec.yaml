# Credit Quality Sensitivity to External Shocks
# ==============================================
#
# DESIGN CHANGE (January 2026):
# Original design required loan-level data with cashflows (unavailable).
# Revised design uses aggregate NBK credit quality data with external shocks.
#
# This is a REDUCED-FORM analysis: external shocks → credit quality
# NOT a causal estimate of "income → default" (would require micro data)

study_type: reduced_form_macro
version: "2.0"

# Research question
research_question: |
  How do exogenous external shocks (oil, global risk, demand) affect
  aggregate credit quality in Kazakhstan?

# Caveats (MUST be stated prominently)
caveats:
  - "This is reduced-form evidence, not causal income→default elasticity"
  - "Aggregate NPL ≠ fintech consumer defaults (composition differs)"
  - "Results apply to banking system, not specific loan products"
  - "External shocks may affect credit through multiple channels (FX, inflation, fiscal)"

# ============================================================================
# DATA SOURCES
# ============================================================================

data_sources:
  primary:
    name: nbk_loan_portfolio_quality
    url: "https://nationalbank.kz/en/news/banks-performance/rubrics/2186"
    frequency: monthly
    coverage: "2005-present"
    variables:
      - overdue_30_plus
      - overdue_60_plus
      - overdue_90_plus
      - total_loans

  secondary:
    - name: imf_fsi_npl
      url: "https://data.imf.org/FSI"
      frequency: quarterly
      coverage: "2008-present"
      variables:
        - npl_ratio

    - name: worldbank_npl
      url: "https://data.worldbank.org/indicator/FB.AST.NPER.ZS?locations=KZ"
      frequency: annual
      coverage: "2008-2023"
      variables:
        - npl_ratio

  shocks:
    - name: oil_supply_shock
      source: baumeister_hamilton
      frequency: monthly

    - name: oil_demand_shock
      source: baumeister_hamilton
      frequency: monthly

    - name: global_risk
      source: vix
      frequency: monthly

    - name: global_activity
      source: igrea
      frequency: monthly

    - name: brent_price
      source: fred
      series: DCOILBRENTEU
      frequency: monthly

# ============================================================================
# OUTCOMES (Credit Quality Measures)
# ============================================================================

outcomes:
  primary:
    name: npl_ratio
    description: "Non-performing loans to gross loans (%)"
    source: imf_fsi_or_nbk
    frequency: quarterly_or_monthly

  secondary:
    - name: overdue_90_plus
      description: "Loans 90+ days overdue (% of total)"
      source: nbk

    - name: overdue_30_plus
      description: "Loans 30+ days overdue (% of total)"
      source: nbk

    - name: credit_growth
      description: "Year-over-year credit growth (%)"
      source: nbk

# ============================================================================
# ESTIMATION: LOCAL PROJECTIONS
# ============================================================================

local_projections:
  # Horizons
  max_horizon: 12  # months (or quarters if quarterly data)
  horizons: [0, 1, 2, 3, 4, 6, 8, 12]

  # Specification
  specification: |
    Δ CreditQuality_{t+h} = α_h + β^oil_h S^oil_t + β^risk_h S^risk_t
                          + β^dem_h S^dem_t + Γ_h' X_{t-1} + u_{t,h}

  shocks:
    - name: oil_supply_shock
      expected_sign: positive  # Bad supply shock → worse credit
      description: "Oil supply disruption"

    - name: oil_demand_shock
      expected_sign: positive  # Bad demand shock → worse credit
      description: "Global demand contraction"

    - name: vix_innovation
      expected_sign: positive  # Higher risk → worse credit
      description: "Global risk shock"

  controls:
    - cpi_inflation
    - policy_rate
    - exchange_rate_depreciation
    - credit_growth_lag

  inference:
    method: newey_west
    lags: 4  # For monthly data
    confidence_level: 0.90

# ============================================================================
# FALSIFICATION TESTS
# ============================================================================

falsification:
  # Leads test: shocks should not predict PAST credit quality
  leads_test:
    leads: [1, 2, 3]  # Test h = -1, -2, -3
    null_hypothesis: "Future shocks do not predict current credit quality"

  # Alternative shock definitions
  alternative_shocks:
    - name: brent_returns
      description: "Simple Brent price returns (not structural)"
    - name: lag_shock
      description: "Lagged shock (should be weaker)"

  # Backtests on known episodes
  historical_episodes:
    - name: oil_collapse_2014
      start: "2014Q3"
      end: "2015Q4"
      expected: "NPL should rise with lag"

    - name: pandemic_2020
      start: "2020Q1"
      end: "2020Q4"
      expected: "Credit deterioration with policy response"

    - name: 2022_energy_crisis
      start: "2022Q1"
      end: "2022Q4"
      expected: "Moderate stress, global tightening"

# ============================================================================
# SECONDARY ANALYSIS: IMPLIED INCOME SENSITIVITY
# ============================================================================

implied_income_sensitivity:
  enabled: true
  method: wald_ratio

  description: |
    If we also estimate: Δlog(Income) = a + π S_t + ...
    and: Δ NPL = b + ρ S_t + ...
    then ρ/π is implied income→NPL sensitivity
    UNDER STRONG ASSUMPTION that shock affects NPL only through income.

  caveats:
    - "Exclusion restriction unlikely to hold (FX, inflation, fiscal channels)"
    - "Report as 'implied sensitivity under strong assumptions'"
    - "NOT a causal income→default elasticity"

# ============================================================================
# OUTPUTS
# ============================================================================

outputs:
  irf_estimates:
    name: "Credit Quality Response to External Shocks"
    format: table_and_plot
    horizons: [0, 1, 2, 4, 8, 12]
    confidence_bands: 90

  event_study_plots:
    - oil_collapse_2014
    - pandemic_2020

  summary_statistics:
    - mean_npl
    - std_npl
    - correlation_with_oil

  interpretation_document:
    sections:
      - executive_summary
      - data_description
      - methodology
      - results
      - falsification
      - caveats
      - implications

# ============================================================================
# WHAT THIS STUDY CANNOT DO (Important for framing)
# ============================================================================

limitations:
  cannot_estimate:
    - "Causal income→default elasticity (requires micro data)"
    - "Consumer fintech default specifically (aggregate bank NPL)"
    - "Regional heterogeneity (only national data available)"

  can_estimate:
    - "Reduced-form external shock → aggregate credit quality"
    - "Lag structure of credit deterioration"
    - "Asymmetry (bad vs good shocks)"
    - "Regime differences (if enough data)"
