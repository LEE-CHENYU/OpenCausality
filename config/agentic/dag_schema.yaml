# DAG schema v3 for agentic causal identification
# This file describes the expected structure for DAG specifications.
# It is not a JSON-schema; it is a human-readable contract.
#
# V2 CHANGES:
# - Added temporal semantics (timing, release_lag)
# - Added credibility-based acceptance criteria (removed min_tstat)
# - Added derived node tracking (identity, depends_on)
# - Added aggregation configuration
# - Added null_acceptance for preventing p-hacking
#
# V3 CHANGES (Generalization):
# - Added unit_specification on edges (treatment_unit, outcome_unit) for safe chain propagation
# - Added edge_type (causal, reaction_function, mechanical, immutable) to distinguish edge semantics
# - Added propagation_rules for automated chain multiplication
# - Added validation_pipeline configuration
# - Domain-agnostic: works for any causal DAG, not just KSPI/banking
#
# V3.1 CHANGES (Query Mode Separation):
# - Added "identity" to edge_type (pure arithmetic, e.g., K2 = Capital / RWA)
# - Added variant_of field for robustness variants (annual, sector companions)
# - Added optional mode_permissions override for edge-specific gating
# - edge_type now REQUIRED in CONFIRMATION mode (inferred with warning in EXPLORATION)
# - Query modes (STRUCTURAL, REDUCED_FORM, DESCRIPTIVE) gate propagation and counterfactuals
#   per edge based on edge_type + claim_level. See config/agentic/query_modes.yaml.

schema_version: 3

metadata:
  name: "<study_name>"
  description: "<short description>"
  target_node: "<node_id>"
  created: "YYYY-MM-DD"
  owner: "<team_or_owner>"
  tags: ["macro", "micro", "banking"]

# =============================================================================
# NODES
# =============================================================================
# Nodes define variables and how they map to data assets.
# V2 adds: release_lag, derived, identity, depends_on, aggregation, role_constraints

nodes:
  - id: "<node_id>"
    name: "<display_name>"
    description: "<what this variable represents>"
    unit: "<level|log|pct|growth|index|sd>"
    frequency: "<daily|monthly|quarterly|annual|static|event>"
    type: "<continuous|binary|count|share|index|exposure>"
    observed: true
    latent: false

    # NEW v2: Publication timing
    # Data for period t is released at t + periods
    release_lag:
      periods: 1                    # Number of lag periods
      lag_unit: "month"             # day|month|quarter|year

    # NEW v2: Derived node tracking
    # Mark nodes that are computed from other nodes
    derived: false                  # true if defined by identity formula
    identity:
      name: "<derived_name>"
      formula: "<human_readable_formula>"  # e.g., "nominal_income - cpi"
      depends_on: ["<node_id>", "<node_id>"]  # Auto-computed from formula

    # NEW v2: Aggregation configuration (for mixed-frequency alignment)
    aggregation:
      method: "average"             # end_of_period|average|sum|last
      seasonal_adjust: false        # Apply seasonal adjustment
      deflator: "<node_id>"         # Deflate using this price index
      deflator_timing: "same"       # same|lagged

    # NEW v2: Role constraints
    role_constraints:
      never_control: false          # e.g., outcome nodes
      never_instrument: false       # e.g., endogenous nodes

    # Data source configuration
    source:
      preferred:
        - connector: "<bns|fred|nbk_credit|imf_fsi|baumeister|custom>"
          dataset: "<dataset_id>"
          series: "<series_id>"
          notes: "<optional mapping notes>"
      fallback:
        - connector: "<connector_name>"
          dataset: "<dataset_id>"
          series: "<series_id>"

    # Transforms to apply after fetching
    transforms:
      - "<log|diff|deflate|seasonal_adjust|zscore|aggregate_mean_to_quarter|innovation>"

    # Legacy identities field (use identity above for new DAGs)
    identities:
      - name: "<derived_name>"
        formula: "<human_readable_formula>"

    tags: ["macro", "bank", "household", "shock", "exposure"]

# =============================================================================
# EDGES
# =============================================================================
# Edges define estimands and identification constraints for each causal link.
# V2 adds: timing block, credibility-based acceptance_criteria

edges:
  - id: "<edge_id>"
    from: "<node_id>"
    to: "<node_id>"

    # NEW v3: Edge Type Classification
    # CRITICAL for interpretation, propagation, and query mode gating
    edge_type: "causal"             # causal|reaction_function|mechanical|immutable|identity
    # - causal: Standard causal edge, supports shock propagation (claim-level dependent)
    # - reaction_function: Endogenous policy response (NEVER propagates in any mode)
    # - mechanical: Deterministic accounting relationship (bridge role, always propagates)
    # - immutable: Validated evidence, locked from re-estimation (structural role)
    # - identity: Pure arithmetic identity (e.g., K2 = Capital / RWA; always propagates)
    #
    # REQUIRED in CONFIRMATION mode. In EXPLORATION mode, inferred from edge_status with
    # INFO-level warning. If absent:
    #   IMMUTABLE -> "immutable", IDENTITY -> "identity",
    #   ESTIMABLE_REDUCED_FORM -> "causal", NEEDS_CONNECTOR -> "causal"

    # NEW v3.1: Variant Tracking
    # Marks robustness variants (annual, sector, etc.) of a primary edge
    variant_of: "<parent_edge_id>"  # Optional. e.g., "shock_to_npl_kspi" for sector companion
    # Variants inherit parent's edge_type. They are NOT on the propagation critical path.
    # Only the primary edge participates in propagation and counterfactual gating.

    # NEW v3.1: Mode Permissions Override (rare, edge-specific)
    # Allows overriding the default mode permissions derived from edge_type + claim_level.
    # Use only when the truth table default is inappropriate for a specific edge.
    # mode_permissions:
    #   STRUCTURAL:
    #     propagation: true
    #     shock_cf: false
    #     policy_cf: false

    # NEW v3: Unit Specification (REQUIRED for chain propagation)
    # Without units, chain multiplication produces meaningless numbers
    unit_specification:
      treatment_unit: "<treatment_unit>"   # e.g., "1pp", "1 SD", "10% depreciation", "1 bn KZT"
      outcome_unit: "<outcome_unit>"       # e.g., "pp", "bps", "bn KZT", "% change"
      notes: "<optional notes on unit normalization>"

    # NEW v2: Temporal semantics
    # Specifies the timing relationship between treatment and outcome
    timing:
      lag: 1                        # treatment[t] → outcome[t+lag], default=1
      lag_unit: "quarter"           # day|month|quarter|year
      contemporaneous: false        # if true, treatment[t] → outcome[t]
      max_anticipation: 0           # leads allowed (usually 0)

    # Estimand specification
    estimand:
      type: "<ATE|ATT|elasticity|IRF|ATE(h)>"
      horizon: 0                    # or [0, 1, 2, 3, 4] for IRFs
      scale: "<level|log|pct>"

    # Design constraints
    allowed_designs:
      - "PANEL_FE_BACKDOOR"
      - "DID_EVENT_STUDY"
      - "IV_2SLS"
      - "LOCAL_PROJECTIONS"
      - "RDD"

    design_priority: ["PANEL_FE_BACKDOOR", "IV_2SLS"]  # Order of preference

    # Adjustment sets
    required_adjustments: ["<node_id>"]    # Must include as controls
    forbidden_controls: ["<node_id>"]      # Cannot include (auto-computed for descendants)
    instruments: ["<node_id>"]             # For IV designs

    # Diagnostics to run
    diagnostics_required:
      - "pre_trends"
      - "placebo"
      - "weak_iv"
      - "residual_checks"

    # NEW v2: Credibility-based acceptance criteria
    # IMPORTANT: Does NOT include min_tstat to prevent p-hacking
    acceptance_criteria:
      # Diagnostics thresholds (tests must NOT reject)
      diagnostics:
        pretrend_p_min: 0.10        # Pre-trends p-value must exceed this
        first_stage_f_min: 10.0     # IV first-stage F must exceed this
        placebo_p_min: 0.10         # Placebo test p-value must exceed this
        density_p_min: 0.10         # McCrary density test (RDD)

      # Data quality requirements
      data:
        max_missing_rate: 0.05      # Maximum allowed missing rate
        min_obs: 50                 # Minimum observations
        min_pre_periods: 4          # Minimum pre-treatment periods (for event studies)

      # Plausibility constraints
      plausibility:
        expected_sign: "any"        # positive|negative|any
        magnitude_range: [-2.0, 2.0]  # Elasticity bounds [min, max]

      # Stability requirements
      stability:
        regime_split_date: null     # e.g., "2015-08" for structural break test
        max_coefficient_change: 0.5 # Max |β_pre - β_post| / |β_pooled|

      # NULL ACCEPTANCE (critical for avoiding p-hacking)
      # A null result with tight standard errors is a valid finding!
      null_acceptance:
        enabled: true
        equivalence_bound: 0.1      # "precisely null" if |β| < bound and CI tight

    notes: "<assumptions or caveats>"

# =============================================================================
# CREDIBILITY SCORING
# =============================================================================
# How EdgeCard credibility scores are computed.
# IMPORTANT: Does NOT use statistical significance.

credibility_score:
  weights:
    diagnostics_pass_rate: 0.40     # % of required diagnostics that pass
    plausibility_check: 0.20        # Does estimate have expected sign/magnitude?
    stability_across_specs: 0.20    # Robust to specification changes?
    data_coverage: 0.10             # Data quality and coverage
    design_strength: 0.10           # Panel FE < DiD < RDD < IV

  thresholds:
    A: 0.80   # High confidence
    B: 0.60   # Moderate confidence
    C: 0.40   # Suggestive
    D: 0.00   # Not identified / association only

# =============================================================================
# ASSUMPTIONS & LATENTS
# =============================================================================

assumptions:
  - id: "<assumption_id>"
    statement: "<explicit causal assumption>"
    applies_to_edges: ["<edge_id>"]
    testable: false
    test_method: "<description of how to test if testable>"

latents:
  - id: "<latent_id>"
    description: "<unobserved confounder>"
    affects: ["<node_id>"]

# =============================================================================
# GOVERNANCE
# =============================================================================
# Specification changes allowed during exploration mode.

allowed_refinements:
  - id: "add_control"
    allowed_controls: ["<node_id>", "<node_id>"]

  - id: "change_lag_length"
    range: [1, 6]

  - id: "regime_split"
    allowed_dates: ["2015-08", "2020-03"]

  - id: "swap_instrument"
    allowed_instruments: ["<node_id>", "<node_id>"]

  - id: "bandwidth_change"
    design: "RDD"
    range: [0.5, 2.0]

# =============================================================================
# PROPAGATION RULES (NEW v3)
# =============================================================================
# Rules for propagating shocks through the DAG.

propagation_rules:
  # Edge types that BLOCK shock propagation
  blocked_edge_types:
    - "reaction_function"   # Endogenous policy response cannot propagate

  # Unit compatibility rules for chain multiplication
  unit_compatibility:
    enabled: true
    # When multiplying edges, output unit of edge N must match input unit of edge N+1
    # Example: edge1 outputs "pp" → edge2 must accept "pp" (or compatible "1pp") as input

  # Chain multiplication rules
  chain_multiplication:
    # When propagating shock S through edges A→B→C:
    # Effect on C = beta_A * beta_B (if units compatible)
    # SE propagation: sqrt(beta_B^2 * se_A^2 + beta_A^2 * se_B^2) (delta method)
    se_method: "delta_method"

  # Warning flags
  warnings:
    - "reaction_function_in_path"  # Path includes reaction function edge
    - "unit_mismatch"              # Units don't match across edges
    - "mechanical_edge"            # Path includes identity/accounting edge
    - "immutable_edge"             # Path includes locked validated evidence

# =============================================================================
# VALIDATION PIPELINE (NEW v3)
# =============================================================================
# Automated checks to run after estimation.

validation_pipeline:
  # Pre-estimation checks (before running estimators)
  pre_checks:
    - id: "unit_presence"
      description: "All edges have treatment_unit and outcome_unit specified"
      severity: "error"

    - id: "edge_type_presence"
      description: "All edges have edge_type specified"
      severity: "error"

    - id: "node_source_defined"
      description: "All observed nodes have data source defined"
      severity: "warning"

    - id: "dag_acyclic"
      description: "DAG has no cycles"
      severity: "error"

  # Post-estimation checks (after running estimators)
  post_checks:
    - id: "n_consistency"
      description: "N in report matches N in EdgeCard"
      severity: "error"

    - id: "unit_in_card"
      description: "EdgeCard has treatment_unit and outcome_unit populated"
      severity: "error"

    - id: "interpolation_fraction"
      description: "Interpolated obs < 30% of sample for estimation-eligible edges"
      severity: "warning"
      threshold: 0.30

    - id: "reaction_function_labeled"
      description: "Reaction function edges have is_reaction_function=true in EdgeCard"
      severity: "error"

    - id: "loo_stability"
      description: "Leave-one-out stability check passes for panel edges"
      severity: "warning"

    - id: "sign_consistency"
      description: "Estimated sign matches expected_sign in DAG spec"
      severity: "warning"

  # Report consistency checks
  report_checks:
    - id: "report_vs_card_match"
      description: "Report table values match EdgeCard estimates"
      fields: ["point", "se", "ci_95", "n_effective_obs_h0"]
      severity: "error"

    - id: "unit_table_present"
      description: "Report includes Unit Normalization Reference table"
      severity: "warning"

    - id: "reaction_function_warning"
      description: "Reaction function edges have warning in report"
      severity: "warning"

# =============================================================================
# DOMAIN EXAMPLES (NEW v3)
# =============================================================================
# Example DAG structures for different domains to show generality.

domain_examples:
  banking_stress_test:
    description: "Shocks → Macro → Bank Balance Sheet → Capital Ratio"
    example_path: ["oil_shock", "fx_rate", "inflation", "npl_ratio", "capital_ratio"]
    key_edges:
      - { from: "fx_rate", to: "inflation", type: "causal" }
      - { from: "inflation", to: "policy_rate", type: "reaction_function" }

  labor_economics:
    description: "Policy → Employment → Wages → Welfare"
    example_path: ["minimum_wage", "employment", "wages", "consumption"]
    key_edges:
      - { from: "minimum_wage", to: "employment", type: "causal" }

  environmental:
    description: "Regulation → Emissions → Health → Productivity"
    example_path: ["carbon_tax", "emissions", "air_quality", "mortality"]
    key_edges:
      - { from: "carbon_tax", to: "emissions", type: "causal" }

  healthcare:
    description: "Treatment → Biomarkers → Clinical Outcomes"
    example_path: ["drug_treatment", "blood_pressure", "cardiovascular_events"]
    key_edges:
      - { from: "drug_treatment", to: "blood_pressure", type: "causal" }
