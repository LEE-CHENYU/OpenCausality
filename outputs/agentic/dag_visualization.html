<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kspi_k2_stress</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #fff;
            color: #000;
        }
        #graph { width: 100vw; height: 100vh; }
        .node circle {
            fill: #fff;
            stroke: #000;
            stroke-width: 1.5px;
            cursor: grab;
        }
        .node circle:hover { stroke-width: 2.5px; }
        .node circle.latent { stroke-dasharray: 4, 3; }
        .node circle.id-risk { stroke: #c00; stroke-width: 2.5px; }
        .node text {
            font-size: 9px;
            font-weight: 400;
            pointer-events: none;
            text-anchor: middle;
        }
        .link {
            fill: none;
            stroke-opacity: 0.7;
        }
        .link:hover { stroke-opacity: 1; stroke-width: 3px !important; }
        .link.null { stroke-dasharray: 4, 3; stroke-opacity: 0.4; }
        .link.critical-issue { stroke: #f59e0b; stroke-width: 3px; }
        .label-bg {
            fill: white;
            stroke: none;
        }
        .link-label {
            font-size: 9px;
            font-weight: 500;
            fill: #333;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: middle;
        }
        .tooltip {
            position: absolute;
            background: #fff;
            border: 1px solid #000;
            padding: 12px 16px;
            font-size: 11px;
            pointer-events: none;
            opacity: 0;
            max-width: 380px;
            line-height: 1.5;
            z-index: 1000;
        }
        .tooltip.visible { opacity: 1; }
        .tooltip h3 { font-size: 12px; font-weight: 600; margin-bottom: 8px; border-bottom: 1px solid #000; padding-bottom: 6px; }
        .tooltip-row { display: flex; justify-content: space-between; margin: 3px 0; gap: 12px; }
        .tooltip-label { color: #666; white-space: nowrap; }
        .tooltip-value { font-weight: 500; font-variant-numeric: tabular-nums; text-align: right; }
        .tooltip-value.null { color: #999; }
        .tooltip-annotation { margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; color: #444; font-style: italic; }
        .tooltip-issues { margin-top: 6px; padding-top: 6px; border-top: 1px solid #eee; }
        .tooltip-issue { font-size: 10px; margin: 2px 0; }
        .tooltip-issue.critical { color: #c00; font-weight: 600; }
        .tooltip-issue.high { color: #a16207; }

        /* Proposal banner */
        .proposal-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 36px;
            background: #000;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            z-index: 200;
            letter-spacing: 0.5px;
        }
        .banner-sub {
            font-weight: 400;
            font-size: 10px;
            color: #aaa;
        }

        .controls {
            position: fixed;
            top: 50px;
            left: 20px;
            font-size: 11px;
            background: rgba(255,255,255,0.95);
            padding: 16px;
            border: 1px solid #000;
            z-index: 100;
            max-width: 220px;
        }
        .controls h1 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .controls .subtitle { color: #666; margin-bottom: 12px; font-size: 10px; }
        .control-row { margin: 8px 0; }
        .control-row label { color: #666; margin-right: 8px; }
        .control-row select {
            border: 1px solid #000;
            background: #fff;
            padding: 4px 8px;
            font-size: 11px;
            font-family: inherit;
        }
        .legend { margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd; }
        .legend-title { font-weight: 600; font-size: 10px; margin-bottom: 6px; }
        .legend-item { display: flex; align-items: center; margin: 4px 0; font-size: 10px; }
        .legend-line { width: 20px; height: 2px; margin-right: 8px; }
        .legend-line.dashed { border-top: 2px dashed; height: 0; }
        .stats {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 10px;
            color: #666;
        }
        .stats span { margin-right: 16px; }
        .stats strong { color: #000; }

        /* Pitfall sidebar */
        .pitfall-sidebar {
            position: fixed;
            top: 50px;
            right: 20px;
            width: 340px;
            max-height: calc(100vh - 70px);
            overflow-y: auto;
            background: rgba(255,255,255,0.95);
            border: 1px solid #000;
            font-size: 11px;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .pitfall-header {
            padding: 12px 16px 8px;
            border-bottom: 1px solid #ddd;
        }
        .pitfall-header h2 { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
        .pitfall-progress { margin-bottom: 4px; }
        .pitfall-progress-bar {
            width: 100%;
            height: 6px;
            border: 1px solid #000;
            background: #fff;
        }
        .pitfall-progress-fill {
            height: 100%;
            background: #000;
            transition: width 0.3s;
        }
        .pitfall-progress-label {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }
        #pitfallList {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px;
        }
        .pitfall-item {
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .pitfall-item:last-child { border-bottom: none; }
        .pitfall-item:hover { background: #f8f8f8; }
        .pitfall-item.active {
            border-left: 3px solid #2563eb;
            background: #f0f4ff;
        }
        .pitfall-item.resolved {
            opacity: 0.5;
        }
        .pitfall-item.resolved .pitfall-msg { text-decoration: line-through; }
        .pitfall-item-header {
            padding: 8px 0 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .pitfall-edge { font-weight: 600; font-size: 10px; }
        .pitfall-severity { font-size: 9px; font-weight: 600; padding: 1px 5px; border: 1px solid; display: inline-block; }
        .pitfall-severity.CRITICAL { background: #000; color: #fff; border-color: #000; }
        .pitfall-severity.HIGH { background: #fff; color: #000; border-color: #000; }
        .pitfall-severity.MEDIUM { background: #eee; color: #000; border-color: #ccc; }
        .pitfall-severity.LOW { background: #fff; color: #999; border-color: #ccc; }
        .pitfall-resolved-check { color: #080; font-weight: 700; font-size: 11px; display: none; }
        .pitfall-item.resolved .pitfall-resolved-check { display: inline; }
        .pitfall-msg { font-size: 10px; color: #555; margin-bottom: 4px; }
        .pitfall-empty { color: #999; font-style: italic; padding: 12px 0; }

        /* Collapsible decision panel */
        .pitfall-decision {
            display: none;
            padding: 8px 0 10px;
            border-top: 1px solid #eee;
            font-size: 10px;
            line-height: 1.6;
        }
        .pitfall-decision.open { display: block; }
        .pitfall-decision .pd-label {
            font-weight: 600;
            color: #444;
            margin-top: 6px;
            margin-bottom: 2px;
        }
        .pitfall-decision .pd-text {
            color: #555;
            margin-bottom: 4px;
        }
        .pitfall-decision .pd-guidance {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 4px 8px;
            margin-bottom: 6px;
        }
        .pitfall-decision select {
            width: 100%;
            border: 1px solid #000;
            background: #fff;
            padding: 3px 6px;
            font-size: 10px;
            font-family: inherit;
        }
        .pitfall-decision select.decided {
            background: #000;
            color: #fff;
        }
        .pitfall-decision .pd-tooltip-area {
            font-size: 9px;
            color: #666;
            min-height: 14px;
            margin-top: 2px;
            padding: 2px 4px;
            background: #fafafa;
            border: 1px solid #eee;
        }
        .pitfall-decision input[type="text"] {
            width: 100%;
            border: 1px solid #ccc;
            padding: 3px 6px;
            font-size: 10px;
            font-family: inherit;
            margin-top: 4px;
        }
        .pitfall-decision input[type="text"]:focus {
            border-color: #000;
            outline: none;
        }
        .pitfall-decision .pd-llm-guidance {
            background: #f0f4ff;
            border-left: 3px solid #2563eb;
            padding: 6px 10px;
            margin-bottom: 6px;
            font-size: 10px;
            line-height: 1.6;
            color: #333;
        }
        .pitfall-decision .pd-llm-guidance-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 2px;
        }
        .pitfall-decision .pd-buttons {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }
        .pitfall-decision .pd-btn {
            border: 1px solid #000;
            background: #fff;
            padding: 3px 12px;
            font-size: 10px;
            font-family: inherit;
            cursor: pointer;
        }
        .pitfall-decision .pd-btn:hover { background: #000; color: #fff; }
        .pitfall-decision .pd-btn.pd-btn-confirm { background: #000; color: #fff; }
        .pitfall-decision .pd-btn.pd-btn-confirm:hover { background: #333; }

        /* Sidebar footer */
        .pitfall-footer {
            padding: 10px 16px;
            border-top: 1px solid #000;
        }
        .pitfall-footer label {
            font-size: 10px;
            color: #666;
            display: block;
            margin-bottom: 4px;
        }
        .pitfall-footer input[type="text"] {
            width: 100%;
            border: 1px solid #000;
            padding: 4px 8px;
            font-size: 10px;
            font-family: inherit;
            margin-bottom: 6px;
        }
        .pitfall-footer .btn-export {
            width: 100%;
            border: 1px solid #000;
            background: #000;
            color: #fff;
            padding: 5px 12px;
            font-size: 11px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }
        .pitfall-footer .btn-export:hover { background: #333; }

        /* Edge highlight animation */
        @keyframes edgeFlash {
            0%, 100% { stroke-opacity: 1; }
            50% { stroke-opacity: 0.3; }
        }
        .link.highlighted {
            stroke: #2563eb !important;
            stroke-width: 4px !important;
            stroke-opacity: 1;
            animation: edgeFlash 1s ease-in-out 3;
        }
        .link.edge-resolved {
            stroke-dasharray: 6, 4;
            stroke-opacity: 0.3;
            stroke-width: 1px !important;
        }
    </style>
</head>
<body>
    <div class="proposal-banner">
        DRAFT PROPOSAL &mdash; Requires analyst review before use
        <span class="banner-sub">Resolve flagged issues or export decisions to proceed</span>
    </div>
    <svg id="graph"></svg>
    <div class="controls">
        <h1 id="dagTitle">kspi_k2_stress</h1>
        <div class="subtitle" id="dagSubtitle"></div>
        <div class="control-row">
            <label>Edge type</label>
            <select id="typeFilter">
                <option value="all">All</option>
            </select>
        </div>
        <div class="control-row">
            <label>Rating</label>
            <select id="ratingFilter">
                <option value="all">All</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
            </select>
        </div>
        <div class="control-row">
            <label><input type="checkbox" id="showNull" checked> Show null</label>
        </div>
        <div class="control-row">
            <label><input type="checkbox" id="showLabels" checked> Show labels</label>
        </div>
        <div class="legend" id="legendContainer">
            <div class="legend-title">Edge Types</div>
        </div>
    </div>
    <div class="stats">
        <span>Edges: <strong id="statEdges">0</strong></span>
        <span>Nodes: <strong id="statNodes">0</strong></span>
        <span>A: <strong id="statA">0</strong></span>
        <span>B: <strong id="statB">0</strong></span>
        <span>C: <strong id="statC">0</strong></span>
        <span>Issues: <strong id="statIssues">0</strong></span>
    </div>
    <div class="pitfall-sidebar" id="pitfallSidebar">
        <div class="pitfall-header">
            <h2>Open Issues</h2>
            <div class="pitfall-progress">
                <div class="pitfall-progress-bar"><div class="pitfall-progress-fill" id="pitfallProgressFill"></div></div>
                <div class="pitfall-progress-label" id="pitfallProgressLabel">0 / 0 resolved</div>
            </div>
        </div>
        <div id="pitfallList"></div>
        <div class="pitfall-footer">
            <label>Analyst ID</label>
            <input type="text" id="analystId" placeholder="Your name or initials">
            <button class="btn-export" id="exportBtn">Export Decisions</button>
        </div>
    </div>
    <div class="tooltip" id="tooltip"></div>

    <script>
// ── INJECTED DATA ────────────────────────────────────────────────────────
const NODES = [
  {
    "id": "oil_supply_shock",
    "label": "Oil supply shock",
    "description": "Baumeister oil supply shock (exogenous to Kazakhstan).",
    "unit": "sd",
    "frequency": "monthly",
    "observed": true,
    "latent": false
  },
  {
    "id": "oil_demand_shock",
    "label": "Oil demand shock",
    "description": "Baumeister oil demand shock (global demand-driven).",
    "unit": "sd",
    "frequency": "monthly",
    "observed": true,
    "latent": false
  },
  {
    "id": "global_activity_shock",
    "label": "Global activity innovation",
    "description": "Innovation in global activity index (IGREA).",
    "unit": "innovation",
    "frequency": "monthly",
    "observed": true,
    "latent": false
  },
  {
    "id": "vix_shock",
    "label": "VIX shock",
    "description": "Innovation in VIX (risk aversion shock).",
    "unit": "innovation",
    "frequency": "daily",
    "observed": true,
    "latent": false
  },
  {
    "id": "kzt_usd",
    "label": "KZT/USD exchange rate",
    "description": "Kazakh tenge per US dollar, log level.",
    "unit": "log",
    "frequency": "daily",
    "observed": true,
    "latent": false
  },
  {
    "id": "brent_price",
    "label": "Brent crude oil price",
    "description": "Brent spot price, USD per barrel, log level.",
    "unit": "log",
    "frequency": "daily",
    "observed": true,
    "latent": false
  },
  {
    "id": "nbk_policy_rate",
    "label": "NBK base rate",
    "description": "National Bank of Kazakhstan policy rate.",
    "unit": "pct",
    "frequency": "event",
    "observed": true,
    "latent": false
  },
  {
    "id": "cpi_headline",
    "label": "Headline CPI",
    "description": "Kazakhstan headline CPI index, log level.",
    "unit": "log",
    "frequency": "monthly",
    "observed": true,
    "latent": false
  },
  {
    "id": "cpi_tradable",
    "label": "Tradable CPI",
    "description": "CPI for tradable goods (import-weighted). Block A validated.",
    "unit": "log",
    "frequency": "monthly",
    "observed": true,
    "latent": false
  },
  {
    "id": "cpi_nontradable",
    "label": "Non-tradable CPI",
    "description": "CPI for non-tradable goods (services). Block A falsification.",
    "unit": "log",
    "frequency": "monthly",
    "observed": true,
    "latent": false
  },
  {
    "id": "imported_inflation_instrument",
    "label": "Imported inflation IV",
    "description": "Constructed instrument for imported inflation (FX change \u00d7 pre-period import share).",
    "unit": "pct",
    "frequency": "monthly",
    "observed": true,
    "latent": false
  },
  {
    "id": "E_import_share",
    "label": "Pre-period import share",
    "description": "Pre-period regional import intensity (static exposure).",
    "unit": "share",
    "frequency": "static",
    "observed": true,
    "latent": false
  },
  {
    "id": "nominal_income",
    "label": "Nominal monetary income",
    "description": "Regional household nominal monetary income. Block B validated.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "real_income",
    "label": "Real monetary income",
    "description": "Nominal income deflated by CPI. Identity node.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "wage_income",
    "label": "Wage income",
    "description": "Household income from wages and salaries.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "transfer_income",
    "label": "Transfer income",
    "description": "Household income from government transfers.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "nominal_expenditure",
    "label": "Nominal consumption expenditure",
    "description": "Household nominal consumption expenditure. Block F validated.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "real_expenditure",
    "label": "Real consumption expenditure",
    "description": "Nominal expenditure deflated by CPI. Block F validated.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "npl_aggregate",
    "label": "Aggregate NPL ratio",
    "description": "Banking sector NPL ratio from NBK.",
    "unit": "pct",
    "frequency": "monthly",
    "observed": true,
    "latent": false
  },
  {
    "id": "npl_kspi",
    "label": "KSPI NPL ratio",
    "description": "Kaspi.kz non-performing loan ratio.",
    "unit": "pct",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "cor_kspi",
    "label": "KSPI cost of risk",
    "description": "Kaspi.kz cost of risk (annualized provisions / avg loans).",
    "unit": "pct",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "loan_portfolio_kspi",
    "label": "KSPI net loan portfolio",
    "description": "Kaspi.kz net loan portfolio level (bn KZT).",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "portfolio_mix_kspi",
    "label": "KSPI portfolio mix",
    "description": "Shares by product type (BNPL, car loans, merchant).",
    "unit": "share",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "deposits_kspi",
    "label": "KSPI deposits",
    "description": "Kaspi.kz total deposits (bn KZT).",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "deposit_cost_kspi",
    "label": "KSPI deposit cost",
    "description": "Kaspi.kz average deposit rate.",
    "unit": "pct",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "rwa_kspi",
    "label": "KSPI risk-weighted assets",
    "description": "Kaspi.kz risk-weighted assets for regulatory capital.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "ppop_kspi",
    "label": "KSPI pre-provision operating profit",
    "description": "Kaspi.kz PPOP (revenue - opex, before provisions).",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "total_capital_kspi",
    "label": "KSPI total capital",
    "description": "Kaspi.kz total regulatory capital (Tier 1 + Tier 2).",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "k2_ratio_kspi",
    "label": "KSPI K2 capital ratio",
    "description": "Kaspi.kz K2 capital adequacy ratio (Total Capital / RWA).",
    "unit": "pct",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "payments_revenue_kspi",
    "label": "KSPI Payments revenue",
    "description": "Kaspi.kz payments segment revenue.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "marketplace_revenue_kspi",
    "label": "KSPI Marketplace revenue",
    "description": "Kaspi.kz marketplace segment revenue.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  },
  {
    "id": "fintech_revenue_kspi",
    "label": "KSPI Fintech revenue",
    "description": "Kaspi.kz fintech (lending) segment revenue.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false
  }
];
const EDGES = [
  {
    "id": "oil_supply_to_brent",
    "source": "oil_supply_shock",
    "target": "brent_price",
    "edge_type": "causal",
    "expected_sign": "negative",
    "interpretation": "Oil price response to supply shock",
    "notes": "Exogenous supply shock identification from Baumeister.",
    "point": -0.05166562593634781,
    "se": 0.005406555751311881,
    "pvalue": 1.2226952161375292e-21,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.97,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Design LOCAL_PROJECTIONS provides REDUCED_FORM level only",
    "n_obs": 306,
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:oil_supply_to_brent",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0000 but claim_level=. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "oil_supply_to_fx",
    "source": "oil_supply_shock",
    "target": "kzt_usd",
    "edge_type": "causal",
    "expected_sign": "positive",
    "interpretation": "KZT response to oil supply shock",
    "notes": "Oil exporter commodity currency dynamics.",
    "point": 0.00044787194670315805,
    "se": 0.1276521731480084,
    "pvalue": 0.9972006009022166,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.97,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Counterfactual Use: BLOCKED\nReason: regime break risk\n\nEven if p<0.05, this does not establish a causal effect.",
    "n_obs": 187,
    "issues": [
      {
        "issue_key": "RATING_DIAGNOSTICS_CONFLICT:oil_supply_to_fx",
        "rule_id": "RATING_DIAGNOSTICS_CONFLICT",
        "severity": "HIGH",
        "message": "A-rating despite failed diagnostics."
      }
    ],
    "has_critical_issue": false
  },
  {
    "id": "oil_demand_to_fx",
    "source": "oil_demand_shock",
    "target": "kzt_usd",
    "edge_type": "causal",
    "expected_sign": "negative",
    "interpretation": "KZT response to oil demand shock",
    "notes": "Commodity currency responds to global demand.",
    "point": -0.29825697639309134,
    "se": 0.16108393436726334,
    "pvalue": 0.06408866840834736,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.97,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Counterfactual Use: BLOCKED\nReason: regime break risk\n\nEven if p<0.05, this does not establish a causal effect.",
    "n_obs": 187,
    "issues": [
      {
        "issue_key": "RATING_DIAGNOSTICS_CONFLICT:oil_demand_to_fx",
        "rule_id": "RATING_DIAGNOSTICS_CONFLICT",
        "severity": "HIGH",
        "message": "A-rating despite failed diagnostics."
      }
    ],
    "has_critical_issue": false
  },
  {
    "id": "vix_to_fx",
    "source": "vix_shock",
    "target": "kzt_usd",
    "edge_type": "causal",
    "expected_sign": "positive",
    "interpretation": "KZT response to global risk aversion",
    "notes": "EM risk-off channel.",
    "point": -0.032423327653582856,
    "se": 0.10994554441748393,
    "pvalue": 0.768067585702398,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.8900000000000001,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": false
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Design LOCAL_PROJECTIONS provides REDUCED_FORM level only",
    "n_obs": 190,
    "issues": [
      {
        "issue_key": "RATING_DIAGNOSTICS_CONFLICT:vix_to_fx",
        "rule_id": "RATING_DIAGNOSTICS_CONFLICT",
        "severity": "HIGH",
        "message": "A-rating despite failed diagnostics."
      }
    ],
    "has_critical_issue": false
  },
  {
    "id": "fx_to_cpi_tradable",
    "source": "kzt_usd",
    "target": "cpi_tradable",
    "edge_type": "immutable",
    "expected_sign": "positive",
    "interpretation": "Differential inflation response by import intensity",
    "notes": "Block A validated result: 11.3% FX pass-through to tradable CPI.",
    "point": 0.113,
    "se": 0.028,
    "pvalue": 0.0001,
    "design": "IMMUTABLE_EVIDENCE",
    "rating": "A",
    "score": 0.99,
    "claim_level": "IDENTIFIED_CAUSAL",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "validated_evidence",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "low",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": true,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "REDUCED_FORM mode does not allow policy interventions",
    "n_obs": 1200,
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:fx_to_cpi_tradable",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0001 but claim_level=. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "fx_to_cpi_nontradable",
    "source": "kzt_usd",
    "target": "cpi_nontradable",
    "edge_type": "immutable",
    "expected_sign": "any",
    "interpretation": "Falsification test for FX pass-through",
    "notes": "Block A falsification: Near-zero pass-through to non-tradable CPI.",
    "point": 0.0,
    "se": 0.015,
    "pvalue": 0.99,
    "design": "IMMUTABLE_EVIDENCE",
    "rating": "A",
    "score": 0.99,
    "claim_level": "IDENTIFIED_CAUSAL",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "validated_evidence",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "low",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": true,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "REDUCED_FORM mode does not allow policy interventions",
    "n_obs": 1200,
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "cpi_to_nbk_rate",
    "source": "cpi_headline",
    "target": "nbk_policy_rate",
    "edge_type": "reaction_function",
    "expected_sign": "positive",
    "interpretation": "NBK reaction function to inflation",
    "notes": "NBK responds to inflation. Requires nbk_policy_rate connector.",
    "point": -0.5352595428653101,
    "se": 13.96562608868574,
    "pvalue": 0.9694270212706624,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.8240000000000001,
    "claim_level": "BLOCKED_ID",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": false
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Claim level capped to BLOCKED_ID",
    "n_obs": 67,
    "issues": [
      {
        "issue_key": "RATING_DIAGNOSTICS_CONFLICT:cpi_to_nbk_rate",
        "rule_id": "RATING_DIAGNOSTICS_CONFLICT",
        "severity": "HIGH",
        "message": "A-rating despite failed diagnostics."
      }
    ],
    "has_critical_issue": false
  },
  {
    "id": "fx_to_nbk_rate",
    "source": "kzt_usd",
    "target": "nbk_policy_rate",
    "edge_type": "reaction_function",
    "expected_sign": "positive",
    "interpretation": "NBK reaction function to FX depreciation",
    "notes": "NBK responds to FX conditions. Requires nbk_policy_rate connector.",
    "point": 0.018354935930909422,
    "se": 1.1164573166093024,
    "pvalue": 0.9868830988186311,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.904,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Counterfactual Use: BLOCKED\nReason: regime break risk\n\nEven if p<0.05, this does not establish a causal effect.",
    "n_obs": 67,
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "nbk_rate_to_deposit_cost",
    "source": "nbk_policy_rate",
    "target": "deposit_cost_kspi",
    "edge_type": "causal",
    "expected_sign": "positive",
    "interpretation": "Association between policy rate and KSPI funding cost",
    "notes": "Funding cost channel. Requires both connectors.",
    "point": 0.22265648578368194,
    "se": 0.06178252515647664,
    "pvalue": 0.00031350811161777947,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.73,
    "claim_level": "BLOCKED_ID",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": false
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Claim level capped to BLOCKED_ID",
    "n_obs": 18,
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:nbk_rate_to_deposit_cost",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0003 but claim_level=. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "nbk_rate_to_cor",
    "source": "nbk_policy_rate",
    "target": "cor_kspi",
    "edge_type": "causal",
    "expected_sign": "positive",
    "interpretation": "Association between policy rate and KSPI credit losses",
    "notes": "Borrower stress channel. Lagged 2Q for credit deterioration.",
    "point": 0.3559558353990485,
    "se": 0.11934467793177896,
    "pvalue": 0.002858237880200499,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.79,
    "claim_level": "BLOCKED_ID",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Claim level capped to BLOCKED_ID",
    "n_obs": 18,
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:nbk_rate_to_cor",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0029 but claim_level=. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "cpi_to_nominal_income",
    "source": "cpi_headline",
    "target": "nominal_income",
    "edge_type": "immutable",
    "expected_sign": "positive",
    "interpretation": "Nominal income response to external inflation (IV)",
    "notes": "Block B validated: LP-IV estimate using imported inflation IV.",
    "point": 0.65,
    "se": 0.18,
    "pvalue": 0.0003,
    "design": "IMMUTABLE_EVIDENCE",
    "rating": "A",
    "score": 0.99,
    "claim_level": "IDENTIFIED_CAUSAL",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "validated_evidence",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "low",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": true,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "REDUCED_FORM mode does not allow policy interventions",
    "n_obs": 80,
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:cpi_to_nominal_income",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0003 but claim_level=. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "fx_to_real_expenditure",
    "source": "kzt_usd",
    "target": "real_expenditure",
    "edge_type": "immutable",
    "expected_sign": "negative",
    "interpretation": "MPC-like ratio to FX shocks",
    "notes": "Block F validated: IRF(0) = -0.10 for real expenditure.",
    "point": -0.1,
    "se": 0.04,
    "pvalue": 0.012,
    "design": "IMMUTABLE_EVIDENCE",
    "rating": "A",
    "score": 0.99,
    "claim_level": "IDENTIFIED_CAUSAL",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "validated_evidence",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "low",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": true,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "REDUCED_FORM mode does not allow policy interventions",
    "n_obs": 60,
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:fx_to_real_expenditure",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0120 but claim_level=. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "shock_to_npl_kspi",
    "source": "imported_inflation_instrument",
    "target": "npl_kspi",
    "edge_type": "causal",
    "expected_sign": "positive",
    "interpretation": "Aggregate NPL response to imported inflation shock",
    "notes": "Reduced-form NPL response. Cannot decompose channels without loan-level data.",
    "point": 72.79719737828836,
    "se": 10.297353981285937,
    "pvalue": 1.5548712171304386e-12,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.79,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Design LOCAL_PROJECTIONS provides REDUCED_FORM level only",
    "n_obs": 26,
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_npl_kspi",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0000 but claim_level=. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "shock_to_cor_kspi",
    "source": "imported_inflation_instrument",
    "target": "cor_kspi",
    "edge_type": "causal",
    "expected_sign": "positive",
    "interpretation": "Total provisioning response to imported inflation shock",
    "notes": "Reduced-form CoR response. IFRS 9 overlay is latent.",
    "point": 85.95725782265163,
    "se": 7.40220359386492,
    "pvalue": 3.565189467439174e-31,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.79,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Design LOCAL_PROJECTIONS provides REDUCED_FORM level only",
    "n_obs": 26,
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_cor_kspi",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0000 but claim_level=. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "expenditure_to_payments_revenue",
    "source": "real_expenditure",
    "target": "payments_revenue_kspi",
    "edge_type": "causal",
    "expected_sign": "positive",
    "interpretation": "Association between spending and KSPI payments revenue",
    "notes": "Spending -&gt; GMV -&gt; Interchange -&gt; Revenue. Requires KSPI connector.",
    "point": 333.40898842797117,
    "se": 70.95395662999425,
    "pvalue": 2.615043739933785e-06,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.6923529411764707,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Counterfactual Use: BLOCKED\nReason: insufficient shock episodes\n\nEven if p<0.05, this does not establish a causal effect.",
    "n_obs": 7,
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:expenditure_to_payments_revenue",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0000 but claim_level=. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "cor_to_capital",
    "source": "cor_kspi",
    "target": "total_capital_kspi",
    "edge_type": "mechanical",
    "expected_sign": "negative",
    "interpretation": "Capital impact from provisioning",
    "notes": "Provisioning reduces capital. Control for PPOP.",
    "point": -22.4,
    "se": 0.0,
    "pvalue": null,
    "design": "ACCOUNTING_BRIDGE",
    "rating": "A",
    "score": 0.9299999999999999,
    "claim_level": "IDENTIFIED_CAUSAL",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "identity_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "mechanical_identity_risk"
    ],
    "id_risks": {
      "unmeasured_confounding": "low",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": true,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "REDUCED_FORM mode does not allow policy interventions",
    "n_obs": null,
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:cor_to_capital",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0000 but claim_level=BLOCKED_ID. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "loan_portfolio_to_rwa",
    "source": "loan_portfolio_kspi",
    "target": "rwa_kspi",
    "edge_type": "mechanical",
    "expected_sign": "positive",
    "interpretation": "Mechanical volume effect on RWA",
    "notes": "Volume \u00d7 avg RW. Mechanical relationship.",
    "point": 0.5714285714285714,
    "se": 0.0,
    "pvalue": null,
    "design": "ACCOUNTING_BRIDGE",
    "rating": "A",
    "score": 0.9299999999999999,
    "claim_level": "IDENTIFIED_CAUSAL",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "identity_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "mechanical_identity_risk"
    ],
    "id_risks": {
      "unmeasured_confounding": "low",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": true,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "REDUCED_FORM mode does not allow policy interventions",
    "n_obs": null,
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:loan_portfolio_to_rwa",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0000 but claim_level=REDUCED_FORM. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "portfolio_mix_to_rwa",
    "source": "portfolio_mix_kspi",
    "target": "rwa_kspi",
    "edge_type": "causal",
    "expected_sign": "any",
    "interpretation": "RWA composition effect from product mix shifts",
    "notes": "Product mix shifts risk weights. NBK uses 150%+ for unsecured.",
    "point": 18195.962971994624,
    "se": 3952.75417946752,
    "pvalue": 4.157223824460209e-06,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.7982352941176472,
    "claim_level": "BLOCKED_ID",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Claim level capped to BLOCKED_ID",
    "n_obs": 16,
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:portfolio_mix_to_rwa",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0000 but claim_level=. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "capital_to_k2",
    "source": "total_capital_kspi",
    "target": "k2_ratio_kspi",
    "edge_type": "identity",
    "expected_sign": "",
    "interpretation": "K2 identity: Capital / RWA",
    "notes": "K2 = Total Capital / RWA. Mechanical identity.",
    "point": 0.0625,
    "se": 0.0,
    "pvalue": null,
    "design": "IDENTITY",
    "rating": "A",
    "score": 0.94,
    "claim_level": "IDENTIFIED_CAUSAL",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "identity_check",
        "passed": true
      }
    ],
    "failure_flags": [
      "mechanical_identity_risk"
    ],
    "id_risks": {
      "unmeasured_confounding": "low",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": true,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "REDUCED_FORM mode does not allow policy interventions",
    "n_obs": null,
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "rwa_to_k2",
    "source": "rwa_kspi",
    "target": "k2_ratio_kspi",
    "edge_type": "identity",
    "expected_sign": "",
    "interpretation": "K2 identity: Capital / RWA",
    "notes": "K2 = Total Capital / RWA. Mechanical identity.",
    "point": -0.010125,
    "se": 0.0,
    "pvalue": null,
    "design": "IDENTITY",
    "rating": "A",
    "score": 0.94,
    "claim_level": "IDENTIFIED_CAUSAL",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "identity_check",
        "passed": true
      }
    ],
    "failure_flags": [
      "mechanical_identity_risk"
    ],
    "id_risks": {
      "unmeasured_confounding": "low",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": true,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "REDUCED_FORM mode does not allow policy interventions",
    "n_obs": null,
    "issues": [],
    "has_critical_issue": false
  }
];
const LATENTS = [
  {
    "id": "ifrs9_overlay",
    "description": "Forward-looking macro overlay in IFRS 9 ECL provisioning.",
    "affects": [
      "cor_kspi"
    ]
  },
  {
    "id": "regulatory_changes",
    "description": "NBK RW rule changes affecting unsecured consumer loans.",
    "affects": [
      "rwa_kspi"
    ]
  },
  {
    "id": "kspi_customer_composition",
    "description": "Unobserved changes in KSPI customer risk profile.",
    "affects": [
      "npl_kspi",
      "cor_kspi"
    ]
  },
  {
    "id": "migration",
    "description": "Labor migration affecting regional income dynamics.",
    "affects": [
      "nominal_income",
      "real_income"
    ]
  },
  {
    "id": "fiscal_policy",
    "description": "Unobserved fiscal policy responses to shocks.",
    "affects": [
      "transfer_income",
      "nominal_income"
    ]
  }
];
const METADATA = {
  "name": "kspi_k2_stress",
  "description": "Global shocks -> KZ macro -> KSPI balance sheet -> K2 capital ratio",
  "target_node": "k2_ratio_kspi",
  "created": "2026-02-02",
  "owner": "research_team",
  "scope_default": "kazakhstan_only",
  "tags": [
    "kspi",
    "capital",
    "stress_test",
    "k2"
  ]
};
const EDGE_TYPE_COLORS = {"causal": "#2563eb", "reaction_function": "#059669", "bridge": "#9333ea", "identity": "#9333ea", "mechanical": "#9333ea", "immutable": "#d97706"};
const EDGE_TYPE_LABELS = {"causal": "Causal", "reaction_function": "Reaction Function", "bridge": "Accounting Bridge", "identity": "Identity", "mechanical": "Mechanical", "immutable": "Immutable (Validated)"};
const RULE_DESCRIPTIONS = {
  "ENTITY_BOUNDARY_DRIFT": {
    "description": "Mixing entity scopes (bank vs group) breaks comparability",
    "explanation": "When different observations mix entity scopes (e.g., bank-level vs consolidated group-level), the treatment and outcome variables become incomparable across units. Capital ratios at bank level differ systematically from group level due to intra-group transfers and double counting. Ignoring this produces biased panel estimates because the variation being exploited is partly definitional, not economic.\n",
    "guidance": "Harmonize all observations to the same scope (preferably unconsolidated bank-level for Kazakhstan data). If harmonization is impossible, add a scope dummy and note the caveat in the report.\n"
  },
  "KPI_DEFINITION_MISMATCH_CROSS_BANK": {
    "description": "NPL/CoR definitions differ across banks causing sign conflicts",
    "explanation": "Banks may use different definitions for key performance indicators (e.g., NPL includes/excludes restructured loans, CoR uses different provisioning rules). Cross-bank panel estimation treats these as comparable, but definitional differences create measurement error correlated with bank characteristics. This can flip coefficient signs between runs and invalidate pooled estimates.\n",
    "guidance": "Check if the definition mismatch is economically meaningful. If yes, harmonize definitions or estimate separately by definition group. Document any remaining heterogeneity as a limitation.\n"
  },
  "SHOCK_CONSTRUCT_AMBIGUOUS": {
    "description": "EdgeCard must include shock_node_id, shock_unit, shock_scale",
    "explanation": "Without explicit shock metadata (which node is shocked, in what units, at what scale), counterfactual scenarios become ambiguous. A &quot;10% depreciation&quot; could mean 10 percentage points or 10% of the current level, leading to order-of-magnitude errors in propagation. This metadata is required for reproducible counterfactuals.\n",
    "guidance": "The system will auto-populate shock metadata from the DAG spec. Verify that the inferred shock_unit and shock_scale match your intended scenario.\n"
  },
  "FREQUENCY_ALIGNMENT_ERROR": {
    "description": "Mixing frequencies without explicit aggregation rule",
    "explanation": "Mixing monthly treatment with quarterly outcome (or vice versa) without a declared aggregation method (end-of-period, average, sum) introduces temporal misalignment. The estimator may silently interpolate or drop observations, changing the effective sample and potentially biasing results. This is auto-fixable but must be logged.\n",
    "guidance": "The system will apply the aggregation rule from the DAG spec. If no rule is specified, it defaults to end-of-period for stocks and average for flows.\n"
  },
  "FREQUENCY_SCALING_MISMATCH": {
    "description": "Annual vs quarterly estimates not normalized to common unit",
    "explanation": "When comparing estimates across runs with different frequencies, a quarterly coefficient is not directly comparable to an annual one. Failing to normalize (e.g., annualize quarterly or quarterly-ize annual) leads to incorrect propagation multipliers and misleading cross-run convergence assessments.\n",
    "guidance": "Normalize all estimates to a common time unit before comparison. The preferred convention is quarterly for macro variables and annual for structural parameters.\n"
  },
  "EXTRACTION_PROVENANCE_GAPS": {
    "description": "Missing source document/page reference for extracted data",
    "explanation": "Data extracted from PDFs, reports, or regulatory filings should carry provenance (source document, page, table number) so that results can be independently verified. Missing provenance makes reproduction impossible and raises audit risk, especially for regulatory submissions.\n",
    "guidance": "Add the source reference to the data extraction metadata. For low-risk variables (e.g., public market data), this can be accepted with a note.\n"
  },
  "REACTION_FUNCTION_EDGE": {
    "description": "Policy reaction edge cannot be used for shock propagation",
    "explanation": "A policy reaction function (e.g., central bank raises rates in response to inflation) captures endogenous behavior, not a causal effect of an exogenous shock. Using it for shock propagation would double-count the policy response or create circular logic. The edge should be classified as diagnostic or informational only.\n",
    "guidance": "Reclassify as diagnostic-only if this is purely a reaction function. If you believe there is an exogenous component, document the identification strategy and accept with a caveat.\n"
  },
  "TIME_FE_ABSORBS_SHOCK": {
    "description": "Panel with time FE and common shock requires Exposure x Shock",
    "explanation": "Time fixed effects absorb all common time-varying shocks (including the treatment of interest if it is a macro shock common to all units). To identify the effect, the design must exploit cross-sectional variation in exposure (Exposure x Shock interaction). Without this, the coefficient is mechanically zero or identified only from noise.\n",
    "guidance": "The system will suggest adding an Exposure x Shock interaction term. This is the standard diff-in-diff approach for common shocks in panel data.\n"
  },
  "EXPOSURE_NOT_PREDETERMINED": {
    "description": "Exposure variable must be measured strictly pre-treatment",
    "explanation": "If the exposure variable (e.g., bank&#x27;s FX share) is measured contemporaneously with or after the shock, it may itself be affected by the shock, creating a &quot;bad controls&quot; problem. This violates the exclusion restriction in diff-in-diff designs and biases the estimated causal effect, typically attenuating it toward zero.\n",
    "guidance": "Lag the exposure variable to a pre-treatment period. If pre-treatment measurement is unavailable, accept with a caveat noting potential attenuation bias.\n"
  },
  "MECHANICAL_EDGE_ESTIMATED": {
    "description": "Accounting identity should be bridge, not regression",
    "explanation": "Regressing an identity (e.g., CAR = Capital / RWA) produces tautological results with near-perfect fit, inflating credibility scores and wasting estimation budget. Mechanical edges should be treated as deterministic bridges that pass through shocks via calculus (partial derivatives), not statistical estimation.\n",
    "guidance": "The system will convert this to a bridge edge with deterministic sensitivity. Accept as regression only if you need to test whether the identity holds empirically.\n"
  },
  "PATH_DOUBLE_COUNTING": {
    "description": "Direct reduced-form + indirect chain both used for propagation",
    "explanation": "If both a direct reduced-form edge (A -&gt; C) and a structural chain (A -&gt; B -&gt; C) are included in propagation, the total effect is double-counted. This inflates counterfactual predictions, potentially by 100% or more. The system detects overlapping paths and requires the analyst to choose one.\n",
    "guidance": "Prefer the structural chain if all intermediate edges are IDENTIFIED_CAUSAL, as it provides more granular policy levers. Use reduced-form if intermediate edges are weak or if you only need the total effect.\n"
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED": {
    "description": "Significant result but claim_level != IDENTIFIED_CAUSAL",
    "explanation": "This edge shows a statistically significant result (low p-value), but the identification strategy has not been validated as causal. A significant correlation is not the same as a causal effect \u2014 without proper identification (e.g., IV, RDD, DiD), the estimate may reflect reverse causation, omitted variable bias, or spurious correlation. Accepting this as causal without acknowledgement constitutes overclaiming.\n",
    "guidance": "If you have a credible identification strategy, upgrade to IDENTIFIED_CAUSAL and document it. Otherwise, accept as REDUCED_FORM \u2014 informative but not usable for counterfactual predictions without caveats.\n"
  },
  "SMALL_SAMPLE_INFERENCE": {
    "description": "N &lt; 30 with HAC SEs; inference fragile",
    "explanation": "With fewer than 30 observations, HAC (Newey-West) standard errors rely on asymptotic approximations that perform poorly in small samples. Confidence intervals may be too narrow, leading to false rejections of the null. The credibility rating is capped to reflect this uncertainty.\n",
    "guidance": "Consider wild bootstrap for more reliable small-sample inference. The rating cap to B is automatic; override only if you have strong justification for asymptotic validity.\n"
  },
  "PANEL_TOO_FEW_UNITS": {
    "description": "&lt; 5 units; cluster-robust unreliable",
    "explanation": "Cluster-robust standard errors require a sufficient number of clusters (units) to be reliable. With fewer than 5 units, the cluster-robust variance estimator is severely biased downward, leading to over-rejection. This is a well-known problem in the panel econometrics literature (Cameron, Gelbach, Miller 2008).\n",
    "guidance": "Use wild cluster bootstrap (Webb weights) for valid inference with few clusters. The rating cap to B is automatic. Accept with caveat if bootstrap is infeasible.\n"
  },
  "LOO_INSTABILITY": {
    "description": "Leave-one-out shows sign flip or &gt;50% magnitude change",
    "explanation": "Leave-one-out (LOO) analysis drops each unit in turn and re-estimates. If the coefficient flips sign or changes magnitude by more than 50%, the result is driven by a single influential unit rather than a systematic pattern. Such fragility undermines confidence in the estimate as a general causal effect.\n",
    "guidance": "Identify the influential unit and investigate whether it is an outlier or represents a genuine subgroup effect. Consider winsorizing, trimming, or reporting results with and without the influential unit.\n"
  },
  "BREAKS_UNMODELED": {
    "description": "Regime changes not accounted for in estimation",
    "explanation": "Structural breaks (e.g., policy changes, crises) can cause coefficient instability. If breaks are present but not modeled, the estimated coefficient is a weighted average across regimes, which may not represent either regime accurately. This is especially problematic for counterfactual scenarios that project beyond a break date.\n",
    "guidance": "Add a regime dummy or split the sample at the break date. If the break is recent and data post-break is insufficient, restrict counterfactual scope to the pre-break regime.\n"
  },
  "MULTIPLE_TESTING_DRIFT": {
    "description": "Spec search exceeded pre-registered budget",
    "explanation": "Running many specifications and reporting only the significant one inflates the false discovery rate. The pre-registered specification budget limits this. If the budget is exceeded, the analyst must either apply a multiple testing correction (e.g., Bonferroni) or justify the additional specifications as pre-planned robustness checks.\n",
    "guidance": "Apply Bonferroni correction to the p-values if the budget was exceeded due to exploratory analysis. If the additional specs were planned robustness checks, document them and reset the budget.\n"
  },
  "NONSTATIONARY_LEVELS_RISK": {
    "description": "Both variables in levels and trending; require transformation or ECM",
    "explanation": "Regressing two trending (non-stationary) variables in levels produces spurious regression \u2014 high R-squared and significant t-statistics that reflect shared trends, not causal relationships. The solution is to first-difference, use an ECM if cointegrated, or apply appropriate transformations (log-differences for growth rates).\n",
    "guidance": "The system will apply first-differencing by default. If you believe the variables are cointegrated, select ECM specification to preserve the long-run relationship.\n"
  },
  "RESIDUAL_AUTOCORR_DETECTED": {
    "description": "Serial correlation in residuals; HAC SEs may be inadequate",
    "explanation": "Serial correlation in residuals indicates that the model is missing dynamic structure. While HAC standard errors adjust for this, they may be inadequate if the autocorrelation is strong or persistent, leading to under-estimated standard errors and over-rejection.\n",
    "guidance": "Consider increasing the HAC bandwidth or adding lagged dependent variables. If autocorrelation is mild (DW close to 2), accept with a caveat.\n"
  },
  "REGIME_BREAK_SUSPECTED": {
    "description": "Coefficient instability across regime splits",
    "explanation": "TSGuard detected statistically significant coefficient differences across time sub-samples, suggesting a structural break. Using a single coefficient for the full sample masks regime-specific effects and produces unreliable counterfactuals for periods after the break.\n",
    "guidance": "Split the sample at the detected break date and estimate separately. If the break is too recent for reliable post-break estimation, restrict counterfactual scope to the pre-break regime.\n"
  },
  "LEADS_SIGNIFICANT_TIMING_FAIL": {
    "description": "Effects appear before shock; reverse causation or omitted factor",
    "explanation": "If the outcome responds significantly BEFORE the treatment shock, the causal interpretation fails. This indicates either reverse causation (outcome causes treatment), an omitted common factor driving both, or anticipation effects that violate the parallel trends assumption. The edge is blocked from propagation automatically.\n",
    "guidance": "Investigate whether leads reflect anticipation (expected policy changes) or reverse causation. If anticipation, consider adjusting the shock timing. If reverse causation, reclassify the edge direction or remove from the DAG.\n"
  },
  "HAC_LAG_SENSITIVITY_HIGH": {
    "description": "Estimate changes materially with HAC lag length",
    "explanation": "If the point estimate or its significance changes substantially when varying the HAC bandwidth (number of lags in the Newey-West kernel), the inference is fragile to the choice of bandwidth. This suggests that the serial correlation structure is complex and the standard errors are not robust to bandwidth selection.\n",
    "guidance": "Report results across multiple bandwidths. Use a data-driven bandwidth selector (e.g., Andrews 1991) rather than ad hoc choice. Accept with caveat if the sign is stable across bandwidths.\n"
  },
  "SELECTION_PUBLIC_BANK_ONLY": {
    "description": "Panel uses only public banks; results may not generalize to full banking sector",
    "explanation": "Public (listed) banks differ systematically from private banks in size, governance, risk appetite, and regulatory scrutiny. Estimates from public-only samples may not generalize to the full banking sector. Counterfactuals applied to the full sector using these estimates would be unreliable for the private bank segment.\n",
    "guidance": "Add a disclaimer noting the sample restriction. Cap the counterfactual scope to public banks only, or accept with a clear caveat about external validity limitations.\n"
  },
  "SURVIVORSHIP_BIAS_RISK": {
    "description": "Sample excludes failed/merged banks; survival conditioning biases estimates",
    "explanation": "If banks that failed, merged, or exited the sample are excluded, the remaining sample is conditioned on survival. This creates survivorship bias \u2014 the estimated effects reflect only the experience of survivors, typically underestimating the negative effects of shocks (since the most affected banks disappeared).\n",
    "guidance": "Run a sensitivity check including failed/merged banks up to their last observation. Add a disclaimer about survivorship bias. If data on exits is unavailable, accept with a clear caveat.\n"
  },
  "COVERAGE_GAP_EXTERNAL_VALIDITY": {
    "description": "Sample covers &lt;50% of system assets or &lt;50% of institutions in target population",
    "explanation": "When the sample covers less than half of the target population (by assets or count), the estimated effects may not represent the system as a whole. Small or mid-sized banks excluded from the sample may have different exposure patterns and response mechanisms than the included banks.\n",
    "guidance": "Add a disclaimer noting the coverage gap. If the coverage gap is due to data availability, document which segments are missing and their likely direction of bias.\n"
  },
  "RATING_DIAGNOSTICS_CONFLICT": {
    "description": "A-rating despite failed diagnostics or missing requirements",
    "explanation": "An A-rating signals high credibility, but one or more diagnostics have failed or required checks are missing. This inconsistency undermines the rating system&#x27;s integrity. The system auto-downgrades to B to maintain consistency between the rating and the underlying evidence.\n",
    "guidance": "The auto-downgrade to B is applied. Override to A only if you can document why the failed diagnostic does not affect the estimate&#x27;s credibility for your specific use case.\n"
  },
  "N_REPORTING_INCONSISTENT": {
    "description": "Report N header != EdgeCard N_eff",
    "explanation": "The sample size reported in the system report header differs from the effective observations in the EdgeCard. This inconsistency confuses reviewers and may indicate a data processing error (e.g., missing values were dropped but not reflected in the header count).\n",
    "guidance": "The system will auto-fix by aligning the report N to the EdgeCard N_eff. Accept the auto-fix unless you have a specific reason for the discrepancy.\n"
  },
  "CROSS_EVIDENCE_CONFLICT": {
    "description": "Two edges measuring same relationship have conflicting signs",
    "explanation": "When two edges estimate the same causal relationship (e.g., one reduced-form and one structural) but produce opposite signs, at least one is biased or misspecified. Using both in propagation would produce contradictory counterfactuals. The analyst must adjudicate which estimate is more credible.\n",
    "guidance": "Prefer the structural edge if its identification strategy is stronger. If both designs are equally credible, report the conflict as a limitation and consider averaging with appropriate uncertainty.\n"
  },
  "UNIT_MISSING_IN_EDGECARD": {
    "description": "EdgeCard missing treatment_unit/outcome_unit",
    "explanation": "Without explicit units (e.g., &quot;pp&quot;, &quot;%&quot;, &quot;log points&quot;), the coefficient is uninterpretable. A coefficient of 0.5 could mean 0.5 percentage points, 50%, or 0.5 log points \u2014 a potential 100x difference in the implied effect. Units are required for any meaningful propagation or reporting.\n",
    "guidance": "The system will auto-populate units from the DAG spec. Verify that the inferred units match the actual estimation specification.\n"
  }
};
const ACTIONS_BY_RULE = {
  "SIGNIFICANT_BUT_NOT_IDENTIFIED": {
    "action_type": "set_claim_level",
    "options": [
      {
        "value": "IDENTIFIED_CAUSAL",
        "label": "IDENTIFIED_CAUSAL",
        "tooltip": "Asserts credible identification strategy (IV, RDD, DiD). Requires documentation. Unlocks counterfactual propagation at full weight."
      },
      {
        "value": "REDUCED_FORM",
        "label": "REDUCED_FORM",
        "tooltip": "Informative but not causally identified. Flagged in reports, excluded from causal counterfactuals. Useful for suggestive evidence."
      },
      {
        "value": "DESCRIPTIVE",
        "label": "DESCRIPTIVE",
        "tooltip": "Descriptive association only. No causal weight in propagation or counterfactuals. Kept for reporting and context."
      },
      {
        "value": "BLOCKED_ID",
        "label": "BLOCKED_ID",
        "tooltip": "Blocks identification claim entirely. Edge remains in DAG but cannot be used for propagation until resolved."
      }
    ]
  },
  "REACTION_FUNCTION_EDGE": {
    "action_type": "set_propagation",
    "options": [
      {
        "value": "RECLASSIFY_DIAGNOSTIC",
        "label": "Reclassify as diagnostic",
        "tooltip": "Moves edge to diagnostic-only role. It will appear in reports but not participate in shock propagation or counterfactuals."
      },
      {
        "value": "ACCEPT_WITH_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps edge in propagation but adds an explicit caveat about endogeneity to all downstream counterfactuals."
      },
      {
        "value": "BLOCK_PROPAGATION",
        "label": "Block from propagation",
        "tooltip": "Removes edge from all propagation paths. It remains visible in the DAG for documentation but has zero causal weight."
      }
    ]
  },
  "TIME_FE_ABSORBS_SHOCK": {
    "action_type": "set_design_fix",
    "options": [
      {
        "value": "ADD_INTERACTION",
        "label": "Add Exposure x Shock",
        "tooltip": "Adds cross-sectional exposure interaction to identify effects absorbed by time FE. Standard DiD approach for common macro shocks."
      },
      {
        "value": "DROP_TIME_FE",
        "label": "Drop time FE",
        "tooltip": "Removes time fixed effects to allow common shock identification. Risks confounding from other time-varying factors."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)",
        "tooltip": "Keeps current specification. Documents that the common shock effect is absorbed and the estimate captures only cross-sectional variation."
      }
    ]
  },
  "EXPOSURE_NOT_PREDETERMINED": {
    "action_type": "set_exposure_action",
    "options": [
      {
        "value": "LAG_EXPOSURE",
        "label": "Lag exposure variable",
        "tooltip": "Uses pre-treatment period exposure measurement to avoid bad controls bias. Recommended if pre-treatment data is available."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps contemporaneous exposure with a documented caveat about potential attenuation bias from endogenous exposure."
      },
      {
        "value": "BLOCK_ID",
        "label": "Block identification claim",
        "tooltip": "Downgrades identification to REDUCED_FORM. The edge cannot claim causal identification without predetermined exposure."
      }
    ]
  },
  "MECHANICAL_EDGE_ESTIMATED": {
    "action_type": "set_edge_type",
    "options": [
      {
        "value": "CONVERT_BRIDGE",
        "label": "Convert to bridge edge",
        "tooltip": "Replaces regression with deterministic sensitivity (partial derivative). Eliminates wasted estimation budget on tautological relationships."
      },
      {
        "value": "ACCEPT",
        "label": "Accept as regression",
        "tooltip": "Keeps the regression estimate. Useful if you want to empirically test whether the identity holds (e.g., detecting measurement error)."
      }
    ]
  },
  "PATH_DOUBLE_COUNTING": {
    "action_type": "set_path_choice",
    "options": [
      {
        "value": "USE_STRUCTURAL",
        "label": "Use structural chain",
        "tooltip": "Uses the full structural decomposition (A-&gt;B-&gt;C). Provides more granular policy levers but requires all intermediate edges to be credible."
      },
      {
        "value": "USE_REDUCED_FORM",
        "label": "Use reduced-form shortcut",
        "tooltip": "Uses the direct reduced-form edge (A-&gt;C). Simpler and more robust if intermediate edges are weak, but loses structural detail."
      },
      {
        "value": "ACCEPT_BOTH",
        "label": "Accept both (document)",
        "tooltip": "Keeps both paths with documentation. Only valid if paths measure different aspects (e.g., short-run vs long-run effects)."
      }
    ]
  },
  "ENTITY_BOUNDARY_DRIFT": {
    "action_type": "set_boundary_action",
    "options": [
      {
        "value": "HARMONIZE",
        "label": "Harmonize to common scope",
        "tooltip": "Converts all observations to the same entity scope (bank-level or group-level). May require data adjustments."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps mixed scopes with a documented caveat. Appropriate when scope differences are small or unavoidable."
      },
      {
        "value": "EXCLUDE_EDGE",
        "label": "Exclude edge",
        "tooltip": "Removes the edge from estimation entirely. Use when scope mixing makes the estimate unreliable."
      }
    ]
  },
  "KPI_DEFINITION_MISMATCH_CROSS_BANK": {
    "action_type": "set_kpi_action",
    "options": [
      {
        "value": "HARMONIZE",
        "label": "Harmonize definitions",
        "tooltip": "Adjusts data to use consistent definitions across banks. May require recalculation from raw components."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps heterogeneous definitions with documentation. Appropriate if differences are minor or well-understood."
      },
      {
        "value": "EXCLUDE_EDGE",
        "label": "Exclude edge",
        "tooltip": "Removes the edge. Use when definition differences are fundamental and cannot be reconciled."
      }
    ]
  },
  "SHOCK_CONSTRUCT_AMBIGUOUS": {
    "action_type": "set_shock_action",
    "options": [
      {
        "value": "ADD_METADATA",
        "label": "Add shock metadata",
        "tooltip": "Populates missing shock_node_id, shock_unit, and shock_scale from DAG spec. Required for counterfactual scenarios."
      },
      {
        "value": "ACCEPT",
        "label": "Accept as-is",
        "tooltip": "Keeps edge without shock metadata. Edge will not be usable in counterfactual scenarios."
      }
    ]
  },
  "FREQUENCY_ALIGNMENT_ERROR": {
    "action_type": "set_freq_action",
    "options": [
      {
        "value": "AGGREGATE_Q",
        "label": "Aggregate to quarterly",
        "tooltip": "Aggregates higher-frequency data to quarterly using the DAG-specified method (average for flows, end-of-period for stocks)."
      },
      {
        "value": "AGGREGATE_A",
        "label": "Aggregate to annual",
        "tooltip": "Aggregates to annual frequency. Loses short-run dynamics but may be necessary for data availability reasons."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)",
        "tooltip": "Keeps mixed frequencies with documentation. Only appropriate if the estimator handles mixed frequencies natively."
      }
    ]
  },
  "FREQUENCY_SCALING_MISMATCH": {
    "action_type": "set_scaling_action",
    "options": [
      {
        "value": "NORMALIZE",
        "label": "Normalize to common unit",
        "tooltip": "Rescales coefficients to a common time unit (quarterly convention). Ensures cross-run comparability."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps different time units with documentation. Cross-run comparisons will include unit conversion caveats."
      }
    ]
  },
  "EXTRACTION_PROVENANCE_GAPS": {
    "action_type": "set_provenance_action",
    "options": [
      {
        "value": "ADD_SOURCE",
        "label": "Add source reference",
        "tooltip": "Adds source document, page, and table reference to the data extraction metadata for audit trail."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (low risk)",
        "tooltip": "Accepts without provenance. Appropriate for public market data or well-known statistical series."
      }
    ]
  },
  "SMALL_SAMPLE_INFERENCE": {
    "action_type": "set_sample_action",
    "options": [
      {
        "value": "CAP_B",
        "label": "Cap rating to B",
        "tooltip": "Limits credibility rating to B, reflecting asymptotic approximation risk with N &lt; 30. Automatic default action."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps current rating with documented small-sample caveat. Only if you have justification for asymptotic validity."
      },
      {
        "value": "RE_ESTIMATE",
        "label": "Flag for re-estimation",
        "tooltip": "Queues re-estimation with wild bootstrap standard errors for more reliable small-sample inference."
      }
    ]
  },
  "PANEL_TOO_FEW_UNITS": {
    "action_type": "set_panel_action",
    "options": [
      {
        "value": "CAP_B",
        "label": "Cap rating to B",
        "tooltip": "Limits rating to B due to cluster-robust SE unreliability with &lt; 5 units. Automatic default action."
      },
      {
        "value": "WILD_BOOTSTRAP",
        "label": "Use wild cluster bootstrap",
        "tooltip": "Re-estimates with wild cluster bootstrap (Webb weights) for valid few-cluster inference. May widen confidence intervals."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps current estimate with documented caveat about few-cluster inference fragility."
      }
    ]
  },
  "LOO_INSTABILITY": {
    "action_type": "set_loo_action",
    "options": [
      {
        "value": "CAP_C",
        "label": "Cap rating to C",
        "tooltip": "Limits rating to C reflecting result fragility to single-unit exclusion. Signals low confidence in generalizability."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps current rating with documented LOO instability caveat. Identify the influential unit in the rationale."
      },
      {
        "value": "RE_ESTIMATE",
        "label": "Flag for re-estimation",
        "tooltip": "Queues re-estimation with the influential unit excluded or winsorized. Produces a robustness comparison."
      }
    ]
  },
  "BREAKS_UNMODELED": {
    "action_type": "set_breaks_action",
    "options": [
      {
        "value": "ADD_REGIME",
        "label": "Add regime dummy",
        "tooltip": "Adds a structural break dummy at the detected break date. Allows coefficient to differ across regimes."
      },
      {
        "value": "SPLIT_SAMPLE",
        "label": "Split sample estimation",
        "tooltip": "Estimates separately for each regime. Provides regime-specific coefficients for targeted counterfactuals."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps pooled estimate with caveat about coefficient averaging across regimes."
      }
    ]
  },
  "MULTIPLE_TESTING_DRIFT": {
    "action_type": "set_testing_action",
    "options": [
      {
        "value": "BONFERRONI",
        "label": "Apply Bonferroni correction",
        "tooltip": "Adjusts p-values for the number of specifications tested. Conservative but protects against false discoveries."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps unadjusted p-values with documentation of the specification search. Appropriate for pre-planned robustness."
      },
      {
        "value": "RESET_BUDGET",
        "label": "Reset spec budget",
        "tooltip": "Resets the specification budget counter. Use only if the additional specs were pre-planned and documented."
      }
    ]
  },
  "NONSTATIONARY_LEVELS_RISK": {
    "action_type": "set_stationarity_action",
    "options": [
      {
        "value": "DIFFERENCE",
        "label": "First-difference",
        "tooltip": "Applies first-differencing to both variables. Removes trends but loses long-run level information."
      },
      {
        "value": "ECM",
        "label": "Use ECM specification",
        "tooltip": "Uses Error Correction Model to preserve long-run relationship while modeling short-run dynamics. Requires cointegration."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)",
        "tooltip": "Keeps levels specification with documentation. Only valid if you have theoretical reasons for level relationships."
      }
    ]
  },
  "RESIDUAL_AUTOCORR_DETECTED": {
    "action_type": "set_autocorr_action",
    "options": [
      {
        "value": "INCREASE_HAC",
        "label": "Increase HAC bandwidth",
        "tooltip": "Increases Newey-West kernel bandwidth to better capture serial correlation. May widen standard errors."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps current HAC bandwidth with documented autocorrelation caveat. Appropriate for mild autocorrelation."
      }
    ]
  },
  "REGIME_BREAK_SUSPECTED": {
    "action_type": "set_regime_action",
    "options": [
      {
        "value": "ADD_BREAK",
        "label": "Add structural break",
        "tooltip": "Adds break dummy and interaction terms at the detected break date. Allows before/after comparison."
      },
      {
        "value": "SPLIT_SAMPLE",
        "label": "Split sample",
        "tooltip": "Estimates separately for pre-break and post-break periods. Provides regime-specific coefficients."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps pooled estimate with documented regime instability caveat."
      }
    ]
  },
  "LEADS_SIGNIFICANT_TIMING_FAIL": {
    "action_type": "set_timing_action",
    "options": [
      {
        "value": "BLOCK_PROPAGATION",
        "label": "Block from propagation",
        "tooltip": "Removes edge from all propagation paths. Automatic action for timing failures. Edge kept for diagnostic purposes."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat (document)",
        "tooltip": "Keeps edge with documented timing failure. Only valid if leads reflect anticipated policy changes, not reverse causation."
      },
      {
        "value": "RE_ESTIMATE",
        "label": "Flag for re-estimation",
        "tooltip": "Queues re-estimation with adjusted shock timing or additional lead/lag structure to investigate timing failure."
      }
    ]
  },
  "HAC_LAG_SENSITIVITY_HIGH": {
    "action_type": "set_hac_action",
    "options": [
      {
        "value": "USE_FIXED_BW",
        "label": "Fix HAC bandwidth",
        "tooltip": "Uses a fixed, data-driven bandwidth (Andrews 1991). Removes sensitivity to ad hoc bandwidth choice."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps current estimate with documented bandwidth sensitivity caveat. Report results across multiple bandwidths."
      }
    ]
  },
  "SELECTION_PUBLIC_BANK_ONLY": {
    "action_type": "set_selection_action",
    "options": [
      {
        "value": "ADD_DISCLAIMER",
        "label": "Add report disclaimer",
        "tooltip": "Adds explicit sample restriction disclaimer to the system report. Results clearly labeled as public-bank-only."
      },
      {
        "value": "CAP_SCOPE",
        "label": "Cap counterfactual scope",
        "tooltip": "Restricts counterfactual predictions to public banks only. Prevents extrapolation to non-sampled bank types."
      },
      {
        "value": "ACCEPT",
        "label": "Accept as-is",
        "tooltip": "No action taken. Use only if the target population is specifically public banks."
      }
    ]
  },
  "SURVIVORSHIP_BIAS_RISK": {
    "action_type": "set_survivorship_action",
    "options": [
      {
        "value": "ADD_DISCLAIMER",
        "label": "Add report disclaimer",
        "tooltip": "Adds survivorship bias disclaimer. Notes that estimates may understate negative effects due to exit selection."
      },
      {
        "value": "SENSITIVITY_CHECK",
        "label": "Run sensitivity check",
        "tooltip": "Re-estimates including failed/merged banks up to their last observation. Compares with survivor-only estimates."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps survivor-only estimate with documented caveat about potential downward bias in negative effect estimates."
      }
    ]
  },
  "COVERAGE_GAP_EXTERNAL_VALIDITY": {
    "action_type": "set_coverage_action",
    "options": [
      {
        "value": "ADD_DISCLAIMER",
        "label": "Add report disclaimer",
        "tooltip": "Adds coverage gap disclaimer. Documents which segments of the target population are missing from the sample."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Accepts with documented coverage limitation. Notes direction of likely bias from missing segments."
      }
    ]
  },
  "RATING_DIAGNOSTICS_CONFLICT": {
    "action_type": "set_rating",
    "options": [
      {
        "value": "DOWNGRADE_B",
        "label": "Downgrade to B",
        "tooltip": "Downgrades from A to B due to failed diagnostics. Standard action to maintain rating-evidence consistency."
      },
      {
        "value": "DOWNGRADE_C",
        "label": "Downgrade to C",
        "tooltip": "Downgrades to C for severe diagnostic failures (multiple failed checks or critical timing failure)."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)",
        "tooltip": "Keeps A rating despite diagnostic issues. Requires strong justification documented in rationale."
      }
    ]
  },
  "N_REPORTING_INCONSISTENT": {
    "action_type": "set_n_action",
    "options": [
      {
        "value": "FIX_REPORT",
        "label": "Fix report N",
        "tooltip": "Updates the system report header to match EdgeCard N_eff. Standard fix for reporting inconsistencies."
      },
      {
        "value": "FIX_EDGECARD",
        "label": "Fix EdgeCard N_eff",
        "tooltip": "Updates EdgeCard N_eff to match report header. Use only if the report header is the authoritative source."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)",
        "tooltip": "Keeps inconsistency with documentation. Only if the discrepancy reflects a deliberate methodological choice."
      }
    ]
  },
  "CROSS_EVIDENCE_CONFLICT": {
    "action_type": "set_conflict_action",
    "options": [
      {
        "value": "PREFER_STRUCTURAL",
        "label": "Prefer structural edge",
        "tooltip": "Uses the structural (better-identified) edge estimate. The conflicting reduced-form edge is demoted to diagnostic-only."
      },
      {
        "value": "PREFER_REDUCED",
        "label": "Prefer reduced-form edge",
        "tooltip": "Uses the reduced-form edge estimate. The structural edge is demoted. Appropriate if structural identification is suspect."
      },
      {
        "value": "ACCEPT_BOTH",
        "label": "Accept both (document)",
        "tooltip": "Keeps both estimates with documented conflict. Reports will show both with an explicit conflict warning."
      }
    ]
  },
  "UNIT_MISSING_IN_EDGECARD": {
    "action_type": "set_unit_action",
    "options": [
      {
        "value": "ADD_UNITS",
        "label": "Add units from spec",
        "tooltip": "Auto-populates treatment_unit and outcome_unit from the DAG node specifications. Standard auto-fix."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (not critical)",
        "tooltip": "Keeps edge without explicit units. Only for edges not used in propagation where unit ambiguity is acceptable."
      }
    ]
  },
  "_default": {
    "action_type": "resolve",
    "options": [
      {
        "value": "ACCEPT",
        "label": "Accept",
        "tooltip": "Accepts the issue without further action. The issue is marked as resolved."
      },
      {
        "value": "REJECT",
        "label": "Reject",
        "tooltip": "Rejects the flagged finding. The edge remains as-is but the rejection is logged for audit."
      },
      {
        "value": "ESCALATE",
        "label": "Escalate",
        "tooltip": "Escalates to senior reviewer or domain expert. Issue remains open until resolved by escalation target."
      }
    ]
  }
};
const GENERATED_AT = "2026-02-08 19:08:27 UTC";
const ISSUE_GUIDANCE = {};

// ── Helpers ──────────────────────────────────────────────────────────────
function escHtml(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function formatBeta(beta) {
    if (beta === null || beta === undefined) return '--';
    if (beta === 0) return '0';
    var abs = Math.abs(beta);
    if (abs >= 10000) return (beta / 1000).toFixed(0) + 'k';
    if (abs >= 1000) return (beta / 1000).toFixed(1) + 'k';
    if (abs >= 100) return beta.toFixed(0);
    if (abs >= 10) return beta.toFixed(1);
    if (abs >= 1) return beta.toFixed(1);
    if (abs >= 0.01) return beta.toFixed(2);
    if (abs >= 0.001) return beta.toFixed(3);
    return beta.toExponential(1);
}
function fmtP(p) {
    if (p === null || p === undefined) return '--';
    if (p < 0.0001) return p.toExponential(2);
    return p.toFixed(4);
}

function getEdgeColor(d) {
    var isNull = d.pvalue !== null && d.pvalue !== undefined && d.pvalue >= 0.05;
    if (isNull) return '#999';
    return EDGE_TYPE_COLORS[d.edge_type] || '#2563eb';
}
function isEdgeNull(d) {
    return d.pvalue !== null && d.pvalue !== undefined && d.pvalue >= 0.05;
}

// ── Decision state ───────────────────────────────────────────────────────
var decisions = {}; // issue_key -> {value, rationale}

// Flatten all issues across edges for the sidebar
var allIssues = [];
var SEVERITY_ORDER = {CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3};
EDGES.forEach(function(e) {
    if (e.issues && e.issues.length > 0) {
        e.issues.forEach(function(issue) {
            allIssues.push({
                edge_id: e.id,
                issue_key: issue.issue_key || (issue.rule_id + ':' + e.id),
                rule_id: issue.rule_id,
                severity: issue.severity,
                message: issue.message
            });
        });
    }
});
allIssues.sort(function(a, b) {
    var sa = SEVERITY_ORDER[a.severity] || 99;
    var sb = SEVERITY_ORDER[b.severity] || 99;
    if (sa !== sb) return sa - sb;
    return a.edge_id.localeCompare(b.edge_id);
});
var totalIssues = allIssues.length;

function countResolved() {
    var c = 0;
    for (var k in decisions) {
        if (decisions[k] && decisions[k].value) c++;
    }
    return c;
}

function updateProgress() {
    var resolved = countResolved();
    var pct = totalIssues > 0 ? (resolved / totalIssues * 100) : 0;
    document.getElementById('pitfallProgressFill').style.width = pct + '%';
    document.getElementById('pitfallProgressLabel').textContent = resolved + ' / ' + totalIssues + ' resolved';
}

// ── Setup ────────────────────────────────────────────────────────────────
document.getElementById('dagSubtitle').textContent =
    NODES.length + ' nodes, ' + EDGES.length + ' edges';
document.getElementById('statNodes').textContent = NODES.length;

// Compute node layers via topological distance from roots
var inDegree = {};
NODES.forEach(function(n) { inDegree[n.id] = 0; });
EDGES.forEach(function(e) { inDegree[e.target] = (inDegree[e.target] || 0) + 1; });

var layers = {};
var visited = {};
function computeLayer(nodeId) {
    if (visited[nodeId]) return layers[nodeId] || 0;
    visited[nodeId] = true;
    var incoming = EDGES.filter(function(e) { return e.target === nodeId; });
    if (incoming.length === 0) { layers[nodeId] = 0; return 0; }
    var maxParent = 0;
    incoming.forEach(function(e) {
        var pLayer = computeLayer(e.source);
        if (pLayer + 1 > maxParent) maxParent = pLayer + 1;
    });
    layers[nodeId] = maxParent;
    return maxParent;
}
NODES.forEach(function(n) { computeLayer(n.id); });
NODES.forEach(function(n) { n.layer = layers[n.id] || 0; });

// Populate type filter
var typeSet = {};
EDGES.forEach(function(e) { typeSet[e.edge_type || 'causal'] = true; });
var typeFilter = document.getElementById('typeFilter');
Object.keys(typeSet).sort().forEach(function(t) {
    var opt = document.createElement('option');
    opt.value = t;
    opt.textContent = EDGE_TYPE_LABELS[t] || t;
    typeFilter.appendChild(opt);
});

// Build legend
var legendContainer = document.getElementById('legendContainer');
Object.keys(typeSet).sort().forEach(function(t) {
    var color = EDGE_TYPE_COLORS[t] || '#2563eb';
    var div = document.createElement('div');
    div.className = 'legend-item';
    div.innerHTML = '<div class="legend-line" style="background:' + color + '"></div>' +
        (EDGE_TYPE_LABELS[t] || t);
    legendContainer.appendChild(div);
});
var nullLeg = document.createElement('div');
nullLeg.className = 'legend-item';
nullLeg.innerHTML = '<div class="legend-line dashed" style="border-color:#999"></div>Null / Insig.';
legendContainer.appendChild(nullLeg);

// ── Build pitfall sidebar ────────────────────────────────────────────────
var pitfallList = document.getElementById('pitfallList');

if (allIssues.length === 0) {
    pitfallList.innerHTML = '<div class="pitfall-empty">No open issues.</div>';
} else {
    allIssues.forEach(function(issue) {
        var ruleInfo = RULE_DESCRIPTIONS[issue.rule_id] || {};
        var actCfg = ACTIONS_BY_RULE[issue.rule_id] || ACTIONS_BY_RULE['_default'] || {};
        var options = actCfg.options || [];

        var div = document.createElement('div');
        div.className = 'pitfall-item';
        div.setAttribute('data-issue-key', issue.issue_key);
        div.setAttribute('data-edge-id', issue.edge_id);

        // Build options HTML
        var optHtml = '<option value="">-- select action --</option>';
        options.forEach(function(o) {
            optHtml += '<option value="' + escHtml(o.value) + '" data-tooltip="' + escHtml(o.tooltip || '') + '">' + escHtml(o.label) + '</option>';
        });

        var llmText = ISSUE_GUIDANCE[issue.issue_key] || '';
        var llmHtml = llmText ?
            '<div class="pd-llm-guidance"><div class="pd-llm-guidance-title">AI Analysis</div>' +
            escHtml(llmText) + '</div>' : '';

        div.innerHTML =
            '<div class="pitfall-item-header" data-header="1">' +
                '<span class="pitfall-edge">' + escHtml(issue.edge_id) + '</span>' +
                '<span class="pitfall-severity ' + issue.severity + '">' + issue.severity + '</span>' +
                '<span class="pitfall-resolved-check">&#10003;</span>' +
            '</div>' +
            '<div class="pitfall-msg">' + escHtml(issue.message) + '</div>' +
            '<div class="pitfall-decision" data-decision-key="' + escHtml(issue.issue_key) + '">' +
                llmHtml +
                (ruleInfo.explanation ?
                    '<div class="pd-label">Why it matters:</div>' +
                    '<div class="pd-text">' + (ruleInfo.explanation || '') + '</div>' : '') +
                (ruleInfo.guidance ?
                    '<div class="pd-label">Decision guidance:</div>' +
                    '<div class="pd-guidance">' + (ruleInfo.guidance || '') + '</div>' : '') +
                '<div class="pd-label">Action:</div>' +
                '<select data-key="' + escHtml(issue.issue_key) + '">' + optHtml + '</select>' +
                '<div class="pd-tooltip-area" data-tip-for="' + escHtml(issue.issue_key) + '"></div>' +
                '<input type="text" data-rationale="' + escHtml(issue.issue_key) + '" placeholder="Justification (optional)...">' +
                '<div class="pd-buttons">' +
                    '<button class="pd-btn pd-btn-confirm" data-confirm="' + escHtml(issue.issue_key) + '">Confirm</button>' +
                    '<button class="pd-btn" data-defer="' + escHtml(issue.issue_key) + '">Defer</button>' +
                '</div>' +
            '</div>';

        pitfallList.appendChild(div);
    });
}

updateProgress();

// ── Click-to-highlight + expand ──────────────────────────────────────────
var currentHighlightEdge = null;

function highlightEdge(edgeId) {
    // Remove previous highlight
    links.classed('highlighted', false);
    // Apply highlight to matching link
    links.each(function(d) {
        if (d.id === edgeId) {
            d3.select(this).classed('highlighted', true);
        }
    });
    currentHighlightEdge = edgeId;

    // Pan/zoom to edge midpoint
    var edgeData = EDGES.find(function(e) { return e.id === edgeId; });
    if (edgeData && edgeData.source && edgeData.target) {
        var sx = edgeData.source.x || edgeData.source;
        var sy = edgeData.source.y || edgeData.source;
        var tx = edgeData.target.x || edgeData.target;
        var ty = edgeData.target.y || edgeData.target;
        if (typeof sx === 'number' && typeof tx === 'number') {
            var mx = (sx + tx) / 2;
            var my = (sy + ty) / 2;
            var svgEl = document.getElementById('graph');
            var w = svgEl.clientWidth;
            var h = svgEl.clientHeight;
            var t = d3.zoomIdentity.translate(w/2 - mx, h/2 - my);
            svg.transition().duration(500).call(zoomBehavior.transform, t);
        }
    }
}

function markEdgeResolved(edgeId) {
    // Check if ALL issues for this edge are resolved
    var edgeIssues = allIssues.filter(function(i) { return i.edge_id === edgeId; });
    var allResolved = edgeIssues.every(function(i) {
        return decisions[i.issue_key] && decisions[i.issue_key].value;
    });
    if (allResolved) {
        links.each(function(d) {
            if (d.id === edgeId) {
                d3.select(this).classed('edge-resolved', true).classed('critical-issue', false).classed('highlighted', false);
            }
        });
    }
}

// Event delegation on pitfall list
pitfallList.addEventListener('click', function(e) {
    var target = e.target;

    // Confirm button
    if (target.hasAttribute('data-confirm')) {
        e.stopPropagation();
        var key = target.getAttribute('data-confirm');
        if (!decisions[key] || !decisions[key].value) {
            alert('Please select an action before confirming.');
            return;
        }
        var item = pitfallList.querySelector('[data-issue-key="' + key + '"]');
        if (item) {
            item.classList.add('resolved');
            var sel = item.querySelector('select[data-key="' + key + '"]');
            if (sel) sel.classList.add('decided');
        }
        var edgeId = null;
        allIssues.forEach(function(i) { if (i.issue_key === key) edgeId = i.edge_id; });
        if (edgeId) markEdgeResolved(edgeId);
        updateProgress();
        return;
    }

    // Defer button
    if (target.hasAttribute('data-defer')) {
        e.stopPropagation();
        var key2 = target.getAttribute('data-defer');
        var item2 = pitfallList.querySelector('[data-issue-key="' + key2 + '"]');
        if (item2) {
            item2.classList.remove('active');
            var panel = item2.querySelector('.pitfall-decision');
            if (panel) panel.classList.remove('open');
        }
        links.classed('highlighted', false);
        return;
    }

    // Don't toggle when clicking inside decision panel controls
    if (target.tagName === 'SELECT' || target.tagName === 'INPUT' || target.tagName === 'OPTION') return;

    // Find the pitfall-item
    var pitfallItem = target.closest('.pitfall-item');
    if (!pitfallItem) return;

    // Toggle active state
    var wasActive = pitfallItem.classList.contains('active');

    // Deactivate all
    pitfallList.querySelectorAll('.pitfall-item').forEach(function(el) {
        el.classList.remove('active');
        var p = el.querySelector('.pitfall-decision');
        if (p) p.classList.remove('open');
    });
    links.classed('highlighted', false);

    if (!wasActive) {
        pitfallItem.classList.add('active');
        var decPanel = pitfallItem.querySelector('.pitfall-decision');
        if (decPanel) decPanel.classList.add('open');
        var eid = pitfallItem.getAttribute('data-edge-id');
        if (eid) highlightEdge(eid);
    }
});

// Action dropdown change
pitfallList.addEventListener('change', function(e) {
    if (e.target.tagName !== 'SELECT' || !e.target.hasAttribute('data-key')) return;
    var key = e.target.getAttribute('data-key');
    var val = e.target.value;
    if (!decisions[key]) decisions[key] = {value: '', rationale: ''};
    decisions[key].value = val;

    if (val) {
        e.target.classList.add('decided');
    } else {
        e.target.classList.remove('decided');
    }

    // Show tooltip for selected option
    var tipArea = pitfallList.querySelector('[data-tip-for="' + key + '"]');
    if (tipArea) {
        var selectedOpt = e.target.options[e.target.selectedIndex];
        tipArea.textContent = selectedOpt ? (selectedOpt.getAttribute('data-tooltip') || '') : '';
    }
});

// Rationale input
pitfallList.addEventListener('input', function(e) {
    if (e.target.tagName !== 'INPUT' || !e.target.hasAttribute('data-rationale')) return;
    var key = e.target.getAttribute('data-rationale');
    if (!decisions[key]) decisions[key] = {value: '', rationale: ''};
    decisions[key].rationale = e.target.value;
});

// ── Export ────────────────────────────────────────────────────────────────
document.getElementById('exportBtn').addEventListener('click', function() {
    var analystId = document.getElementById('analystId').value.trim();
    var now = new Date().toISOString();
    var decisionList = [];

    for (var key in decisions) {
        var dec = decisions[key];
        if (!dec.value) continue;
        var parts = key.split(':', 1);
        var ruleId = parts[0] || '';
        var edgeId = key.substring(ruleId.length + 1);
        var actCfg = ACTIONS_BY_RULE[ruleId] || ACTIONS_BY_RULE['_default'] || {};
        decisionList.push({
            issue_key: key,
            edge_id: edgeId,
            rule_id: ruleId,
            action: actCfg.action_type || 'unknown',
            value: dec.value,
            rationale: dec.rationale || '',
            status: 'CLOSED',
            source: 'dag_visualization'
        });
    }

    var output = {
        generated_at: now,
        analyst_id: analystId || 'anonymous',
        panel_built_at: GENERATED_AT,
        decisions: decisionList
    };

    var blob = new Blob([JSON.stringify(output, null, 2)], {type: 'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    var dateStr = now.slice(0,10).replace(/-/g,'');
    a.href = url;
    a.download = 'dag_viz_decisions_' + dateStr + '.json';
    a.click();
    URL.revokeObjectURL(url);
});

// ── D3 Graph ─────────────────────────────────────────────────────────────
var svg = d3.select('#graph');
var width = window.innerWidth;
var height = window.innerHeight;
svg.attr('width', width).attr('height', height);

// Arrow markers
var defs = svg.append('defs');
var defaultColors = Object.values(EDGE_TYPE_COLORS).concat(['#999']);
var colorSet = {};
defaultColors.forEach(function(c) { colorSet[c] = true; });
Object.keys(colorSet).forEach(function(color) {
    defs.append('marker')
        .attr('id', 'arrow-' + color.replace('#', ''))
        .attr('viewBox', '0 -3 6 6')
        .attr('refX', 18)
        .attr('refY', 0)
        .attr('markerWidth', 5)
        .attr('markerHeight', 5)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-3L6,0L0,3')
        .attr('fill', color);
});

var g = svg.append('g');
var zoomBehavior = d3.zoom().scaleExtent([0.3, 3]).on('zoom', function(e) { g.attr('transform', e.transform); });
svg.call(zoomBehavior);

var simulation = d3.forceSimulation(NODES)
    .force('link', d3.forceLink(EDGES).id(function(d) { return d.id; }).distance(120).strength(0.3))
    .force('charge', d3.forceManyBody().strength(-400))
    .force('center', d3.forceCenter(width / 2, height / 2))
    .force('y', d3.forceY(function(d) { return 80 + d.layer * 90; }).strength(0.7))
    .force('x', d3.forceX(width / 2).strength(0.02))
    .force('collision', d3.forceCollide(40));

var linkGroup = g.append('g');
var links = linkGroup.selectAll('path')
    .data(EDGES)
    .enter()
    .append('path')
    .attr('class', function(d) { return 'link' + (isEdgeNull(d) ? ' null' : '') + (d.has_critical_issue ? ' critical-issue' : ''); })
    .attr('stroke', function(d) { return getEdgeColor(d); })
    .attr('stroke-width', function(d) { return d.pvalue !== null && d.pvalue < 0.05 ? 2.5 : 1.5; })
    .attr('marker-end', function(d) { return 'url(#arrow-' + getEdgeColor(d).replace('#', '') + ')'; })
    .on('mouseover', showEdgeTooltip)
    .on('mouseout', hideTooltip);

var labelGroup = g.append('g');
var labelBgs = labelGroup.selectAll('rect')
    .data(EDGES)
    .enter()
    .append('rect')
    .attr('class', 'label-bg')
    .attr('rx', 2)
    .attr('ry', 2);

var linkLabels = labelGroup.selectAll('text')
    .data(EDGES)
    .enter()
    .append('text')
    .attr('class', 'link-label')
    .text(function(d) { return formatBeta(d.point); });

var nodeGroup = g.append('g');
var node = nodeGroup.selectAll('g')
    .data(NODES)
    .enter()
    .append('g')
    .attr('class', 'node')
    .call(d3.drag()
        .on('start', function(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
        .on('drag', function(e, d) { d.fx = e.x; d.fy = e.y; })
        .on('end', function(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }))
    .on('mouseover', showNodeTooltip)
    .on('mouseout', hideTooltip);

// Check if node has ID risks from any edge
var nodeIdRisks = {};
EDGES.forEach(function(e) {
    if (e.id_risks && Object.keys(e.id_risks).length > 0) {
        nodeIdRisks[e.source] = true;
        nodeIdRisks[e.target] = true;
    }
});

node.append('circle')
    .attr('r', 18)
    .attr('class', function(d) {
        var cls = '';
        if (d.latent) cls += ' latent';
        if (nodeIdRisks[d.id]) cls += ' id-risk';
        return cls;
    });
node.append('text').attr('dy', 4).text(function(d) { return d.label; });

var tooltip = d3.select('#tooltip');

function showEdgeTooltip(e, d) {
    var html = '<h3>' + d.source.id.replace(/_/g, ' ') + ' &rarr; ' + d.target.id.replace(/_/g, ' ') + '</h3>';
    html += '<div class="tooltip-row"><span class="tooltip-label">Edge ID</span><span class="tooltip-value">' + d.id + '</span></div>';
    html += '<div class="tooltip-row"><span class="tooltip-label">Type</span><span class="tooltip-value">' + (EDGE_TYPE_LABELS[d.edge_type] || d.edge_type) + '</span></div>';
    if (d.point !== null && d.point !== undefined) {
        html += '<div class="tooltip-row"><span class="tooltip-label">&beta;</span><span class="tooltip-value">' + d.point.toFixed(4) + '</span></div>';
    }
    if (d.se !== null && d.se !== undefined) {
        html += '<div class="tooltip-row"><span class="tooltip-label">SE</span><span class="tooltip-value">' + d.se.toFixed(4) + '</span></div>';
    }
    if (d.pvalue !== null && d.pvalue !== undefined) {
        html += '<div class="tooltip-row"><span class="tooltip-label">p-value</span><span class="tooltip-value ' + (isEdgeNull(d) ? 'null' : '') + '">' + fmtP(d.pvalue) + '</span></div>';
    }
    if (d.claim_level) html += '<div class="tooltip-row"><span class="tooltip-label">Claim</span><span class="tooltip-value">' + d.claim_level + '</span></div>';
    if (d.rating) html += '<div class="tooltip-row"><span class="tooltip-label">Rating</span><span class="tooltip-value">' + d.rating + '</span></div>';
    if (d.design) html += '<div class="tooltip-row"><span class="tooltip-label">Design</span><span class="tooltip-value">' + d.design + '</span></div>';
    if (d.diagnostics && d.diagnostics.length > 0) {
        var passed = d.diagnostics.filter(function(x) { return x.passed; }).length;
        html += '<div class="tooltip-row"><span class="tooltip-label">Diagnostics</span><span class="tooltip-value">' + passed + '/' + d.diagnostics.length + ' pass</span></div>';
    }
    if (d.interpretation) html += '<div class="tooltip-row"><span class="tooltip-label">Interpretation</span><span class="tooltip-value" style="text-align:left;font-weight:400">' + d.interpretation + '</span></div>';
    if (d.llm_annotation) {
        html += '<div class="tooltip-annotation">' + d.llm_annotation + '</div>';
    }
    if (d.issues && d.issues.length > 0) {
        html += '<div class="tooltip-issues">';
        d.issues.forEach(function(issue) {
            html += '<div class="tooltip-issue ' + (issue.severity || '').toLowerCase() + '">[' + issue.severity + '] ' + escHtml(issue.message) + '</div>';
        });
        html += '</div>';
    }
    tooltip.html(html).style('left', (e.pageX + 15) + 'px').style('top', (e.pageY - 15) + 'px').classed('visible', true);
}

function showNodeTooltip(e, d) {
    var html = '<h3>' + d.label + '</h3>';
    html += '<div class="tooltip-row"><span class="tooltip-label">ID</span><span class="tooltip-value">' + d.id + '</span></div>';
    if (d.description) html += '<div class="tooltip-row"><span class="tooltip-label">Description</span><span class="tooltip-value" style="text-align:left;font-weight:400">' + d.description + '</span></div>';
    if (d.unit) html += '<div class="tooltip-row"><span class="tooltip-label">Unit</span><span class="tooltip-value">' + d.unit + '</span></div>';
    if (d.frequency) html += '<div class="tooltip-row"><span class="tooltip-label">Frequency</span><span class="tooltip-value">' + d.frequency + '</span></div>';
    if (d.latent) html += '<div class="tooltip-row"><span class="tooltip-label">Observed</span><span class="tooltip-value null">Latent (unobserved)</span></div>';
    tooltip.html(html).style('left', (e.pageX + 15) + 'px').style('top', (e.pageY - 15) + 'px').classed('visible', true);
}

function hideTooltip() { tooltip.classed('visible', false); }

function getLabelPos(d) {
    var dx = d.target.x - d.source.x;
    var dy = d.target.y - d.source.y;
    var dist = Math.sqrt(dx*dx + dy*dy) || 1;
    var t = 0.4;
    var mx = d.source.x + dx * t;
    var my = d.source.y + dy * t;
    var offset = 12;
    var px = -dy / dist * offset;
    var py = dx / dist * offset;
    return { x: mx + px, y: my + py };
}

simulation.on('tick', function() {
    links.attr('d', function(d) {
        var dx = d.target.x - d.source.x, dy = d.target.y - d.source.y;
        var dr = Math.sqrt(dx * dx + dy * dy) * 1.8;
        return 'M' + d.source.x + ',' + d.source.y + 'A' + dr + ',' + dr + ' 0 0,1 ' + d.target.x + ',' + d.target.y;
    });
    linkLabels.each(function(d) {
        var pos = getLabelPos(d);
        d3.select(this).attr('x', pos.x).attr('y', pos.y);
    });
    labelBgs.each(function(d, i) {
        var pos = getLabelPos(d);
        var textNode = linkLabels.nodes()[i];
        var bbox = textNode.getBBox();
        d3.select(this)
            .attr('x', pos.x - bbox.width/2 - 2)
            .attr('y', pos.y - bbox.height/2 - 1)
            .attr('width', bbox.width + 4)
            .attr('height', bbox.height + 2);
    });
    node.attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
});

// ── Filters ──────────────────────────────────────────────────────────────
function applyFilters() {
    var typeVal = document.getElementById('typeFilter').value;
    var ratVal = document.getElementById('ratingFilter').value;
    var showNullVal = document.getElementById('showNull').checked;
    var showLabelsVal = document.getElementById('showLabels').checked;

    var isVisible = function(d) {
        if (typeVal !== 'all' && d.edge_type !== typeVal) return false;
        if (ratVal !== 'all' && d.rating !== ratVal) return false;
        if (!showNullVal && isEdgeNull(d)) return false;
        return true;
    };

    links.style('display', function(d) { return isVisible(d) ? null : 'none'; });
    linkLabels.style('display', function(d) { return (isVisible(d) && showLabelsVal) ? null : 'none'; });
    labelBgs.style('display', function(d) { return (isVisible(d) && showLabelsVal) ? null : 'none'; });

    var visible = EDGES.filter(isVisible);
    document.getElementById('statEdges').textContent = visible.length;
    document.getElementById('statA').textContent = visible.filter(function(e) { return e.rating === 'A'; }).length;
    document.getElementById('statB').textContent = visible.filter(function(e) { return e.rating === 'B'; }).length;
    document.getElementById('statC').textContent = visible.filter(function(e) { return e.rating === 'C'; }).length;
    var visibleIssues = visible.reduce(function(s, e) { return s + (e.issues ? e.issues.length : 0); }, 0);
    document.getElementById('statIssues').textContent = visibleIssues;
}

document.getElementById('typeFilter').addEventListener('change', applyFilters);
document.getElementById('ratingFilter').addEventListener('change', applyFilters);
document.getElementById('showNull').addEventListener('change', applyFilters);
document.getElementById('showLabels').addEventListener('change', applyFilters);

applyFilters();
    </script>
</body>
</html>