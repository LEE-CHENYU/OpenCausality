<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HITL Resolution Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #fff;
            color: #000;
            font-size: 12px;
            line-height: 1.5;
        }

        /* Header */
        .header {
            padding: 24px 32px 16px;
            border-bottom: 1px solid #000;
        }
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .header .subtitle {
            color: #666;
            font-size: 11px;
            margin-bottom: 12px;
        }
        .stats-row {
            display: flex;
            gap: 24px;
            align-items: center;
            flex-wrap: wrap;
        }
        .stat {
            font-size: 11px;
        }
        .stat strong { font-weight: 600; }
        .stat .critical { color: #000; font-weight: 700; }
        .stat .high { color: #555; font-weight: 600; }

        /* Controls bar */
        .controls-bar {
            padding: 10px 32px;
            border-bottom: 1px solid #000;
            display: flex;
            gap: 16px;
            align-items: center;
            background: #fafafa;
            font-size: 11px;
        }
        .controls-bar label {
            color: #666;
            margin-right: 4px;
        }
        .controls-bar select, .controls-bar input[type="text"] {
            border: 1px solid #000;
            background: #fff;
            padding: 4px 8px;
            font-size: 11px;
            font-family: inherit;
        }
        .controls-bar input[type="text"] {
            width: 200px;
        }

        /* Progress bar */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        .progress-bar {
            width: 120px;
            height: 8px;
            border: 1px solid #000;
            background: #fff;
        }
        .progress-fill {
            height: 100%;
            background: #000;
            transition: width 0.3s;
        }
        .progress-label {
            font-size: 11px;
            font-weight: 500;
            min-width: 60px;
        }

        /* Sections */
        .section {
            padding: 16px 32px;
            border-bottom: 1px solid #ddd;
        }
        .section:last-of-type {
            border-bottom: 1px solid #000;
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .section-title {
            font-size: 13px;
            font-weight: 600;
        }
        .section-count {
            font-size: 11px;
            color: #666;
        }
        .severity-badge {
            display: inline-block;
            font-size: 10px;
            font-weight: 600;
            padding: 1px 6px;
            border: 1px solid #000;
            margin-left: 8px;
        }
        .severity-badge.critical {
            background: #000;
            color: #fff;
        }
        .severity-badge.high {
            background: #fff;
            color: #000;
        }
        .severity-badge.medium {
            background: #eee;
            color: #000;
        }
        .severity-badge.low {
            background: #fff;
            color: #999;
        }

        /* Bulk action */
        .bulk-action {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: #fafafa;
        }
        .bulk-action label { color: #666; font-size: 11px; }
        .bulk-action select {
            border: 1px solid #000;
            background: #fff;
            padding: 3px 6px;
            font-size: 11px;
            font-family: inherit;
        }
        .btn-sm {
            border: 1px solid #000;
            background: #fff;
            padding: 3px 10px;
            font-size: 11px;
            font-family: inherit;
            cursor: pointer;
        }
        .btn-sm:hover { background: #000; color: #fff; }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        th {
            text-align: left;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 6px 8px;
            border-bottom: 1px solid #000;
            color: #666;
        }
        td {
            padding: 8px 8px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        tr:hover td { background: #fafafa; }
        tr.resolved td { opacity: 0.45; }

        .edge-name {
            font-weight: 500;
            white-space: nowrap;
        }
        .mono {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 10px;
        }
        .diag-pass { color: #000; }
        .diag-fail { color: #000; font-weight: 700; text-decoration: underline; }

        .claim-tag {
            display: inline-block;
            font-size: 9px;
            font-weight: 600;
            padding: 1px 5px;
            border: 1px solid #000;
            white-space: nowrap;
        }
        .rating-tag {
            display: inline-block;
            font-size: 10px;
            font-weight: 700;
            width: 18px;
            text-align: center;
            border: 1px solid #000;
        }

        .flag-list {
            font-size: 10px;
            color: #666;
        }
        .flag-list .flag {
            display: inline-block;
            margin-right: 4px;
            padding: 0 3px;
            border: 1px solid #ccc;
            font-size: 9px;
        }

        /* Action cells */
        td select {
            border: 1px solid #000;
            background: #fff;
            padding: 3px 6px;
            font-size: 11px;
            font-family: inherit;
            width: 100%;
        }
        td select.decided {
            background: #000;
            color: #fff;
        }
        td input[type="text"] {
            border: 1px solid #ccc;
            padding: 3px 6px;
            font-size: 10px;
            font-family: inherit;
            width: 100%;
            margin-top: 4px;
        }
        td input[type="text"]:focus {
            border-color: #000;
            outline: none;
        }

        /* Details toggle */
        .details-row td {
            padding: 0 8px 8px 8px;
            border-bottom: 1px solid #ddd;
        }
        .details-content {
            display: none;
            padding: 8px 12px;
            background: #fafafa;
            border: 1px solid #eee;
            font-size: 10px;
            line-height: 1.6;
        }
        .details-content.open { display: block; }
        .detail-row {
            display: flex;
            justify-content: space-between;
            max-width: 400px;
        }
        .detail-label { color: #666; }
        .detail-value { font-weight: 500; font-variant-numeric: tabular-nums; }
        .toggle-btn {
            cursor: pointer;
            color: #666;
            font-size: 10px;
            text-decoration: underline;
        }
        .toggle-btn:hover { color: #000; }

        /* Footer */
        .footer {
            padding: 16px 32px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .footer label {
            font-size: 11px;
            color: #666;
        }
        .footer input[type="text"] {
            border: 1px solid #000;
            padding: 6px 10px;
            font-size: 11px;
            font-family: inherit;
            width: 220px;
        }
        .btn-export {
            border: 1px solid #000;
            background: #000;
            color: #fff;
            padding: 6px 20px;
            font-size: 12px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }
        .btn-export:hover { background: #333; }
        .btn-export:disabled {
            background: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
        }
        .footer .timestamp {
            font-size: 10px;
            color: #999;
            margin-left: auto;
        }

        /* Hidden */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="header">
    <h1>HITL Resolution Panel</h1>
    <div class="subtitle">Human-in-the-Loop Issue Resolution &mdash; KSPI K2 Agentic Pipeline</div>
    <div class="stats-row" id="statsRow"></div>
</div>

<div class="controls-bar">
    <label>Severity</label>
    <select id="filterSeverity">
        <option value="all">All</option>
        <option value="CRITICAL">CRITICAL</option>
        <option value="HIGH">HIGH</option>
        <option value="MEDIUM">MEDIUM</option>
        <option value="LOW">LOW</option>
    </select>
    <label>Rule</label>
    <select id="filterRule">
        <option value="all">All rules</option>
    </select>
    <label>Status</label>
    <select id="filterStatus">
        <option value="all">All</option>
        <option value="pending">Pending</option>
        <option value="resolved">Resolved</option>
    </select>
    <div class="progress-container">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <span class="progress-label" id="progressLabel">0 / 0</span>
    </div>
</div>

<div id="sectionsContainer"></div>

<div class="footer">
    <label>Analyst ID</label>
    <input type="text" id="analystId" placeholder="Your name or initials">
    <button class="btn-export" id="exportBtn">Export Decisions</button>
    <span class="timestamp" id="genTimestamp"></span>
</div>

<script>
// ── INJECTED DATA (replaced at build time) ──────────────────────────────
const ISSUES = {
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:fx_to_cpi_tradable": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0001 but claim_level=. Significance does not establish causation."
  },
  "RATING_DIAGNOSTICS_CONFLICT:cpi_to_nbk_rate": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "HIGH",
    "rule_id": "RATING_DIAGNOSTICS_CONFLICT",
    "message": "A-rating despite failed diagnostics."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_npl_kspi_annual": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0000 but claim_level=. Significance does not establish causation."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_npl_sector": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0029 but claim_level=. Significance does not establish causation."
  },
  "LOO_INSTABILITY:shock_to_npl_sector": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "HIGH",
    "rule_id": "LOO_INSTABILITY",
    "message": "Leave-one-out shows sign flip or >50% magnitude change."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_cor_kspi_annual": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0000 but claim_level=. Significance does not establish causation."
  },
  "RATING_DIAGNOSTICS_CONFLICT:vix_to_fx": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "HIGH",
    "rule_id": "RATING_DIAGNOSTICS_CONFLICT",
    "message": "A-rating despite failed diagnostics."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:oil_supply_to_income": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0030 but claim_level=REDUCED_FORM. Significance does not establish causation."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:cpi_to_nominal_income": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0003 but claim_level=. Significance does not establish causation."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:global_activity_to_income": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0030 but claim_level=REDUCED_FORM. Significance does not establish causation."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:portfolio_mix_to_rwa": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0000 but claim_level=. Significance does not establish causation."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:expenditure_to_payments_revenue": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0000 but claim_level=. Significance does not establish causation."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:nbk_rate_to_cor": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0029 but claim_level=. Significance does not establish causation."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_cor_kspi": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0000 but claim_level=. Significance does not establish causation."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_npl_kspi": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0000 but claim_level=. Significance does not establish causation."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:oil_supply_to_brent": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0000 but claim_level=. Significance does not establish causation."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_cor_sector": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0000 but claim_level=. Significance does not establish causation."
  },
  "LOO_INSTABILITY:shock_to_cor_sector": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "HIGH",
    "rule_id": "LOO_INSTABILITY",
    "message": "Leave-one-out shows sign flip or >50% magnitude change."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:fx_to_real_expenditure": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0120 but claim_level=. Significance does not establish causation."
  },
  "LOO_INSTABILITY:nbk_rate_to_cor_sector": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "HIGH",
    "rule_id": "LOO_INSTABILITY",
    "message": "Leave-one-out shows sign flip or >50% magnitude change."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:nbk_rate_to_deposit_cost": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0003 but claim_level=. Significance does not establish causation."
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:oil_demand_to_income": {
    "status": "OPEN",
    "opened_run": "4144e331",
    "severity": "CRITICAL",
    "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
    "message": "p=0.0030 but claim_level=REDUCED_FORM. Significance does not establish causation."
  }
};
const CLOSED_ISSUES_COUNT = 29;
const EDGES = {
  "cpi_to_nbk_rate": {
    "point": -0.5352595428652233,
    "se": 13.965626088683747,
    "pvalue": 0.969427021270663,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.8240000000000001,
    "claim_level": "BLOCKED_ID",
    "all_pass": false,
    "n_obs": 67,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": false
      }
    ],
    "failure_flags": [],
    "panel": null
  },
  "cpi_to_nominal_income": {
    "point": 0.65,
    "se": 0.18,
    "pvalue": 0.0003,
    "design": "IMMUTABLE_EVIDENCE",
    "rating": "A",
    "score": 0.99,
    "claim_level": "IDENTIFIED_CAUSAL",
    "all_pass": true,
    "n_obs": 80,
    "diagnostics": [
      {
        "name": "validated_evidence",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      }
    ],
    "failure_flags": [],
    "panel": null
  },
  "expenditure_to_payments_revenue": {
    "point": 333.40898842797003,
    "se": 70.95395662999442,
    "pvalue": 2.615043739934138e-06,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.6923529411764707,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "n_obs": 7,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "panel": null
  },
  "fx_to_cpi_tradable": {
    "point": 0.113,
    "se": 0.028,
    "pvalue": 0.0001,
    "design": "IMMUTABLE_EVIDENCE",
    "rating": "A",
    "score": 0.99,
    "claim_level": "IDENTIFIED_CAUSAL",
    "all_pass": true,
    "n_obs": 1200,
    "diagnostics": [
      {
        "name": "validated_evidence",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      }
    ],
    "failure_flags": [],
    "panel": null
  },
  "fx_to_real_expenditure": {
    "point": -0.1,
    "se": 0.04,
    "pvalue": 0.012,
    "design": "IMMUTABLE_EVIDENCE",
    "rating": "A",
    "score": 0.99,
    "claim_level": "IDENTIFIED_CAUSAL",
    "all_pass": true,
    "n_obs": 60,
    "diagnostics": [
      {
        "name": "validated_evidence",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      }
    ],
    "failure_flags": [],
    "panel": null
  },
  "global_activity_to_income": {
    "point": -0.15,
    "se": 0.05,
    "pvalue": 0.003,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.97,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "n_obs": null,
    "diagnostics": [
      {
        "name": "residual_checks",
        "passed": true
      }
    ],
    "failure_flags": [],
    "panel": null
  },
  "nbk_rate_to_cor": {
    "point": 0.3559558353990489,
    "se": 0.11934467793179021,
    "pvalue": 0.0028582378802030927,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.79,
    "claim_level": "BLOCKED_ID",
    "all_pass": false,
    "n_obs": 18,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "panel": null
  },
  "nbk_rate_to_cor_sector": {
    "point": 0.13488220323461572,
    "se": 1.3888893767706443,
    "pvalue": 0.9257977355121394,
    "design": "PANEL_LP_EXPOSURE_FE",
    "rating": "C",
    "score": 0.59,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "n_obs": 30,
    "diagnostics": [
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "leave_one_bank_out",
        "passed": false
      },
      {
        "name": "exposure_variation",
        "passed": true
      },
      {
        "name": "regime_break",
        "passed": true
      },
      {
        "name": "r_squared_within",
        "passed": true
      }
    ],
    "failure_flags": [
      "weak_identification"
    ],
    "panel": {
      "n_units": 4,
      "n_periods": 20,
      "balance": "unbalanced"
    }
  },
  "nbk_rate_to_deposit_cost": {
    "point": 0.22265648578368216,
    "se": 0.06178252515644397,
    "pvalue": 0.00031350811161547424,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.73,
    "claim_level": "BLOCKED_ID",
    "all_pass": false,
    "n_obs": 18,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": false
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "panel": null
  },
  "oil_demand_to_income": {
    "point": -0.15,
    "se": 0.05,
    "pvalue": 0.003,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.97,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "n_obs": null,
    "diagnostics": [
      {
        "name": "residual_checks",
        "passed": true
      }
    ],
    "failure_flags": [],
    "panel": null
  },
  "oil_supply_to_brent": {
    "point": -0.051665625936347805,
    "se": 0.005406555751311885,
    "pvalue": 1.2226952161376174e-21,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.97,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "n_obs": 306,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [],
    "panel": null
  },
  "oil_supply_to_income": {
    "point": -0.15,
    "se": 0.05,
    "pvalue": 0.003,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.97,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "n_obs": null,
    "diagnostics": [
      {
        "name": "residual_checks",
        "passed": true
      }
    ],
    "failure_flags": [],
    "panel": null
  },
  "portfolio_mix_to_rwa": {
    "point": 18195.962971994697,
    "se": 3952.754179466647,
    "pvalue": 4.1572238244395345e-06,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.7982352941176472,
    "claim_level": "BLOCKED_ID",
    "all_pass": false,
    "n_obs": 16,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "panel": null
  },
  "shock_to_cor_kspi": {
    "point": 85.95725782265167,
    "se": 7.402203593864903,
    "pvalue": 3.565189467437848e-31,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.79,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "n_obs": 26,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "panel": null
  },
  "shock_to_cor_kspi_annual": {
    "point": 360.11826362019025,
    "se": 45.441643112091796,
    "pvalue": 2.2841954119676474e-15,
    "design": "LOCAL_PROJECTIONS_ANNUAL",
    "rating": "B",
    "score": 0.6260000000000001,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "n_obs": 8,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "panel": null
  },
  "shock_to_cor_sector": {
    "point": 36.1781124278706,
    "se": 6.694567535398896,
    "pvalue": 4.747533899274181e-05,
    "design": "PANEL_LP_EXPOSURE_FE",
    "rating": "C",
    "score": 0.59,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "n_obs": 48,
    "diagnostics": [
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "leave_one_bank_out",
        "passed": false
      },
      {
        "name": "exposure_variation",
        "passed": true
      },
      {
        "name": "regime_break",
        "passed": true
      },
      {
        "name": "r_squared_within",
        "passed": true
      }
    ],
    "failure_flags": [
      "weak_identification"
    ],
    "panel": {
      "n_units": 4,
      "n_periods": 27,
      "balance": "unbalanced"
    }
  },
  "shock_to_npl_kspi": {
    "point": 72.79719737828836,
    "se": 10.2973539812859,
    "pvalue": 1.5548712171301462e-12,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.79,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "n_obs": 26,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "panel": null
  },
  "shock_to_npl_kspi_annual": {
    "point": 349.1598896557757,
    "se": 33.42158223881191,
    "pvalue": 1.5101332360091475e-25,
    "design": "LOCAL_PROJECTIONS_ANNUAL",
    "rating": "B",
    "score": 0.6260000000000001,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "n_obs": 8,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "panel": null
  },
  "shock_to_npl_sector": {
    "point": -46.548475059120626,
    "se": 13.416397639038799,
    "pvalue": 0.0029314539629232694,
    "design": "PANEL_LP_EXPOSURE_FE",
    "rating": "C",
    "score": 0.59,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "n_obs": 48,
    "diagnostics": [
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "leave_one_bank_out",
        "passed": false
      },
      {
        "name": "exposure_variation",
        "passed": true
      },
      {
        "name": "regime_break",
        "passed": false
      },
      {
        "name": "r_squared_within",
        "passed": true
      }
    ],
    "failure_flags": [
      "weak_identification",
      "regime_break_detected"
    ],
    "panel": {
      "n_units": 4,
      "n_periods": 27,
      "balance": "unbalanced"
    }
  },
  "vix_to_fx": {
    "point": -0.03242332765358874,
    "se": 0.10994554441748369,
    "pvalue": 0.7680675857023566,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.8900000000000001,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "n_obs": 190,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "r_squared_h0",
        "passed": true
      },
      {
        "name": "residual_ac1",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": false
      }
    ],
    "failure_flags": [],
    "panel": null
  }
};
const ACTIONS_BY_RULE = {
  "SIGNIFICANT_BUT_NOT_IDENTIFIED": {
    "action_type": "set_claim_level",
    "options": [
      {
        "value": "IDENTIFIED_CAUSAL",
        "label": "IDENTIFIED_CAUSAL"
      },
      {
        "value": "REDUCED_FORM",
        "label": "REDUCED_FORM"
      },
      {
        "value": "DESCRIPTIVE",
        "label": "DESCRIPTIVE"
      },
      {
        "value": "BLOCKED_ID",
        "label": "BLOCKED_ID"
      }
    ]
  },
  "REACTION_FUNCTION_EDGE": {
    "action_type": "set_propagation",
    "options": [
      {
        "value": "RECLASSIFY_DIAGNOSTIC",
        "label": "Reclassify as diagnostic"
      },
      {
        "value": "ACCEPT_WITH_CAVEAT",
        "label": "Accept with caveat"
      },
      {
        "value": "BLOCK_PROPAGATION",
        "label": "Block from propagation"
      }
    ]
  },
  "TIME_FE_ABSORBS_SHOCK": {
    "action_type": "set_design_fix",
    "options": [
      {
        "value": "ADD_INTERACTION",
        "label": "Add Exposure x Shock"
      },
      {
        "value": "DROP_TIME_FE",
        "label": "Drop time FE"
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)"
      }
    ]
  },
  "EXPOSURE_NOT_PREDETERMINED": {
    "action_type": "set_exposure_action",
    "options": [
      {
        "value": "LAG_EXPOSURE",
        "label": "Lag exposure variable"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      },
      {
        "value": "BLOCK_ID",
        "label": "Block identification claim"
      }
    ]
  },
  "MECHANICAL_EDGE_ESTIMATED": {
    "action_type": "set_edge_type",
    "options": [
      {
        "value": "CONVERT_BRIDGE",
        "label": "Convert to bridge edge"
      },
      {
        "value": "ACCEPT",
        "label": "Accept as regression"
      }
    ]
  },
  "PATH_DOUBLE_COUNTING": {
    "action_type": "set_path_choice",
    "options": [
      {
        "value": "USE_STRUCTURAL",
        "label": "Use structural chain"
      },
      {
        "value": "USE_REDUCED_FORM",
        "label": "Use reduced-form shortcut"
      },
      {
        "value": "ACCEPT_BOTH",
        "label": "Accept both (document)"
      }
    ]
  },
  "ENTITY_BOUNDARY_DRIFT": {
    "action_type": "set_boundary_action",
    "options": [
      {
        "value": "HARMONIZE",
        "label": "Harmonize to common scope"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      },
      {
        "value": "EXCLUDE_EDGE",
        "label": "Exclude edge"
      }
    ]
  },
  "KPI_DEFINITION_MISMATCH_CROSS_BANK": {
    "action_type": "set_kpi_action",
    "options": [
      {
        "value": "HARMONIZE",
        "label": "Harmonize definitions"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      },
      {
        "value": "EXCLUDE_EDGE",
        "label": "Exclude edge"
      }
    ]
  },
  "SHOCK_CONSTRUCT_AMBIGUOUS": {
    "action_type": "set_shock_action",
    "options": [
      {
        "value": "ADD_METADATA",
        "label": "Add shock metadata"
      },
      {
        "value": "ACCEPT",
        "label": "Accept as-is"
      }
    ]
  },
  "FREQUENCY_ALIGNMENT_ERROR": {
    "action_type": "set_freq_action",
    "options": [
      {
        "value": "AGGREGATE_Q",
        "label": "Aggregate to quarterly"
      },
      {
        "value": "AGGREGATE_A",
        "label": "Aggregate to annual"
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)"
      }
    ]
  },
  "FREQUENCY_SCALING_MISMATCH": {
    "action_type": "set_scaling_action",
    "options": [
      {
        "value": "NORMALIZE",
        "label": "Normalize to common unit"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      }
    ]
  },
  "EXTRACTION_PROVENANCE_GAPS": {
    "action_type": "set_provenance_action",
    "options": [
      {
        "value": "ADD_SOURCE",
        "label": "Add source reference"
      },
      {
        "value": "ACCEPT",
        "label": "Accept (low risk)"
      }
    ]
  },
  "SMALL_SAMPLE_INFERENCE": {
    "action_type": "set_sample_action",
    "options": [
      {
        "value": "CAP_B",
        "label": "Cap rating to B"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      },
      {
        "value": "RE_ESTIMATE",
        "label": "Flag for re-estimation"
      }
    ]
  },
  "PANEL_TOO_FEW_UNITS": {
    "action_type": "set_panel_action",
    "options": [
      {
        "value": "CAP_B",
        "label": "Cap rating to B"
      },
      {
        "value": "WILD_BOOTSTRAP",
        "label": "Use wild cluster bootstrap"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      }
    ]
  },
  "LOO_INSTABILITY": {
    "action_type": "set_loo_action",
    "options": [
      {
        "value": "CAP_C",
        "label": "Cap rating to C"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      },
      {
        "value": "RE_ESTIMATE",
        "label": "Flag for re-estimation"
      }
    ]
  },
  "BREAKS_UNMODELED": {
    "action_type": "set_breaks_action",
    "options": [
      {
        "value": "ADD_REGIME",
        "label": "Add regime dummy"
      },
      {
        "value": "SPLIT_SAMPLE",
        "label": "Split sample estimation"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      }
    ]
  },
  "MULTIPLE_TESTING_DRIFT": {
    "action_type": "set_testing_action",
    "options": [
      {
        "value": "BONFERRONI",
        "label": "Apply Bonferroni correction"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      },
      {
        "value": "RESET_BUDGET",
        "label": "Reset spec budget"
      }
    ]
  },
  "NONSTATIONARY_LEVELS_RISK": {
    "action_type": "set_stationarity_action",
    "options": [
      {
        "value": "DIFFERENCE",
        "label": "First-difference"
      },
      {
        "value": "ECM",
        "label": "Use ECM specification"
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)"
      }
    ]
  },
  "RESIDUAL_AUTOCORR_DETECTED": {
    "action_type": "set_autocorr_action",
    "options": [
      {
        "value": "INCREASE_HAC",
        "label": "Increase HAC bandwidth"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      }
    ]
  },
  "REGIME_BREAK_SUSPECTED": {
    "action_type": "set_regime_action",
    "options": [
      {
        "value": "ADD_BREAK",
        "label": "Add structural break"
      },
      {
        "value": "SPLIT_SAMPLE",
        "label": "Split sample"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      }
    ]
  },
  "LEADS_SIGNIFICANT_TIMING_FAIL": {
    "action_type": "set_timing_action",
    "options": [
      {
        "value": "BLOCK_PROPAGATION",
        "label": "Block from propagation"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat (document)"
      },
      {
        "value": "RE_ESTIMATE",
        "label": "Flag for re-estimation"
      }
    ]
  },
  "HAC_LAG_SENSITIVITY_HIGH": {
    "action_type": "set_hac_action",
    "options": [
      {
        "value": "USE_FIXED_BW",
        "label": "Fix HAC bandwidth"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      }
    ]
  },
  "SELECTION_PUBLIC_BANK_ONLY": {
    "action_type": "set_selection_action",
    "options": [
      {
        "value": "ADD_DISCLAIMER",
        "label": "Add report disclaimer"
      },
      {
        "value": "CAP_SCOPE",
        "label": "Cap counterfactual scope"
      },
      {
        "value": "ACCEPT",
        "label": "Accept as-is"
      }
    ]
  },
  "SURVIVORSHIP_BIAS_RISK": {
    "action_type": "set_survivorship_action",
    "options": [
      {
        "value": "ADD_DISCLAIMER",
        "label": "Add report disclaimer"
      },
      {
        "value": "SENSITIVITY_CHECK",
        "label": "Run sensitivity check"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      }
    ]
  },
  "COVERAGE_GAP_EXTERNAL_VALIDITY": {
    "action_type": "set_coverage_action",
    "options": [
      {
        "value": "ADD_DISCLAIMER",
        "label": "Add report disclaimer"
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat"
      }
    ]
  },
  "RATING_DIAGNOSTICS_CONFLICT": {
    "action_type": "set_rating",
    "options": [
      {
        "value": "DOWNGRADE_B",
        "label": "Downgrade to B"
      },
      {
        "value": "DOWNGRADE_C",
        "label": "Downgrade to C"
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)"
      }
    ]
  },
  "N_REPORTING_INCONSISTENT": {
    "action_type": "set_n_action",
    "options": [
      {
        "value": "FIX_REPORT",
        "label": "Fix report N"
      },
      {
        "value": "FIX_EDGECARD",
        "label": "Fix EdgeCard N_eff"
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)"
      }
    ]
  },
  "CROSS_EVIDENCE_CONFLICT": {
    "action_type": "set_conflict_action",
    "options": [
      {
        "value": "PREFER_STRUCTURAL",
        "label": "Prefer structural edge"
      },
      {
        "value": "PREFER_REDUCED",
        "label": "Prefer reduced-form edge"
      },
      {
        "value": "ACCEPT_BOTH",
        "label": "Accept both (document)"
      }
    ]
  },
  "UNIT_MISSING_IN_EDGECARD": {
    "action_type": "set_unit_action",
    "options": [
      {
        "value": "ADD_UNITS",
        "label": "Add units from spec"
      },
      {
        "value": "ACCEPT",
        "label": "Accept (not critical)"
      }
    ]
  },
  "_default": {
    "action_type": "resolve",
    "options": [
      {
        "value": "ACCEPT",
        "label": "Accept"
      },
      {
        "value": "REJECT",
        "label": "Reject"
      },
      {
        "value": "ESCALATE",
        "label": "Escalate"
      }
    ]
  }
};
const RULE_DESCRIPTIONS = {
  "ENTITY_BOUNDARY_DRIFT": "Mixing entity scopes (bank vs group) breaks comparability",
  "KPI_DEFINITION_MISMATCH_CROSS_BANK": "NPL/CoR definitions differ across banks causing sign conflicts",
  "SHOCK_CONSTRUCT_AMBIGUOUS": "EdgeCard must include shock_node_id, shock_unit, shock_scale",
  "FREQUENCY_ALIGNMENT_ERROR": "Mixing frequencies without explicit aggregation rule",
  "FREQUENCY_SCALING_MISMATCH": "Annual vs quarterly estimates not normalized to common unit",
  "EXTRACTION_PROVENANCE_GAPS": "Missing source document/page reference for extracted data",
  "REACTION_FUNCTION_EDGE": "Policy reaction edge cannot be used for shock propagation",
  "TIME_FE_ABSORBS_SHOCK": "Panel with time FE and common shock requires Exposure x Shock",
  "EXPOSURE_NOT_PREDETERMINED": "Exposure variable must be measured strictly pre-treatment",
  "MECHANICAL_EDGE_ESTIMATED": "Accounting identity should be bridge, not regression",
  "PATH_DOUBLE_COUNTING": "Direct reduced-form + indirect chain both used for propagation",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED": "Significant result but claim_level != IDENTIFIED_CAUSAL",
  "SMALL_SAMPLE_INFERENCE": "N < 30 with HAC SEs; inference fragile",
  "PANEL_TOO_FEW_UNITS": "< 5 units; cluster-robust unreliable",
  "LOO_INSTABILITY": "Leave-one-out shows sign flip or >50% magnitude change",
  "BREAKS_UNMODELED": "Regime changes not accounted for in estimation",
  "MULTIPLE_TESTING_DRIFT": "Spec search exceeded pre-registered budget",
  "NONSTATIONARY_LEVELS_RISK": "Both variables in levels and trending; require transformation or ECM",
  "RESIDUAL_AUTOCORR_DETECTED": "Serial correlation in residuals; HAC SEs may be inadequate",
  "REGIME_BREAK_SUSPECTED": "Coefficient instability across regime splits",
  "LEADS_SIGNIFICANT_TIMING_FAIL": "Effects appear before shock; reverse causation or omitted factor",
  "HAC_LAG_SENSITIVITY_HIGH": "Estimate changes materially with HAC lag length",
  "SELECTION_PUBLIC_BANK_ONLY": "Panel uses only public banks; results may not generalize to full banking sector",
  "SURVIVORSHIP_BIAS_RISK": "Sample excludes failed/merged banks; survival conditioning biases estimates",
  "COVERAGE_GAP_EXTERNAL_VALIDITY": "Sample covers <50% of system assets or <50% of institutions in target population",
  "RATING_DIAGNOSTICS_CONFLICT": "A-rating despite failed diagnostics or missing requirements",
  "N_REPORTING_INCONSISTENT": "Report N header != EdgeCard N_eff",
  "CROSS_EVIDENCE_CONFLICT": "Two edges measuring same relationship have conflicting signs",
  "UNIT_MISSING_IN_EDGECARD": "EdgeCard missing treatment_unit/outcome_unit"
};
const GENERATED_AT = "2026-02-06 16:11:07 UTC";

// Severity sort order
const SEVERITY_ORDER = {CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3};

// Known rule-specific column configs
const RULE_COLUMNS = {
    SIGNIFICANT_BUT_NOT_IDENTIFIED: {
        headers: '<th>Edge</th><th>p-value</th><th>Point (SE)</th><th>Claim</th><th>Rating</th><th>Design</th><th>Diagnostics</th><th>Action</th>',
        colspan: 8,
        renderRow: function(item, edge, actCfg, isResolved, decVal) {
            return `
                <td>
                    <span class="edge-name">${item.edge_id}</span>
                    <span class="toggle-btn" data-toggle="${item.key}">[+]</span>
                    ${edge.failure_flags && edge.failure_flags.length > 0 ?
                        '<br><span class="flag-list">' + edge.failure_flags.map(f => '<span class="flag">'+f+'</span>').join('') + '</span>' : ''}
                </td>
                <td class="mono">${fmtP(edge.pvalue)}</td>
                <td class="mono">${fmtNum(edge.point)} (${fmtNum(edge.se)})</td>
                <td><span class="claim-tag">${edge.claim_level || '--'}</span></td>
                <td><span class="rating-tag">${edge.rating || '--'}</span></td>
                <td style="font-size:10px">${edge.design || '--'}</td>
                <td style="font-size:10px">${edge.diagnostics ? diagSummary(edge.diagnostics) : '--'}</td>
                <td>${renderAction(item.key, actCfg, isResolved, decVal)}</td>
            `;
        }
    },
    RATING_DIAGNOSTICS_CONFLICT: {
        headers: '<th>Edge</th><th>Rating</th><th>Score</th><th>Failed diagnostics</th><th>N obs</th><th>Action</th>',
        colspan: 6,
        renderRow: function(item, edge, actCfg, isResolved, decVal) {
            var failedDiags = (edge.diagnostics || []).filter(function(d){return !d.passed;});
            return `
                <td>
                    <span class="edge-name">${item.edge_id}</span>
                    <span class="toggle-btn" data-toggle="${item.key}">[+]</span>
                </td>
                <td><span class="rating-tag">${edge.rating || '--'}</span></td>
                <td class="mono">${edge.score ? edge.score.toFixed(3) : '--'}</td>
                <td style="font-size:10px">${failedDiags.map(function(d){return '<span class="diag-fail">\u2717 '+d.name+'</span>';}).join(', ') || 'none'}</td>
                <td class="mono">${edge.n_obs || '--'}</td>
                <td>${renderAction(item.key, actCfg, isResolved, decVal)}</td>
            `;
        }
    },
    LOO_INSTABILITY: {
        headers: '<th>Edge</th><th>Message</th><th>N units</th><th>Rating</th><th>Score</th><th>Action</th>',
        colspan: 6,
        renderRow: function(item, edge, actCfg, isResolved, decVal) {
            var nUnits = edge.panel ? edge.panel.n_units : (edge.n_obs || '--');
            return `
                <td>
                    <span class="edge-name">${item.edge_id}</span>
                    <span class="toggle-btn" data-toggle="${item.key}">[+]</span>
                </td>
                <td style="font-size:10px;max-width:200px">${item.message}</td>
                <td class="mono">${nUnits}</td>
                <td><span class="rating-tag">${edge.rating || '--'}</span></td>
                <td class="mono">${edge.score ? edge.score.toFixed(3) : '--'}</td>
                <td>${renderAction(item.key, actCfg, isResolved, decVal)}</td>
            `;
        }
    }
};

// Default (generic) columns for unknown rules
var DEFAULT_COLUMNS = {
    headers: '<th>Edge</th><th>Message</th><th>Rating</th><th>Score</th><th>Action</th>',
    colspan: 5,
    renderRow: function(item, edge, actCfg, isResolved, decVal) {
        return `
            <td>
                <span class="edge-name">${item.edge_id}</span>
                <span class="toggle-btn" data-toggle="${item.key}">[+]</span>
            </td>
            <td style="font-size:10px;max-width:250px">${item.message}</td>
            <td><span class="rating-tag">${edge.rating || '--'}</span></td>
            <td class="mono">${edge.score ? edge.score.toFixed(3) : '--'}</td>
            <td>${renderAction(item.key, actCfg, isResolved, decVal)}</td>
        `;
    }
};

// ── State ─────────────────────────────────────────────────────────────
var decisions = {}; // key -> {value, rationale}

// ── Helpers ───────────────────────────────────────────────────────────
function extractEdgeId(issueKey) {
    var parts = issueKey.split(':');
    return parts.slice(1).join(':');
}

function fmtP(p) {
    if (p === null || p === undefined) return '--';
    if (p < 0.0001) return p.toExponential(2);
    return p.toFixed(4);
}

function fmtNum(n, decimals) {
    if (n === null || n === undefined) return '--';
    if (Math.abs(n) > 1000) return n.toFixed(1);
    if (Math.abs(n) < 0.01 && n !== 0) return n.toExponential(2);
    return n.toFixed(decimals !== undefined ? decimals : 4);
}

function diagSummary(diags) {
    var passed = diags.filter(function(d){return d.passed;}).length;
    return passed + '/' + diags.length + ' pass';
}

function diagDetail(diags) {
    return diags.map(function(d) {
        return '<span class="' + (d.passed ? 'diag-pass' : 'diag-fail') + '">' +
               (d.passed ? '\u2713' : '\u2717') + ' ' + d.name + '</span>';
    }).join(', ');
}

function renderAction(key, actCfg, isResolved, decVal) {
    var opts = '<option value="">-- select --</option>';
    if (actCfg && actCfg.options) {
        actCfg.options.forEach(function(o) {
            var sel = (isResolved && decVal === o.value) ? ' selected' : '';
            opts += '<option value="' + o.value + '"' + sel + '>' + o.label + '</option>';
        });
    }
    var rat = (decisions[key] && decisions[key].rationale) || '';
    return '<select data-key="' + key + '">' + opts + '</select>' +
           '<input type="text" data-rationale="' + key + '" placeholder="Rationale..." value="' + rat.replace(/"/g, '&quot;') + '">';
}

function updateProgress() {
    var openKeys = Object.keys(ISSUES);
    var total = openKeys.length;
    var resolved = openKeys.filter(function(k){return decisions[k] && decisions[k].value;}).length;
    var pct = total > 0 ? (resolved / total * 100) : 0;
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressLabel').textContent = resolved + ' / ' + total + ' resolved';
}

function updateStats() {
    var openKeys = Object.keys(ISSUES);
    var total = openKeys.length + CLOSED_ISSUES_COUNT;
    var sevCounts = {};
    openKeys.forEach(function(k) {
        var s = ISSUES[k].severity;
        sevCounts[s] = (sevCounts[s] || 0) + 1;
    });
    var html = '<span class="stat"><strong>' + openKeys.length + '</strong> open</span>' +
               '<span class="stat">&middot; <strong>' + CLOSED_ISSUES_COUNT + '</strong> closed</span>' +
               '<span class="stat">&middot; <strong>' + total + '</strong> total</span>' +
               '<span class="stat" style="margin-left:12px">';
    var parts = [];
    ['CRITICAL','HIGH','MEDIUM','LOW'].forEach(function(s) {
        if (sevCounts[s]) parts.push('<span class="' + s.toLowerCase() + '">' + sevCounts[s] + ' ' + s + '</span>');
    });
    html += parts.join(' &middot; ') + '</span>';
    document.getElementById('statsRow').innerHTML = html;
}

// ── Group issues by rule_id ───────────────────────────────────────────
function groupByRule() {
    var groups = {};
    for (var key in ISSUES) {
        var issue = ISSUES[key];
        var rule = issue.rule_id;
        if (!groups[rule]) groups[rule] = [];
        groups[rule].push({key: key, severity: issue.severity, rule_id: rule,
                          message: issue.message, edge_id: extractEdgeId(key)});
    }
    return groups;
}

// ── Render ────────────────────────────────────────────────────────────
function render() {
    var container = document.getElementById('sectionsContainer');
    container.innerHTML = '';
    var groups = groupByRule();

    // Populate rule filter
    var ruleFilter = document.getElementById('filterRule');
    var existingRules = [];
    for (var i = 0; i < ruleFilter.options.length; i++) existingRules.push(ruleFilter.options[i].value);
    for (var rule in groups) {
        if (existingRules.indexOf(rule) === -1) {
            var opt = document.createElement('option');
            opt.value = rule;
            opt.textContent = rule;
            ruleFilter.appendChild(opt);
        }
    }

    var sevFilter = document.getElementById('filterSeverity').value;
    var ruleFilterVal = document.getElementById('filterRule').value;
    var statusFilter = document.getElementById('filterStatus').value;

    // Sort rules: by severity of first item (CRITICAL first), then alphabetical
    var ruleKeys = Object.keys(groups);
    ruleKeys.sort(function(a, b) {
        var sevA = SEVERITY_ORDER[groups[a][0].severity] || 99;
        var sevB = SEVERITY_ORDER[groups[b][0].severity] || 99;
        if (sevA !== sevB) return sevA - sevB;
        return a.localeCompare(b);
    });

    ruleKeys.forEach(function(rule) {
        if (ruleFilterVal !== 'all' && ruleFilterVal !== rule) return;

        var items = groups[rule];

        // Apply severity filter
        if (sevFilter !== 'all') {
            items = items.filter(function(i){return i.severity === sevFilter;});
        }

        // Apply status filter
        if (statusFilter === 'pending') {
            items = items.filter(function(i){return !decisions[i.key] || !decisions[i.key].value;});
        } else if (statusFilter === 'resolved') {
            items = items.filter(function(i){return decisions[i.key] && decisions[i.key].value;});
        }

        if (items.length === 0) return;

        var severity = items[0].severity;
        var actCfg = ACTIONS_BY_RULE[rule] || ACTIONS_BY_RULE['_default'];
        var colCfg = RULE_COLUMNS[rule] || DEFAULT_COLUMNS;

        var section = document.createElement('div');
        section.className = 'section';
        section.innerHTML =
            '<div class="section-header">' +
                '<div>' +
                    '<span class="section-title">' + rule + '</span>' +
                    '<span class="severity-badge ' + severity.toLowerCase() + '">' + severity + '</span>' +
                    '<span class="section-count">' + items.length + ' edge' + (items.length !== 1 ? 's' : '') + '</span>' +
                '</div>' +
            '</div>' +
            '<div style="font-size:10px;color:#666;margin-bottom:12px">' + (RULE_DESCRIPTIONS[rule] || '') + '</div>';

        // Bulk action (for sections with >3 items)
        if (items.length > 3 && actCfg) {
            var bulk = document.createElement('div');
            bulk.className = 'bulk-action';
            var optHtml = '<option value="">-- select --</option>';
            actCfg.options.forEach(function(o) { optHtml += '<option value="' + o.value + '">' + o.label + '</option>'; });
            bulk.innerHTML =
                '<label>Bulk action:</label>' +
                '<select id="bulk-' + rule + '">' + optHtml + '</select>' +
                '<button class="btn-sm" data-rule="' + rule + '">Apply to all unresolved</button>';
            (function(r, itms) {
                bulk.querySelector('button').addEventListener('click', function() {
                    var val = document.getElementById('bulk-' + r).value;
                    if (!val) return;
                    itms.forEach(function(item) {
                        if (!decisions[item.key] || !decisions[item.key].value) {
                            decisions[item.key] = {value: val, rationale: (decisions[item.key] && decisions[item.key].rationale) || ''};
                            var sel = document.querySelector('select[data-key="' + item.key + '"]');
                            if (sel) { sel.value = val; sel.classList.add('decided'); }
                            var row = document.querySelector('tr[data-key="' + item.key + '"]');
                            if (row) row.classList.add('resolved');
                        }
                    });
                    updateProgress();
                });
            })(rule, items);
            section.appendChild(bulk);
        }

        // Build table
        var table = document.createElement('table');
        table.innerHTML = '<thead><tr>' + colCfg.headers + '</tr></thead><tbody></tbody>';
        var tbody = table.querySelector('tbody');

        items.forEach(function(item) {
            var edge = EDGES[item.edge_id] || {};
            var isResolved = decisions[item.key] && decisions[item.key].value;
            var decVal = isResolved ? decisions[item.key].value : '';
            var tr = document.createElement('tr');
            tr.setAttribute('data-key', item.key);
            if (isResolved) tr.classList.add('resolved');

            tr.innerHTML = colCfg.renderRow(item, edge, actCfg, isResolved, decVal);
            tbody.appendChild(tr);

            // Details row
            var detailTr = document.createElement('tr');
            detailTr.className = 'details-row';
            var safeId = item.key.replace(/[^a-zA-Z0-9]/g, '_');
            detailTr.innerHTML = '<td colspan="' + colCfg.colspan + '">' +
                '<div class="details-content" id="detail-' + safeId + '">' +
                    '<div class="detail-row"><span class="detail-label">Edge ID</span><span class="detail-value">' + item.edge_id + '</span></div>' +
                    '<div class="detail-row"><span class="detail-label">Design</span><span class="detail-value">' + (edge.design || '--') + '</span></div>' +
                    '<div class="detail-row"><span class="detail-label">Point (SE)</span><span class="detail-value">' + fmtNum(edge.point) + ' (' + fmtNum(edge.se) + ')</span></div>' +
                    '<div class="detail-row"><span class="detail-label">p-value</span><span class="detail-value">' + fmtP(edge.pvalue) + '</span></div>' +
                    '<div class="detail-row"><span class="detail-label">Claim level</span><span class="detail-value">' + (edge.claim_level || '--') + '</span></div>' +
                    '<div class="detail-row"><span class="detail-label">Rating / Score</span><span class="detail-value">' + (edge.rating || '--') + ' / ' + (edge.score ? edge.score.toFixed(3) : '--') + '</span></div>' +
                    '<div class="detail-row"><span class="detail-label">N obs</span><span class="detail-value">' + (edge.n_obs || '--') + '</span></div>' +
                    (edge.panel ? '<div class="detail-row"><span class="detail-label">Panel</span><span class="detail-value">' + edge.panel.n_units + ' units x ' + edge.panel.n_periods + ' periods (' + edge.panel.balance + ')</span></div>' : '') +
                    '<div class="detail-row"><span class="detail-label">All diagnostics pass</span><span class="detail-value">' + (edge.all_pass ? 'Yes' : 'No') + '</span></div>' +
                    '<div style="margin-top:4px">' + (edge.diagnostics ? diagDetail(edge.diagnostics) : '--') + '</div>' +
                    (edge.failure_flags && edge.failure_flags.length > 0 ? '<div class="detail-row" style="margin-top:4px"><span class="detail-label">Flags</span><span class="detail-value">' + edge.failure_flags.join(', ') + '</span></div>' : '') +
                    '<div class="detail-row" style="margin-top:4px"><span class="detail-label">Issue</span><span class="detail-value">' + item.message + '</span></div>' +
                '</div>' +
            '</td>';
            tbody.appendChild(detailTr);
        });

        section.appendChild(table);
        container.appendChild(section);
    });

    // Attach event listeners
    container.querySelectorAll('select[data-key]').forEach(function(sel) {
        sel.addEventListener('change', function() {
            var key = this.getAttribute('data-key');
            if (!decisions[key]) decisions[key] = {value: '', rationale: ''};
            decisions[key].value = this.value;
            var row = document.querySelector('tr[data-key="' + key + '"]');
            if (this.value) {
                this.classList.add('decided');
                if (row) row.classList.add('resolved');
            } else {
                this.classList.remove('decided');
                if (row) row.classList.remove('resolved');
            }
            updateProgress();
        });
    });

    container.querySelectorAll('input[data-rationale]').forEach(function(inp) {
        inp.addEventListener('input', function() {
            var key = this.getAttribute('data-rationale');
            if (!decisions[key]) decisions[key] = {value: '', rationale: ''};
            decisions[key].rationale = this.value;
        });
    });

    container.querySelectorAll('.toggle-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var key = this.getAttribute('data-toggle');
            var id = 'detail-' + key.replace(/[^a-zA-Z0-9]/g, '_');
            var el = document.getElementById(id);
            if (el) {
                el.classList.toggle('open');
                this.textContent = el.classList.contains('open') ? '[-]' : '[+]';
            }
        });
    });

    // Restore decided styles
    for (var key in decisions) {
        if (decisions[key].value) {
            var sel = container.querySelector('select[data-key="' + key + '"]');
            if (sel) { sel.value = decisions[key].value; sel.classList.add('decided'); }
        }
    }

    updateProgress();
}

// ── Export ────────────────────────────────────────────────────────────
document.getElementById('exportBtn').addEventListener('click', function() {
    var analystId = document.getElementById('analystId').value.trim();
    var now = new Date().toISOString();
    var decisionList = [];

    for (var key in decisions) {
        var dec = decisions[key];
        if (!dec.value) continue;
        var issue = ISSUES[key];
        var edgeId = extractEdgeId(key);
        var actCfg = ACTIONS_BY_RULE[issue.rule_id] || ACTIONS_BY_RULE['_default'];
        decisionList.push({
            issue_key: key,
            edge_id: edgeId,
            rule_id: issue.rule_id,
            action: actCfg ? actCfg.action_type : 'unknown',
            value: dec.value,
            rationale: dec.rationale || '',
            status: 'CLOSED'
        });
    }

    var output = {
        generated_at: now,
        analyst_id: analystId || 'anonymous',
        panel_built_at: GENERATED_AT,
        decisions: decisionList
    };

    var blob = new Blob([JSON.stringify(output, null, 2)], {type: 'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    var dateStr = now.slice(0,10).replace(/-/g,'');
    a.href = url;
    a.download = 'hitl_decisions_' + dateStr + '.json';
    a.click();
    URL.revokeObjectURL(url);
});

// ── Filter listeners ──────────────────────────────────────────────────
document.getElementById('filterSeverity').addEventListener('change', render);
document.getElementById('filterRule').addEventListener('change', render);
document.getElementById('filterStatus').addEventListener('change', render);

// ── Init ──────────────────────────────────────────────────────────────
updateStats();
document.getElementById('genTimestamp').textContent = 'Generated: ' + GENERATED_AT;
render();

</script>
</body>
</html>