<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kspi_k2_stress_narrative</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #fff;
            color: #000;
        }
        #graph { width: 100vw; height: 100vh; }
        .node circle {
            fill: #fff;
            stroke: #000;
            stroke-width: 1.5px;
            cursor: grab;
        }
        .node circle:hover { stroke-width: 2.5px; }
        .node circle.latent { stroke-dasharray: 4, 3; }
        .node circle.id-risk { stroke: #c00; stroke-width: 2.5px; }
        .node circle.orphan { stroke: #999; stroke-dasharray: 2, 2; fill: #f8f8f8; }
        .node text {
            font-size: 9px;
            font-weight: 400;
            pointer-events: none;
            text-anchor: middle;
        }
        .link {
            fill: none;
            stroke-opacity: 0.7;
        }
        .link:hover { stroke-opacity: 1; stroke-width: 3px !important; }
        .link.null { stroke-dasharray: 4, 3; stroke-opacity: 0.4; }
        .link.critical-issue { stroke: #f59e0b; stroke-width: 3px; }
        .label-bg {
            fill: white;
            stroke: none;
        }
        .link-label {
            font-size: 9px;
            font-weight: 500;
            fill: #333;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: middle;
        }
        .tooltip {
            position: absolute;
            background: #fff;
            border: 1px solid #000;
            padding: 12px 16px;
            font-size: 11px;
            pointer-events: none;
            opacity: 0;
            max-width: 380px;
            line-height: 1.5;
            z-index: 1000;
        }
        .tooltip.visible { opacity: 1; }
        .tooltip h3 { font-size: 12px; font-weight: 600; margin-bottom: 8px; border-bottom: 1px solid #000; padding-bottom: 6px; }
        .tooltip-row { display: flex; justify-content: space-between; margin: 3px 0; gap: 12px; }
        .tooltip-label { color: #666; white-space: nowrap; }
        .tooltip-value { font-weight: 500; font-variant-numeric: tabular-nums; text-align: right; }
        .tooltip-value.null { color: #999; }
        .tooltip-annotation { margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; color: #444; font-style: italic; }
        .tooltip-issues { margin-top: 6px; padding-top: 6px; border-top: 1px solid #eee; }
        .tooltip-issue { font-size: 10px; margin: 2px 0; }
        .tooltip-issue.critical { color: #c00; font-weight: 600; }
        .tooltip-issue.high { color: #a16207; }
        .tooltip-orphan { margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; }
        .tooltip-orphan-tag {
            display: inline-block; font-size: 9px; font-weight: 600;
            padding: 1px 5px; background: #f8f8f8; border: 1px solid #999;
            color: #666; margin-bottom: 6px;
        }
        .tooltip-orphan-section {
            padding: 4px 6px; margin-bottom: 3px; font-size: 10px; line-height: 1.5;
        }
        .tooltip-orphan-section.role { background: #f8f8f8; }
        .tooltip-orphan-section.blocker { background: #fff5f5; }
        .tooltip-orphan-section.path-forward { background: #f0f4ff; }
        .tooltip-orphan-label {
            font-weight: 600; font-size: 9px; text-transform: uppercase;
            letter-spacing: 0.3px; margin-bottom: 1px;
        }
        .tooltip-orphan-section.role .tooltip-orphan-label { color: #444; }
        .tooltip-orphan-section.blocker .tooltip-orphan-label { color: #c00; }
        .tooltip-orphan-section.path-forward .tooltip-orphan-label { color: #1e40af; }

        /* Proposal banner */
        .proposal-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 36px;
            background: #000;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            z-index: 200;
            letter-spacing: 0.5px;
        }
        .banner-sub {
            font-weight: 400;
            font-size: 10px;
            color: #aaa;
        }

        .controls {
            position: fixed;
            top: 50px;
            left: 20px;
            font-size: 11px;
            background: rgba(255,255,255,0.95);
            padding: 16px;
            border: 1px solid #000;
            z-index: 100;
            max-width: 220px;
        }
        .controls h1 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .controls .subtitle { color: #666; margin-bottom: 12px; font-size: 10px; }
        .control-row { margin: 8px 0; }
        .control-row label { color: #666; margin-right: 8px; }
        .control-row select {
            border: 1px solid #000;
            background: #fff;
            padding: 4px 8px;
            font-size: 11px;
            font-family: inherit;
        }
        .legend { margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd; }
        .legend-title { font-weight: 600; font-size: 10px; margin-bottom: 6px; }
        .legend-item { display: flex; align-items: center; margin: 4px 0; font-size: 10px; }
        .legend-line { width: 20px; height: 2px; margin-right: 8px; }
        .legend-line.dashed { border-top: 2px dashed; height: 0; }
        .stats {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 10px;
            color: #666;
        }
        .stats span { margin-right: 16px; }
        .stats strong { color: #000; }

        /* Pitfall sidebar */
        .pitfall-sidebar {
            position: fixed;
            top: 50px;
            right: 20px;
            width: 340px;
            max-height: calc(100vh - 70px);
            overflow-y: auto;
            background: rgba(255,255,255,0.95);
            border: 1px solid #000;
            font-size: 11px;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .pitfall-header {
            padding: 12px 16px 8px;
            border-bottom: 1px solid #ddd;
        }
        .pitfall-header h2 { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
        .pitfall-progress { margin-bottom: 4px; }
        .pitfall-progress-bar {
            width: 100%;
            height: 6px;
            border: 1px solid #000;
            background: #fff;
        }
        .pitfall-progress-fill {
            height: 100%;
            background: #000;
            transition: width 0.3s;
        }
        .pitfall-progress-label {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }
        #pitfallList {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px;
        }
        .pitfall-item {
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .pitfall-item:last-child { border-bottom: none; }
        .pitfall-item:hover { background: #f8f8f8; }
        .pitfall-item.active {
            background: #f0f4ff;
        }
        .pitfall-item.resolved {
            opacity: 0.5;
        }
        .pitfall-item.resolved .pitfall-msg { text-decoration: line-through; }
        .pitfall-item-header {
            padding: 8px 0 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .pitfall-edge { font-weight: 600; font-size: 10px; }
        .pitfall-severity { font-size: 9px; font-weight: 600; padding: 1px 5px; border: 1px solid; display: inline-block; }
        .pitfall-severity.CRITICAL { background: #000; color: #fff; border-color: #000; }
        .pitfall-severity.HIGH { background: #fff; color: #000; border-color: #000; }
        .pitfall-severity.MEDIUM { background: #eee; color: #000; border-color: #ccc; }
        .pitfall-severity.LOW { background: #fff; color: #999; border-color: #ccc; }
        .pitfall-resolved-check { color: #080; font-weight: 700; font-size: 11px; display: none; }
        .pitfall-item.resolved .pitfall-resolved-check { display: inline; }
        .pitfall-msg { font-size: 10px; color: #555; margin-bottom: 4px; }
        .pitfall-empty { color: #999; font-style: italic; padding: 12px 0; }

        /* Collapsible decision panel */
        .pitfall-decision {
            display: none;
            padding: 8px 0 10px;
            border-top: 1px solid #eee;
            font-size: 10px;
            line-height: 1.6;
        }
        .pitfall-decision.open { display: block; }
        .pitfall-decision .pd-label {
            font-weight: 600;
            color: #444;
            margin-top: 6px;
            margin-bottom: 2px;
        }
        .pitfall-decision .pd-text {
            color: #555;
            margin-bottom: 4px;
        }
        .pitfall-decision .pd-guidance {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 4px 8px;
            margin-bottom: 6px;
        }
        .pitfall-decision select {
            width: 100%;
            border: 1px solid #000;
            background: #fff;
            padding: 3px 6px;
            font-size: 10px;
            font-family: inherit;
        }
        .pitfall-decision select.decided {
            background: #000;
            color: #fff;
        }
        .pitfall-decision .pd-tooltip-area {
            font-size: 9px;
            color: #666;
            min-height: 14px;
            margin-top: 2px;
            padding: 2px 4px;
            background: #fafafa;
            border: 1px solid #eee;
        }
        .pitfall-decision input[type="text"] {
            width: 100%;
            border: 1px solid #ccc;
            padding: 3px 6px;
            font-size: 10px;
            font-family: inherit;
            margin-top: 4px;
        }
        .pitfall-decision input[type="text"]:focus {
            border-color: #000;
            outline: none;
        }
        .pitfall-decision .pd-llm-guidance {
            margin-bottom: 6px;
            font-size: 10px;
            line-height: 1.6;
            color: #333;
        }
        .pitfall-decision .pd-llm-guidance-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 4px;
            font-size: 10px;
        }
        .pd-section {
            padding: 5px 8px;
            margin-bottom: 4px;
            font-size: 10px;
            line-height: 1.6;
        }
        .pd-section-label {
            font-weight: 600;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 1px;
        }
        .pd-section.finding {
            background: #f8f8f8;
        }
        .pd-section.finding .pd-section-label { color: #444; }
        .pd-section.concern {
            background: #fffbf0;
        }
        .pd-section.concern .pd-section-label { color: #7a6400; }
        .pd-section.recommendation {
            background: #f0f4ff;
        }
        .pd-section.recommendation .pd-section-label { color: #1e40af; }
        .pd-static-ref { font-size: 9px; color: #888; margin-bottom: 4px; }
        .pd-static-ref summary { cursor: pointer; font-weight: 500; }
        .pitfall-decision .pd-buttons {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }
        .pitfall-decision .pd-btn {
            border: 1px solid #000;
            background: #fff;
            padding: 3px 12px;
            font-size: 10px;
            font-family: inherit;
            cursor: pointer;
        }
        .pitfall-decision .pd-btn:hover { background: #000; color: #fff; }
        .pitfall-decision .pd-btn.pd-btn-confirm { background: #000; color: #fff; }
        .pitfall-decision .pd-btn.pd-btn-confirm:hover { background: #333; }

        /* Sidebar footer */
        .pitfall-footer {
            padding: 10px 16px;
            border-top: 1px solid #000;
        }
        .pitfall-footer label {
            font-size: 10px;
            color: #666;
            display: block;
            margin-bottom: 4px;
        }
        .pitfall-footer input[type="text"] {
            width: 100%;
            border: 1px solid #000;
            padding: 4px 8px;
            font-size: 10px;
            font-family: inherit;
            margin-bottom: 6px;
        }
        .pitfall-footer .btn-export {
            width: 100%;
            border: 1px solid #000;
            background: #000;
            color: #fff;
            padding: 5px 12px;
            font-size: 11px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }
        .pitfall-footer .btn-export:hover { background: #333; }

        /* Clean edge entries (no issues) */
        .pitfall-divider {
            padding: 8px 0 4px;
            font-size: 10px;
            font-weight: 600;
            color: #999;
            border-top: 1px solid #ddd;
            margin-top: 4px;
        }
        .pitfall-item.clean-edge .pitfall-rating {
            font-size: 9px;
            font-weight: 600;
            padding: 1px 5px;
            border: 1px solid #059669;
            color: #059669;
            display: inline-block;
        }
        .pitfall-item.clean-edge .pitfall-stats {
            font-size: 9px;
            color: #888;
            margin-bottom: 4px;
        }

        /* Edge highlight animation */
        @keyframes edgeFlash {
            0%, 100% { stroke-opacity: 1; }
            50% { stroke-opacity: 0.3; }
        }
        .link.highlighted {
            stroke: #2563eb !important;
            stroke-width: 4px !important;
            stroke-opacity: 1;
            animation: edgeFlash 1s ease-in-out 3;
        }
        .link.edge-resolved {
            stroke-dasharray: 6, 4;
            stroke-opacity: 0.3;
            stroke-width: 1px !important;
        }

        /* Identification badges */
        .id-badge {
            display: inline-block;
            font-size: 8px;
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 2px;
            letter-spacing: 0.3px;
            margin-left: 4px;
            vertical-align: middle;
        }
        .id-badge.STRONG { background: #059669; color: #fff; }
        .id-badge.MODERATE { background: #2563eb; color: #fff; }
        .id-badge.WEAK { background: #d97706; color: #fff; }
        .id-badge.ABSENT { background: #dc2626; color: #fff; }
        .strategy-tag {
            display: inline-block;
            font-size: 8px;
            font-weight: 500;
            padding: 1px 4px;
            border: 1px solid #ccc;
            color: #555;
            margin-left: 4px;
            vertical-align: middle;
        }
        /* Provenance badges */
        .provenance-badge {
            display: inline-block;
            font-size: 8px;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 2px;
            letter-spacing: 0.3px;
            margin-left: 4px;
            vertical-align: middle;
            color: #fff;
        }
        .provenance-badge.manual { background: #6b7280; }
        .provenance-badge.paper_scout { background: #0d9488; }
        .provenance-badge.data_scout { background: #4f46e5; }
        .provenance-badge.discovery_agent { background: #ea580c; }
        /* Causal assessment section in sidebar */
        .causal-assessment {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #eee;
            font-size: 10px;
            line-height: 1.6;
        }
        .causal-assessment-title {
            font-weight: 600;
            color: #059669;
            margin-bottom: 4px;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <div class="proposal-banner">
        DRAFT PROPOSAL &mdash; Requires analyst review before use
        <span class="banner-sub">Resolve flagged issues or export decisions to proceed</span>
    </div>
    <svg id="graph"></svg>
    <div class="controls">
        <h1 id="dagTitle">kspi_k2_stress_narrative</h1>
        <div class="subtitle" id="dagSubtitle"></div>
        <div class="control-row">
            <label>Edge type</label>
            <select id="typeFilter">
                <option value="all">All</option>
            </select>
        </div>
        <div class="control-row">
            <label>Rating</label>
            <select id="ratingFilter">
                <option value="all">All</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
            </select>
        </div>
        <div class="control-row">
            <label><input type="checkbox" id="showNull" checked> Show null</label>
        </div>
        <div class="control-row">
            <label><input type="checkbox" id="showLabels" checked> Show labels</label>
        </div>
        <div class="legend" id="legendContainer">
            <div class="legend-title">Edge Types</div>
        </div>
    </div>
    <div class="stats">
        <span>Edges: <strong id="statEdges">0</strong></span>
        <span>Nodes: <strong id="statNodes">0</strong></span>
        <span>A: <strong id="statA">0</strong></span>
        <span>B: <strong id="statB">0</strong></span>
        <span>C: <strong id="statC">0</strong></span>
        <span>Issues: <strong id="statIssues">0</strong></span>
        <span>Identified: <strong id="statIdentified">0</strong></span>
    </div>
    <div class="pitfall-sidebar" id="pitfallSidebar">
        <div class="pitfall-header">
            <h2>Open Issues</h2>
            <div class="pitfall-progress">
                <div class="pitfall-progress-bar"><div class="pitfall-progress-fill" id="pitfallProgressFill"></div></div>
                <div class="pitfall-progress-label" id="pitfallProgressLabel">0 / 0 resolved</div>
            </div>
        </div>
        <div id="pitfallList"></div>
        <div class="pitfall-footer">
            <label>Analyst ID</label>
            <input type="text" id="analystId" placeholder="Your name or initials">
            <button class="btn-export" id="exportBtn">Export Decisions</button>
        </div>
    </div>
    <div class="tooltip" id="tooltip"></div>

    <script>
// ── INJECTED DATA ────────────────────────────────────────────────────────
const NODES = [
  {
    "id": "E_import_share",
    "label": "Pre-period import share",
    "description": "Pre-period regional import intensity (static exposure).",
    "unit": "share",
    "frequency": "static",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "cor_kspi",
    "label": "KSPI cost of risk",
    "description": "Kaspi.kz cost of risk (annualized provisions / avg loans).",
    "unit": "pct",
    "frequency": "quarterly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "cpi_headline",
    "label": "Headline CPI",
    "description": "Kazakhstan headline CPI index, log level.",
    "unit": "log",
    "frequency": "monthly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "cpi_nontradable",
    "label": "Non-tradable CPI",
    "description": "CPI for non-tradable goods (services). Block A falsification.",
    "unit": "log",
    "frequency": "monthly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "cpi_tradable",
    "label": "Tradable CPI",
    "description": "CPI for tradable goods (import-weighted). Block A validated.",
    "unit": "log",
    "frequency": "monthly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "deposit_cost_kspi",
    "label": "KSPI deposit cost",
    "description": "Kaspi.kz average deposit rate.",
    "unit": "pct",
    "frequency": "quarterly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "imported_inflation_instrument",
    "label": "Imported inflation IV",
    "description": "Constructed instrument for imported inflation (FX change \u00d7 pre-period import share).",
    "unit": "pct",
    "frequency": "monthly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "k2_ratio_kspi",
    "label": "KSPI K2 capital ratio",
    "description": "Kaspi.kz K2 capital adequacy ratio (Total Capital / RWA).",
    "unit": "pct",
    "frequency": "quarterly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "kzt_usd",
    "label": "KZT/USD exchange rate",
    "description": "Kazakh tenge per US dollar, log level.",
    "unit": "log",
    "frequency": "daily",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "nominal_expenditure",
    "label": "Nominal consumption expenditure",
    "description": "Household nominal consumption expenditure. Block F validated.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "nominal_income",
    "label": "Nominal monetary income",
    "description": "Regional household nominal monetary income. Block B validated.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "ppop_kspi",
    "label": "KSPI pre-provision operating profit",
    "description": "Kaspi.kz PPOP (revenue - opex, before provisions).",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "real_expenditure",
    "label": "Real consumption expenditure",
    "description": "Nominal expenditure deflated by CPI. Block F validated.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "real_income",
    "label": "Real monetary income",
    "description": "Nominal income deflated by CPI. Identity node.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "rwa_kspi",
    "label": "KSPI risk-weighted assets",
    "description": "Kaspi.kz risk-weighted assets for regulatory capital.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "total_capital_kspi",
    "label": "KSPI total capital",
    "description": "Kaspi.kz total regulatory capital (Tier 1 + Tier 2).",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "transfer_income",
    "label": "Transfer income",
    "description": "Household income from government transfers.",
    "unit": "log",
    "frequency": "quarterly",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  },
  {
    "id": "vix_shock",
    "label": "VIX shock",
    "description": "Innovation in VIX (risk aversion shock).",
    "unit": "innovation",
    "frequency": "daily",
    "observed": true,
    "latent": false,
    "orphan": false,
    "provenance_source": ""
  }
];
const EDGES = [
  {
    "id": "kzt_usd_to_cpi_tradable",
    "source": "kzt_usd",
    "target": "cpi_tradable",
    "edge_type": "immutable",
    "expected_sign": "positive",
    "interpretation": "Differential inflation response by import intensity",
    "notes": "Block A validated result: 11.3% FX pass-through to tradable CPI.",
    "provenance_source": "",
    "provenance_detail": "",
    "point": 0.0001308707005012602,
    "se": 7.462327268926213e-05,
    "pvalue": 0.07947304146889873,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.97,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      },
      {
        "name": "ts_leads_test",
        "passed": true
      },
      {
        "name": "ts_residual_autocorr",
        "passed": true
      },
      {
        "name": "ts_hac_sensitivity",
        "passed": true
      },
      {
        "name": "ts_lag_sensitivity",
        "passed": true
      },
      {
        "name": "ts_regime_stability",
        "passed": true
      },
      {
        "name": "ts_shock_support",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Design LOCAL_PROJECTIONS provides REDUCED_FORM level only",
    "n_obs": 186,
    "strategy_type": "",
    "strategy_argument": "",
    "strategy_key_assumption": "",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "kzt_usd_to_cpi_nontradable",
    "source": "kzt_usd",
    "target": "cpi_nontradable",
    "edge_type": "immutable",
    "expected_sign": "any",
    "interpretation": "Falsification test for FX pass-through",
    "notes": "Block A falsification: Near-zero pass-through to non-tradable CPI.",
    "provenance_source": "",
    "provenance_detail": "",
    "point": 7.680517172265832e-05,
    "se": 3.3801146890145904e-05,
    "pvalue": 0.023070493914662118,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.97,
    "claim_level": "REDUCED_FORM",
    "all_pass": true,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      },
      {
        "name": "ts_leads_test",
        "passed": true
      },
      {
        "name": "ts_residual_autocorr",
        "passed": true
      },
      {
        "name": "ts_hac_sensitivity",
        "passed": true
      },
      {
        "name": "ts_lag_sensitivity",
        "passed": true
      },
      {
        "name": "ts_regime_stability",
        "passed": true
      },
      {
        "name": "ts_shock_support",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Design LOCAL_PROJECTIONS provides REDUCED_FORM level only",
    "n_obs": 186,
    "strategy_type": "",
    "strategy_argument": "",
    "strategy_key_assumption": "",
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:kzt_usd_to_cpi_nontradable",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0231 but claim_level=REDUCED_FORM. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "imported_inflation_instrument_to_real_income",
    "source": "imported_inflation_instrument",
    "target": "real_income",
    "edge_type": "causal",
    "expected_sign": "any",
    "interpretation": "",
    "notes": "NL-extracted: Imported inflation induced by exchange-rate depreciation-&gt;Households&#x27; purchasing power (negative)",
    "provenance_source": "",
    "provenance_detail": "",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "cpi_headline_to_real_income",
    "source": "cpi_headline",
    "target": "real_income",
    "edge_type": "causal",
    "expected_sign": "any",
    "interpretation": "",
    "notes": "NL-extracted: Imported inflation (price level increase) with sticky incomes-&gt;Real disposable income (negative)",
    "provenance_source": "",
    "provenance_detail": "",
    "point": 0.0,
    "se": 0.0,
    "pvalue": null,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.6300000000000001,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "sign_consistency",
        "passed": true
      },
      {
        "name": "ts_hac_sensitivity",
        "passed": true
      },
      {
        "name": "ts_regime_stability",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Design LOCAL_PROJECTIONS provides REDUCED_FORM level only",
    "n_obs": 0,
    "strategy_type": "",
    "strategy_argument": "",
    "strategy_key_assumption": "",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "imported_inflation_instrument_to_real_expenditure_negative",
    "source": "imported_inflation_instrument",
    "target": "real_expenditure",
    "edge_type": "causal",
    "expected_sign": "any",
    "interpretation": "",
    "notes": "NL-extracted: Imported inflation (price level increase) with sticky incomes-&gt;Real household spending (consumption) (negative)",
    "provenance_source": "",
    "provenance_detail": "",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "transfer_income_to_nominal_income_buffering",
    "source": "transfer_income",
    "target": "nominal_income",
    "edge_type": "causal",
    "expected_sign": "any",
    "interpretation": "",
    "notes": "NL-extracted: Transfers and regulated prices (buffers) during exchange-rate/price shock-&gt;Headline nominal income stability (positive)",
    "provenance_source": "",
    "provenance_detail": "",
    "point": 0.0,
    "se": 0.0,
    "pvalue": null,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.6300000000000001,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "sign_consistency",
        "passed": true
      },
      {
        "name": "ts_hac_sensitivity",
        "passed": true
      },
      {
        "name": "ts_regime_stability",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Design LOCAL_PROJECTIONS provides REDUCED_FORM level only",
    "n_obs": 0,
    "strategy_type": "",
    "strategy_argument": "",
    "strategy_key_assumption": "",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "real_income_to_cor_kspi",
    "source": "real_income",
    "target": "cor_kspi",
    "edge_type": "causal",
    "expected_sign": "any",
    "interpretation": "",
    "notes": "NL-extracted: Household purchasing-power squeeze (real income/spending softening)-&gt;Kaspi balance-sheet pressure (positive); Household squeeze / reduced purchasing power-&gt;Repayment stress (delinquencies and provisions) (positive); Deterioration in macro conditions / household squeeze (stress)-&gt;Increase in &#x27;macro provisioning&#x27; ahead of realized defaults (positive)",
    "provenance_source": "",
    "provenance_detail": "",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "vix_shock_to_deposit_cost_kspi",
    "source": "vix_shock",
    "target": "deposit_cost_kspi",
    "edge_type": "causal",
    "expected_sign": "any",
    "interpretation": "",
    "notes": "NL-extracted: Tighter financial conditions-&gt;Kaspi funding costs (positive)",
    "provenance_source": "",
    "provenance_detail": "",
    "point": 0.013267925068563167,
    "se": 0.034509957033544404,
    "pvalue": 0.7006326632381366,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.6111111111111112,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      },
      {
        "name": "ts_leads_test",
        "passed": true
      },
      {
        "name": "ts_residual_autocorr",
        "passed": true
      },
      {
        "name": "ts_hac_sensitivity",
        "passed": true
      },
      {
        "name": "ts_lag_sensitivity",
        "passed": false
      },
      {
        "name": "ts_regime_stability",
        "passed": false
      },
      {
        "name": "ts_shock_support",
        "passed": true
      }
    ],
    "failure_flags": [
      "regime_break_detected",
      "small_sample"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Counterfactual Use: BLOCKED\nReason: regime break risk\n\nEven if p<0.05, this does not establish a causal effect.",
    "n_obs": 25,
    "strategy_type": "",
    "strategy_argument": "",
    "strategy_key_assumption": "",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "vix_shock_to_ppop_kspi",
    "source": "vix_shock",
    "target": "ppop_kspi",
    "edge_type": "causal",
    "expected_sign": "any",
    "interpretation": "",
    "notes": "NL-extracted: Tighter financial conditions-&gt;Kaspi interest margins (profit margins) (negative)",
    "provenance_source": "",
    "provenance_detail": "",
    "point": -0.026254179640865256,
    "se": 0.015522315437371705,
    "pvalue": 0.09076368696029093,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.6955555555555556,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "sign_consistency",
        "passed": true
      },
      {
        "name": "ts_leads_test",
        "passed": true
      },
      {
        "name": "ts_residual_autocorr",
        "passed": true
      },
      {
        "name": "ts_hac_sensitivity",
        "passed": true
      },
      {
        "name": "ts_lag_sensitivity",
        "passed": true
      },
      {
        "name": "ts_regime_stability",
        "passed": true
      },
      {
        "name": "ts_shock_support",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Design LOCAL_PROJECTIONS provides REDUCED_FORM level only",
    "n_obs": 15,
    "strategy_type": "",
    "strategy_argument": "",
    "strategy_key_assumption": "",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "ppop_kspi_to_total_capital_kspi",
    "source": "ppop_kspi",
    "target": "total_capital_kspi",
    "edge_type": "mechanical",
    "expected_sign": "any",
    "interpretation": "",
    "notes": "NL-extracted: Profits and provisions dynamics-&gt;Kaspi capital headroom (capital numerator) (ambiguous)",
    "provenance_source": "",
    "provenance_detail": "",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "rwa_kspi_to_k2_ratio_kspi",
    "source": "rwa_kspi",
    "target": "k2_ratio_kspi",
    "edge_type": "identity",
    "expected_sign": "any",
    "interpretation": "K2 identity: Capital / RWA",
    "notes": "K2 = Total Capital / RWA. Mechanical identity.",
    "provenance_source": "",
    "provenance_detail": "",
    "point": -0.006058255436425573,
    "se": 0.002047730679385075,
    "pvalue": 0.003091185818188935,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.7155555555555556,
    "claim_level": "BLOCKED_ID",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      },
      {
        "name": "ts_leads_test",
        "passed": false
      },
      {
        "name": "ts_residual_autocorr",
        "passed": true
      },
      {
        "name": "ts_hac_sensitivity",
        "passed": true
      },
      {
        "name": "ts_lag_sensitivity",
        "passed": true
      },
      {
        "name": "ts_regime_stability",
        "passed": true
      },
      {
        "name": "ts_shock_support",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Shock CF requires REDUCED_FORM+, edge has BLOCKED_ID",
    "n_obs": 25,
    "strategy_type": "",
    "strategy_argument": "",
    "strategy_key_assumption": "",
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:rwa_kspi_to_k2_ratio_kspi",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0031 but claim_level=BLOCKED_ID. Significance does not establish causation."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "real_expenditure_to_ppop_kspi",
    "source": "real_expenditure",
    "target": "ppop_kspi",
    "edge_type": "causal",
    "expected_sign": "any",
    "interpretation": "",
    "notes": "NL-extracted: Consumer spending holding up during stress-&gt;Non-bank revenues and dividends (holding company support capacity) (positive)",
    "provenance_source": "",
    "provenance_detail": "",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "kzt_usd_to_imported_inflation_instrument",
    "source": "kzt_usd",
    "target": "imported_inflation_instrument",
    "edge_type": "identity",
    "expected_sign": "",
    "interpretation": "Identity component: imported_inflation_iv",
    "notes": "Auto-created identity edge from imported_inflation_iv",
    "provenance_source": "",
    "provenance_detail": "",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "e_import_share_to_imported_inflation_instrument",
    "source": "E_import_share",
    "target": "imported_inflation_instrument",
    "edge_type": "identity",
    "expected_sign": "",
    "interpretation": "Identity component of imported inflation IV construction",
    "notes": "Static exposure weight in IV construction. Formula component.",
    "provenance_source": "manual",
    "provenance_detail": "",
    "strategy_type": "accounting_identity",
    "strategy_argument": "IV = diff(log(kzt_usd)) * E_import_share is a deterministic construction.",
    "strategy_key_assumption": "Pre-period import shares are fixed exposure weights.",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "total_capital_kspi_to_k2_ratio_kspi",
    "source": "total_capital_kspi",
    "target": "k2_ratio_kspi",
    "edge_type": "identity",
    "expected_sign": "",
    "interpretation": "K2 identity: Capital / RWA",
    "notes": "K2 = Total Capital / RWA. Mechanical identity.",
    "provenance_source": "manual",
    "provenance_detail": "",
    "strategy_type": "accounting_identity",
    "strategy_argument": "K2 = Total Capital / RWA is a regulatory definition.",
    "strategy_key_assumption": "Regulatory definition is stable over the sample period.",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "nominal_expenditure_to_real_expenditure",
    "source": "nominal_expenditure",
    "target": "real_expenditure",
    "edge_type": "identity",
    "expected_sign": "",
    "interpretation": "Identity component of real expenditure deflation",
    "notes": "Nominal-to-real deflation identity. Formula component.",
    "provenance_source": "manual",
    "provenance_detail": "",
    "strategy_type": "accounting_identity",
    "strategy_argument": "real_expenditure = log(nominal_expenditure) - log(cpi_headline) is a deflation identity.",
    "strategy_key_assumption": "CPI is the appropriate deflator for household consumption.",
    "point": 0.0,
    "se": 0.0,
    "pvalue": null,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.6300000000000001,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": false
      },
      {
        "name": "sign_consistency",
        "passed": true
      },
      {
        "name": "ts_hac_sensitivity",
        "passed": true
      },
      {
        "name": "ts_regime_stability",
        "passed": true
      }
    ],
    "failure_flags": [
      "small_sample"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Design LOCAL_PROJECTIONS provides REDUCED_FORM level only",
    "n_obs": 0,
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "cpi_headline_to_real_expenditure",
    "source": "cpi_headline",
    "target": "real_expenditure",
    "edge_type": "identity",
    "expected_sign": "",
    "interpretation": "Identity component: real_expenditure_identity",
    "notes": "Auto-created identity edge from real_expenditure_identity",
    "provenance_source": "",
    "provenance_detail": "",
    "point": 0.8689514450133883,
    "se": 1.8932045762536065,
    "pvalue": 0.6462453388638387,
    "design": "LOCAL_PROJECTIONS",
    "rating": "B",
    "score": 0.7291111111111112,
    "claim_level": "REDUCED_FORM",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      },
      {
        "name": "ts_leads_test",
        "passed": true
      },
      {
        "name": "ts_residual_autocorr",
        "passed": true
      },
      {
        "name": "ts_hac_sensitivity",
        "passed": true
      },
      {
        "name": "ts_lag_sensitivity",
        "passed": false
      },
      {
        "name": "ts_regime_stability",
        "passed": false
      },
      {
        "name": "ts_shock_support",
        "passed": true
      }
    ],
    "failure_flags": [
      "regime_break_detected"
    ],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Counterfactual Use: BLOCKED\nReason: regime break risk\n\nEven if p<0.05, this does not establish a causal effect.",
    "n_obs": 54,
    "strategy_type": "",
    "strategy_argument": "",
    "strategy_key_assumption": "",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "nominal_income_to_real_income",
    "source": "nominal_income",
    "target": "real_income",
    "edge_type": "identity",
    "expected_sign": "",
    "interpretation": "Identity component: real_income_identity",
    "notes": "Auto-created identity edge from real_income_identity",
    "provenance_source": "",
    "provenance_detail": "",
    "point": 0.9330544195797443,
    "se": 0.02770422400969326,
    "pvalue": 1.1680567298440232e-248,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.8375555555555555,
    "claim_level": "BLOCKED_ID",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      },
      {
        "name": "ts_leads_test",
        "passed": false
      },
      {
        "name": "ts_residual_autocorr",
        "passed": true
      },
      {
        "name": "ts_hac_sensitivity",
        "passed": true
      },
      {
        "name": "ts_lag_sensitivity",
        "passed": true
      },
      {
        "name": "ts_regime_stability",
        "passed": true
      },
      {
        "name": "ts_shock_support",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Shock CF requires REDUCED_FORM+, edge has BLOCKED_ID",
    "n_obs": 56,
    "strategy_type": "",
    "strategy_argument": "",
    "strategy_key_assumption": "",
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:nominal_income_to_real_income",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0000 but claim_level=BLOCKED_ID. Significance does not establish causation."
      },
      {
        "issue_key": "RATING_DIAGNOSTICS_CONFLICT:nominal_income_to_real_income",
        "rule_id": "RATING_DIAGNOSTICS_CONFLICT",
        "severity": "HIGH",
        "message": "A-rating despite failed diagnostics."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "cor_kspi_to_total_capital_kspi",
    "source": "cor_kspi",
    "target": "total_capital_kspi",
    "edge_type": "mechanical",
    "expected_sign": "negative",
    "interpretation": "Capital impact from provisioning",
    "notes": "Provisioning reduces capital. Control for PPOP.",
    "provenance_source": "manual",
    "provenance_detail": "",
    "strategy_type": "accounting_identity",
    "strategy_argument": "Provisions directly reduce retained earnings and thus regulatory capital.",
    "strategy_key_assumption": "IFRS accounting rules mechanically link provisions to capital.",
    "issues": [],
    "has_critical_issue": false
  },
  {
    "id": "cpi_nontradable_to_cpi_headline",
    "source": "cpi_nontradable",
    "target": "cpi_headline",
    "edge_type": "identity",
    "expected_sign": "",
    "interpretation": "Aggregation/measurement bridge: cpi_nontradable feeds cpi_headline",
    "notes": "Auto-bridged: cpi_nontradable was unreachable from target. Connected to cpi_headline by tag similarity (shared: [&#x27;inflation&#x27;, &#x27;prices&#x27;]).",
    "provenance_source": "",
    "provenance_detail": "",
    "point": 0.722095626287286,
    "se": 0.22687975273453517,
    "pvalue": 0.0014589663178228855,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.9255555555555555,
    "claim_level": "BLOCKED_ID",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      },
      {
        "name": "ts_leads_test",
        "passed": false
      },
      {
        "name": "ts_residual_autocorr",
        "passed": true
      },
      {
        "name": "ts_hac_sensitivity",
        "passed": true
      },
      {
        "name": "ts_lag_sensitivity",
        "passed": true
      },
      {
        "name": "ts_regime_stability",
        "passed": true
      },
      {
        "name": "ts_shock_support",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Shock CF requires REDUCED_FORM+, edge has BLOCKED_ID",
    "n_obs": 176,
    "strategy_type": "",
    "strategy_argument": "",
    "strategy_key_assumption": "",
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:cpi_nontradable_to_cpi_headline",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0015 but claim_level=BLOCKED_ID. Significance does not establish causation."
      },
      {
        "issue_key": "RATING_DIAGNOSTICS_CONFLICT:cpi_nontradable_to_cpi_headline",
        "rule_id": "RATING_DIAGNOSTICS_CONFLICT",
        "severity": "HIGH",
        "message": "A-rating despite failed diagnostics."
      }
    ],
    "has_critical_issue": true
  },
  {
    "id": "cpi_tradable_to_cpi_headline",
    "source": "cpi_tradable",
    "target": "cpi_headline",
    "edge_type": "identity",
    "expected_sign": "",
    "interpretation": "Aggregation/measurement bridge: cpi_tradable feeds cpi_headline",
    "notes": "Auto-bridged: cpi_tradable was unreachable from target. Connected to cpi_headline by tag similarity (shared: [&#x27;inflation&#x27;, &#x27;prices&#x27;]).",
    "provenance_source": "",
    "provenance_detail": "",
    "point": 0.761814289462254,
    "se": 0.043327155866326385,
    "pvalue": 3.334696254595197e-69,
    "design": "LOCAL_PROJECTIONS",
    "rating": "A",
    "score": 0.9255555555555555,
    "claim_level": "BLOCKED_ID",
    "all_pass": false,
    "diagnostics": [
      {
        "name": "hac_bandwidth",
        "passed": true
      },
      {
        "name": "effective_obs",
        "passed": true
      },
      {
        "name": "sign_consistency",
        "passed": true
      },
      {
        "name": "ts_leads_test",
        "passed": false
      },
      {
        "name": "ts_residual_autocorr",
        "passed": true
      },
      {
        "name": "ts_hac_sensitivity",
        "passed": true
      },
      {
        "name": "ts_lag_sensitivity",
        "passed": true
      },
      {
        "name": "ts_regime_stability",
        "passed": true
      },
      {
        "name": "ts_shock_support",
        "passed": true
      }
    ],
    "failure_flags": [],
    "id_risks": {
      "unmeasured_confounding": "medium",
      "simultaneity": "low",
      "weak_variation": "low",
      "measurement_error": "low",
      "selection": "low"
    },
    "cf_shock_allowed": false,
    "cf_policy_allowed": false,
    "cf_reason_blocked": "Shock CF requires REDUCED_FORM+, edge has BLOCKED_ID",
    "n_obs": 176,
    "strategy_type": "",
    "strategy_argument": "",
    "strategy_key_assumption": "",
    "issues": [
      {
        "issue_key": "SIGNIFICANT_BUT_NOT_IDENTIFIED:cpi_tradable_to_cpi_headline",
        "rule_id": "SIGNIFICANT_BUT_NOT_IDENTIFIED",
        "severity": "CRITICAL",
        "message": "p=0.0000 but claim_level=BLOCKED_ID. Significance does not establish causation."
      },
      {
        "issue_key": "RATING_DIAGNOSTICS_CONFLICT:cpi_tradable_to_cpi_headline",
        "rule_id": "RATING_DIAGNOSTICS_CONFLICT",
        "severity": "HIGH",
        "message": "A-rating despite failed diagnostics."
      }
    ],
    "has_critical_issue": true
  }
];
const LATENTS = [];
const METADATA = {
  "name": "kspi_k2_stress_narrative",
  "description": "DAG generated from narrative text, based on kspi_k2_stress. Contains 12 edges (3 matched, 9 new).",
  "target_node": "k2_ratio_kspi",
  "created": "2026-02-08",
  "owner": "narrative_pipeline",
  "tags": [
    "narrative",
    "auto-generated"
  ]
};
const EDGE_TYPE_COLORS = {"causal": "#2563eb", "reaction_function": "#059669", "bridge": "#9333ea", "identity": "#9333ea", "mechanical": "#9333ea", "immutable": "#d97706"};
const EDGE_TYPE_LABELS = {"causal": "Causal", "reaction_function": "Reaction Function", "bridge": "Accounting Bridge", "identity": "Identity", "mechanical": "Mechanical", "immutable": "Immutable (Validated)"};
const RULE_DESCRIPTIONS = {
  "ENTITY_BOUNDARY_DRIFT": {
    "description": "Mixing entity scopes (bank vs group) breaks comparability",
    "explanation": "When different observations mix entity scopes (e.g., bank-level vs consolidated group-level), the treatment and outcome variables become incomparable across units. Capital ratios at bank level differ systematically from group level due to intra-group transfers and double counting. Ignoring this produces biased panel estimates because the variation being exploited is partly definitional, not economic.\n",
    "guidance": "Harmonize all observations to the same scope (preferably unconsolidated bank-level for Kazakhstan data). If harmonization is impossible, add a scope dummy and note the caveat in the report.\n"
  },
  "KPI_DEFINITION_MISMATCH_CROSS_BANK": {
    "description": "NPL/CoR definitions differ across banks causing sign conflicts",
    "explanation": "Banks may use different definitions for key performance indicators (e.g., NPL includes/excludes restructured loans, CoR uses different provisioning rules). Cross-bank panel estimation treats these as comparable, but definitional differences create measurement error correlated with bank characteristics. This can flip coefficient signs between runs and invalidate pooled estimates.\n",
    "guidance": "Check if the definition mismatch is economically meaningful. If yes, harmonize definitions or estimate separately by definition group. Document any remaining heterogeneity as a limitation.\n"
  },
  "SHOCK_CONSTRUCT_AMBIGUOUS": {
    "description": "EdgeCard must include shock_node_id, shock_unit, shock_scale",
    "explanation": "Without explicit shock metadata (which node is shocked, in what units, at what scale), counterfactual scenarios become ambiguous. A &quot;10% depreciation&quot; could mean 10 percentage points or 10% of the current level, leading to order-of-magnitude errors in propagation. This metadata is required for reproducible counterfactuals.\n",
    "guidance": "The system will auto-populate shock metadata from the DAG spec. Verify that the inferred shock_unit and shock_scale match your intended scenario.\n"
  },
  "FREQUENCY_ALIGNMENT_ERROR": {
    "description": "Mixing frequencies without explicit aggregation rule",
    "explanation": "Mixing monthly treatment with quarterly outcome (or vice versa) without a declared aggregation method (end-of-period, average, sum) introduces temporal misalignment. The estimator may silently interpolate or drop observations, changing the effective sample and potentially biasing results. This is auto-fixable but must be logged.\n",
    "guidance": "The system will apply the aggregation rule from the DAG spec. If no rule is specified, it defaults to end-of-period for stocks and average for flows.\n"
  },
  "FREQUENCY_SCALING_MISMATCH": {
    "description": "Annual vs quarterly estimates not normalized to common unit",
    "explanation": "When comparing estimates across runs with different frequencies, a quarterly coefficient is not directly comparable to an annual one. Failing to normalize (e.g., annualize quarterly or quarterly-ize annual) leads to incorrect propagation multipliers and misleading cross-run convergence assessments.\n",
    "guidance": "Normalize all estimates to a common time unit before comparison. The preferred convention is quarterly for macro variables and annual for structural parameters.\n"
  },
  "EXTRACTION_PROVENANCE_GAPS": {
    "description": "Missing source document/page reference for extracted data",
    "explanation": "Data extracted from PDFs, reports, or regulatory filings should carry provenance (source document, page, table number) so that results can be independently verified. Missing provenance makes reproduction impossible and raises audit risk, especially for regulatory submissions.\n",
    "guidance": "Add the source reference to the data extraction metadata. For low-risk variables (e.g., public market data), this can be accepted with a note.\n"
  },
  "REACTION_FUNCTION_EDGE": {
    "description": "Policy reaction edge cannot be used for shock propagation",
    "explanation": "A policy reaction function (e.g., central bank raises rates in response to inflation) captures endogenous behavior, not a causal effect of an exogenous shock. Using it for shock propagation would double-count the policy response or create circular logic. The edge should be classified as diagnostic or informational only.\n",
    "guidance": "Reclassify as diagnostic-only if this is purely a reaction function. If you believe there is an exogenous component, document the identification strategy and accept with a caveat.\n"
  },
  "TIME_FE_ABSORBS_SHOCK": {
    "description": "Panel with time FE and common shock requires Exposure x Shock",
    "explanation": "Time fixed effects absorb all common time-varying shocks (including the treatment of interest if it is a macro shock common to all units). To identify the effect, the design must exploit cross-sectional variation in exposure (Exposure x Shock interaction). Without this, the coefficient is mechanically zero or identified only from noise.\n",
    "guidance": "The system will suggest adding an Exposure x Shock interaction term. This is the standard diff-in-diff approach for common shocks in panel data.\n"
  },
  "EXPOSURE_NOT_PREDETERMINED": {
    "description": "Exposure variable must be measured strictly pre-treatment",
    "explanation": "If the exposure variable (e.g., bank&#x27;s FX share) is measured contemporaneously with or after the shock, it may itself be affected by the shock, creating a &quot;bad controls&quot; problem. This violates the exclusion restriction in diff-in-diff designs and biases the estimated causal effect, typically attenuating it toward zero.\n",
    "guidance": "Lag the exposure variable to a pre-treatment period. If pre-treatment measurement is unavailable, accept with a caveat noting potential attenuation bias.\n"
  },
  "MECHANICAL_EDGE_ESTIMATED": {
    "description": "Accounting identity should be bridge, not regression",
    "explanation": "Regressing an identity (e.g., CAR = Capital / RWA) produces tautological results with near-perfect fit, inflating credibility scores and wasting estimation budget. Mechanical edges should be treated as deterministic bridges that pass through shocks via calculus (partial derivatives), not statistical estimation.\n",
    "guidance": "The system will convert this to a bridge edge with deterministic sensitivity. Accept as regression only if you need to test whether the identity holds empirically.\n"
  },
  "PATH_DOUBLE_COUNTING": {
    "description": "Direct reduced-form + indirect chain both used for propagation",
    "explanation": "If both a direct reduced-form edge (A -&gt; C) and a structural chain (A -&gt; B -&gt; C) are included in propagation, the total effect is double-counted. This inflates counterfactual predictions, potentially by 100% or more. The system detects overlapping paths and requires the analyst to choose one.\n",
    "guidance": "Prefer the structural chain if all intermediate edges are IDENTIFIED_CAUSAL, as it provides more granular policy levers. Use reduced-form if intermediate edges are weak or if you only need the total effect.\n"
  },
  "SIGNIFICANT_BUT_NOT_IDENTIFIED": {
    "description": "Significant result but claim_level != IDENTIFIED_CAUSAL",
    "explanation": "This edge shows a statistically significant result (low p-value), but the identification strategy has not been validated as causal. A significant correlation is not the same as a causal effect \u2014 without proper identification (e.g., IV, RDD, DiD), the estimate may reflect reverse causation, omitted variable bias, or spurious correlation. Accepting this as causal without acknowledgement constitutes overclaiming.\n",
    "guidance": "If you have a credible identification strategy, upgrade to IDENTIFIED_CAUSAL and document it. Otherwise, accept as REDUCED_FORM \u2014 informative but not usable for counterfactual predictions without caveats.\n"
  },
  "SMALL_SAMPLE_INFERENCE": {
    "description": "N &lt; 30 with HAC SEs; inference fragile",
    "explanation": "With fewer than 30 observations, HAC (Newey-West) standard errors rely on asymptotic approximations that perform poorly in small samples. Confidence intervals may be too narrow, leading to false rejections of the null. The credibility rating is capped to reflect this uncertainty.\n",
    "guidance": "Consider wild bootstrap for more reliable small-sample inference. The rating cap to B is automatic; override only if you have strong justification for asymptotic validity.\n"
  },
  "PANEL_TOO_FEW_UNITS": {
    "description": "&lt; 5 units; cluster-robust unreliable",
    "explanation": "Cluster-robust standard errors require a sufficient number of clusters (units) to be reliable. With fewer than 5 units, the cluster-robust variance estimator is severely biased downward, leading to over-rejection. This is a well-known problem in the panel econometrics literature (Cameron, Gelbach, Miller 2008).\n",
    "guidance": "Use wild cluster bootstrap (Webb weights) for valid inference with few clusters. The rating cap to B is automatic. Accept with caveat if bootstrap is infeasible.\n"
  },
  "LOO_INSTABILITY": {
    "description": "Leave-one-out shows sign flip or &gt;50% magnitude change",
    "explanation": "Leave-one-out (LOO) analysis drops each unit in turn and re-estimates. If the coefficient flips sign or changes magnitude by more than 50%, the result is driven by a single influential unit rather than a systematic pattern. Such fragility undermines confidence in the estimate as a general causal effect.\n",
    "guidance": "Identify the influential unit and investigate whether it is an outlier or represents a genuine subgroup effect. Consider winsorizing, trimming, or reporting results with and without the influential unit.\n"
  },
  "BREAKS_UNMODELED": {
    "description": "Regime changes not accounted for in estimation",
    "explanation": "Structural breaks (e.g., policy changes, crises) can cause coefficient instability. If breaks are present but not modeled, the estimated coefficient is a weighted average across regimes, which may not represent either regime accurately. This is especially problematic for counterfactual scenarios that project beyond a break date.\n",
    "guidance": "Add a regime dummy or split the sample at the break date. If the break is recent and data post-break is insufficient, restrict counterfactual scope to the pre-break regime.\n"
  },
  "MULTIPLE_TESTING_DRIFT": {
    "description": "Spec search exceeded pre-registered budget",
    "explanation": "Running many specifications and reporting only the significant one inflates the false discovery rate. The pre-registered specification budget limits this. If the budget is exceeded, the analyst must either apply a multiple testing correction (e.g., Bonferroni) or justify the additional specifications as pre-planned robustness checks.\n",
    "guidance": "Apply Bonferroni correction to the p-values if the budget was exceeded due to exploratory analysis. If the additional specs were planned robustness checks, document them and reset the budget.\n"
  },
  "NONSTATIONARY_LEVELS_RISK": {
    "description": "Both variables in levels and trending; require transformation or ECM",
    "explanation": "Regressing two trending (non-stationary) variables in levels produces spurious regression \u2014 high R-squared and significant t-statistics that reflect shared trends, not causal relationships. The solution is to first-difference, use an ECM if cointegrated, or apply appropriate transformations (log-differences for growth rates).\n",
    "guidance": "The system will apply first-differencing by default. If you believe the variables are cointegrated, select ECM specification to preserve the long-run relationship.\n"
  },
  "RESIDUAL_AUTOCORR_DETECTED": {
    "description": "Serial correlation in residuals; HAC SEs may be inadequate",
    "explanation": "Serial correlation in residuals indicates that the model is missing dynamic structure. While HAC standard errors adjust for this, they may be inadequate if the autocorrelation is strong or persistent, leading to under-estimated standard errors and over-rejection.\n",
    "guidance": "Consider increasing the HAC bandwidth or adding lagged dependent variables. If autocorrelation is mild (DW close to 2), accept with a caveat.\n"
  },
  "REGIME_BREAK_SUSPECTED": {
    "description": "Coefficient instability across regime splits",
    "explanation": "TSGuard detected statistically significant coefficient differences across time sub-samples, suggesting a structural break. Using a single coefficient for the full sample masks regime-specific effects and produces unreliable counterfactuals for periods after the break.\n",
    "guidance": "Split the sample at the detected break date and estimate separately. If the break is too recent for reliable post-break estimation, restrict counterfactual scope to the pre-break regime.\n"
  },
  "LEADS_SIGNIFICANT_TIMING_FAIL": {
    "description": "Effects appear before shock; reverse causation or omitted factor",
    "explanation": "If the outcome responds significantly BEFORE the treatment shock, the causal interpretation fails. This indicates either reverse causation (outcome causes treatment), an omitted common factor driving both, or anticipation effects that violate the parallel trends assumption. The edge is blocked from propagation automatically.\n",
    "guidance": "Investigate whether leads reflect anticipation (expected policy changes) or reverse causation. If anticipation, consider adjusting the shock timing. If reverse causation, reclassify the edge direction or remove from the DAG.\n"
  },
  "HAC_LAG_SENSITIVITY_HIGH": {
    "description": "Estimate changes materially with HAC lag length",
    "explanation": "If the point estimate or its significance changes substantially when varying the HAC bandwidth (number of lags in the Newey-West kernel), the inference is fragile to the choice of bandwidth. This suggests that the serial correlation structure is complex and the standard errors are not robust to bandwidth selection.\n",
    "guidance": "Report results across multiple bandwidths. Use a data-driven bandwidth selector (e.g., Andrews 1991) rather than ad hoc choice. Accept with caveat if the sign is stable across bandwidths.\n"
  },
  "SELECTION_PUBLIC_BANK_ONLY": {
    "description": "Panel uses only public banks; results may not generalize to full banking sector",
    "explanation": "Public (listed) banks differ systematically from private banks in size, governance, risk appetite, and regulatory scrutiny. Estimates from public-only samples may not generalize to the full banking sector. Counterfactuals applied to the full sector using these estimates would be unreliable for the private bank segment.\n",
    "guidance": "Add a disclaimer noting the sample restriction. Cap the counterfactual scope to public banks only, or accept with a clear caveat about external validity limitations.\n"
  },
  "SURVIVORSHIP_BIAS_RISK": {
    "description": "Sample excludes failed/merged banks; survival conditioning biases estimates",
    "explanation": "If banks that failed, merged, or exited the sample are excluded, the remaining sample is conditioned on survival. This creates survivorship bias \u2014 the estimated effects reflect only the experience of survivors, typically underestimating the negative effects of shocks (since the most affected banks disappeared).\n",
    "guidance": "Run a sensitivity check including failed/merged banks up to their last observation. Add a disclaimer about survivorship bias. If data on exits is unavailable, accept with a clear caveat.\n"
  },
  "COVERAGE_GAP_EXTERNAL_VALIDITY": {
    "description": "Sample covers &lt;50% of system assets or &lt;50% of institutions in target population",
    "explanation": "When the sample covers less than half of the target population (by assets or count), the estimated effects may not represent the system as a whole. Small or mid-sized banks excluded from the sample may have different exposure patterns and response mechanisms than the included banks.\n",
    "guidance": "Add a disclaimer noting the coverage gap. If the coverage gap is due to data availability, document which segments are missing and their likely direction of bias.\n"
  },
  "RATING_DIAGNOSTICS_CONFLICT": {
    "description": "A-rating despite failed diagnostics or missing requirements",
    "explanation": "An A-rating signals high credibility, but one or more diagnostics have failed or required checks are missing. This inconsistency undermines the rating system&#x27;s integrity. The system auto-downgrades to B to maintain consistency between the rating and the underlying evidence.\n",
    "guidance": "The auto-downgrade to B is applied. Override to A only if you can document why the failed diagnostic does not affect the estimate&#x27;s credibility for your specific use case.\n"
  },
  "N_REPORTING_INCONSISTENT": {
    "description": "Report N header != EdgeCard N_eff",
    "explanation": "The sample size reported in the system report header differs from the effective observations in the EdgeCard. This inconsistency confuses reviewers and may indicate a data processing error (e.g., missing values were dropped but not reflected in the header count).\n",
    "guidance": "The system will auto-fix by aligning the report N to the EdgeCard N_eff. Accept the auto-fix unless you have a specific reason for the discrepancy.\n"
  },
  "CROSS_EVIDENCE_CONFLICT": {
    "description": "Two edges measuring same relationship have conflicting signs",
    "explanation": "When two edges estimate the same causal relationship (e.g., one reduced-form and one structural) but produce opposite signs, at least one is biased or misspecified. Using both in propagation would produce contradictory counterfactuals. The analyst must adjudicate which estimate is more credible.\n",
    "guidance": "Prefer the structural edge if its identification strategy is stronger. If both designs are equally credible, report the conflict as a limitation and consider averaging with appropriate uncertainty.\n"
  },
  "ORPHAN_NODE_UNCONNECTED": {
    "description": "Node not connected to any edge; unreachable in propagation",
    "explanation": "A node exists in the DAG but does not appear in any edge&#x27;s from/to or latent&#x27;s affects list. If the node has an identity formula whose components are all present in the DAG, an identity edge can be auto-created. Otherwise, human intervention is required to either add a causal edge with estimation backing or remove the node.\n",
    "guidance": "For identity-resolvable orphans, the system creates a deterministic identity edge and edge card. For others, add an edge with proper estimation or remove the orphan node from the DAG.\n"
  },
  "TARGET_UNREACHABLE": {
    "description": "Target node is unreachable from any root node in the DAG",
    "explanation": "The target node (the variable the DAG is designed to explain) cannot be reached by following edges from any exogenous root node. This means the causal narrative is structurally broken \u2014 shocks cannot propagate to the target. Common causes include missing identity edges, disconnected components, or incomplete narrative extraction.\n",
    "guidance": "Add the missing edges that connect the exogenous shock chain to the target. For identity nodes (e.g., K2 = Capital / RWA), ensure both identity component edges exist.\n"
  },
  "IDENTITY_DEPS_INCOMPLETE": {
    "description": "Derived node&#x27;s identity formula has dependencies without edges",
    "explanation": "A derived node has an identity formula (e.g., K2 = Capital / RWA) that references dependency nodes, but one or more of those dependencies lack an edge pointing to the derived node. This breaks the accounting identity chain and prevents correct propagation through the identity relationship.\n",
    "guidance": "The system will auto-create identity edges from each dependency to the derived node. Accept if the dependencies are correctly specified in the formula.\n"
  },
  "SINK_NODE_NOT_TARGET": {
    "description": "Non-target node absorbs information but does not transmit downstream",
    "explanation": "A node has incoming edges but no outgoing edges, yet it is not the DAG&#x27;s target node. This means information (shocks) flow into this node but are absorbed without transmitting further. If the node is meant to influence downstream variables, the missing outgoing edge represents a gap in the causal narrative.\n",
    "guidance": "Either add an outgoing edge to connect this node downstream, or accept this as a terminal diagnostic node that is not part of the propagation chain.\n"
  },
  "EDGE_ID_SYNTAX_INVALID": {
    "description": "Edge ID contains spaces, arrows, or other invalid characters",
    "explanation": "Edge IDs must be valid snake_case identifiers (lowercase letters, digits, underscores only). IDs containing spaces, arrows (-&gt;), parentheses, or other special characters cause filesystem errors when saving EdgeCards and break downstream tooling that expects clean identifiers.\n",
    "guidance": "The system will auto-sanitize the edge ID by converting arrows to _to_, removing special characters, and collapsing consecutive underscores.\n"
  },
  "IDENTITY_FORMULA_DOUBLE_TRANSFORM": {
    "description": "Identity formula applies log() to a node already stored in log form",
    "explanation": "A derived node&#x27;s identity formula contains log(X) where X already has transforms: [log], meaning the data is already in log levels. Applying log() again would double-log the variable, producing incorrect results. This is usually a documentation convention issue rather than a runtime bug, but it creates ambiguity about whether the formula represents a mathematical operation or a label.\n",
    "guidance": "If the convention is that transforms: [log] means &quot;data stored in log form&quot;, then the formula should use the variable name directly (e.g., X - Y instead of log(X) - log(Y)). Update the formula to match.\n"
  },
  "UNIT_MISSING_IN_EDGECARD": {
    "description": "EdgeCard missing treatment_unit/outcome_unit",
    "explanation": "Without explicit units (e.g., &quot;pp&quot;, &quot;%&quot;, &quot;log points&quot;), the coefficient is uninterpretable. A coefficient of 0.5 could mean 0.5 percentage points, 50%, or 0.5 log points \u2014 a potential 100x difference in the implied effect. Units are required for any meaningful propagation or reporting.\n",
    "guidance": "The system will auto-populate units from the DAG spec. Verify that the inferred units match the actual estimation specification.\n"
  }
};
const ACTIONS_BY_RULE = {
  "SIGNIFICANT_BUT_NOT_IDENTIFIED": {
    "action_type": "set_claim_level",
    "options": [
      {
        "value": "IDENTIFIED_CAUSAL",
        "label": "IDENTIFIED_CAUSAL",
        "tooltip": "Asserts credible identification strategy (IV, RDD, DiD). Requires documentation. Unlocks counterfactual propagation at full weight."
      },
      {
        "value": "REDUCED_FORM",
        "label": "REDUCED_FORM",
        "tooltip": "Informative but not causally identified. Flagged in reports, excluded from causal counterfactuals. Useful for suggestive evidence."
      },
      {
        "value": "DESCRIPTIVE",
        "label": "DESCRIPTIVE",
        "tooltip": "Descriptive association only. No causal weight in propagation or counterfactuals. Kept for reporting and context."
      },
      {
        "value": "BLOCKED_ID",
        "label": "BLOCKED_ID",
        "tooltip": "Blocks identification claim entirely. Edge remains in DAG but cannot be used for propagation until resolved."
      }
    ]
  },
  "REACTION_FUNCTION_EDGE": {
    "action_type": "set_propagation",
    "options": [
      {
        "value": "RECLASSIFY_DIAGNOSTIC",
        "label": "Reclassify as diagnostic",
        "tooltip": "Moves edge to diagnostic-only role. It will appear in reports but not participate in shock propagation or counterfactuals."
      },
      {
        "value": "ACCEPT_WITH_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps edge in propagation but adds an explicit caveat about endogeneity to all downstream counterfactuals."
      },
      {
        "value": "BLOCK_PROPAGATION",
        "label": "Block from propagation",
        "tooltip": "Removes edge from all propagation paths. It remains visible in the DAG for documentation but has zero causal weight."
      }
    ]
  },
  "TIME_FE_ABSORBS_SHOCK": {
    "action_type": "set_design_fix",
    "options": [
      {
        "value": "ADD_INTERACTION",
        "label": "Add Exposure x Shock",
        "tooltip": "Adds cross-sectional exposure interaction to identify effects absorbed by time FE. Standard DiD approach for common macro shocks."
      },
      {
        "value": "DROP_TIME_FE",
        "label": "Drop time FE",
        "tooltip": "Removes time fixed effects to allow common shock identification. Risks confounding from other time-varying factors."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)",
        "tooltip": "Keeps current specification. Documents that the common shock effect is absorbed and the estimate captures only cross-sectional variation."
      }
    ]
  },
  "EXPOSURE_NOT_PREDETERMINED": {
    "action_type": "set_exposure_action",
    "options": [
      {
        "value": "LAG_EXPOSURE",
        "label": "Lag exposure variable",
        "tooltip": "Uses pre-treatment period exposure measurement to avoid bad controls bias. Recommended if pre-treatment data is available."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps contemporaneous exposure with a documented caveat about potential attenuation bias from endogenous exposure."
      },
      {
        "value": "BLOCK_ID",
        "label": "Block identification claim",
        "tooltip": "Downgrades identification to REDUCED_FORM. The edge cannot claim causal identification without predetermined exposure."
      }
    ]
  },
  "MECHANICAL_EDGE_ESTIMATED": {
    "action_type": "set_edge_type",
    "options": [
      {
        "value": "CONVERT_BRIDGE",
        "label": "Convert to bridge edge",
        "tooltip": "Replaces regression with deterministic sensitivity (partial derivative). Eliminates wasted estimation budget on tautological relationships."
      },
      {
        "value": "ACCEPT",
        "label": "Accept as regression",
        "tooltip": "Keeps the regression estimate. Useful if you want to empirically test whether the identity holds (e.g., detecting measurement error)."
      }
    ]
  },
  "PATH_DOUBLE_COUNTING": {
    "action_type": "set_path_choice",
    "options": [
      {
        "value": "USE_STRUCTURAL",
        "label": "Use structural chain",
        "tooltip": "Uses the full structural decomposition (A-&gt;B-&gt;C). Provides more granular policy levers but requires all intermediate edges to be credible."
      },
      {
        "value": "USE_REDUCED_FORM",
        "label": "Use reduced-form shortcut",
        "tooltip": "Uses the direct reduced-form edge (A-&gt;C). Simpler and more robust if intermediate edges are weak, but loses structural detail."
      },
      {
        "value": "ACCEPT_BOTH",
        "label": "Accept both (document)",
        "tooltip": "Keeps both paths with documentation. Only valid if paths measure different aspects (e.g., short-run vs long-run effects)."
      }
    ]
  },
  "ENTITY_BOUNDARY_DRIFT": {
    "action_type": "set_boundary_action",
    "options": [
      {
        "value": "HARMONIZE",
        "label": "Harmonize to common scope",
        "tooltip": "Converts all observations to the same entity scope (bank-level or group-level). May require data adjustments."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps mixed scopes with a documented caveat. Appropriate when scope differences are small or unavoidable."
      },
      {
        "value": "EXCLUDE_EDGE",
        "label": "Exclude edge",
        "tooltip": "Removes the edge from estimation entirely. Use when scope mixing makes the estimate unreliable."
      }
    ]
  },
  "KPI_DEFINITION_MISMATCH_CROSS_BANK": {
    "action_type": "set_kpi_action",
    "options": [
      {
        "value": "HARMONIZE",
        "label": "Harmonize definitions",
        "tooltip": "Adjusts data to use consistent definitions across banks. May require recalculation from raw components."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps heterogeneous definitions with documentation. Appropriate if differences are minor or well-understood."
      },
      {
        "value": "EXCLUDE_EDGE",
        "label": "Exclude edge",
        "tooltip": "Removes the edge. Use when definition differences are fundamental and cannot be reconciled."
      }
    ]
  },
  "SHOCK_CONSTRUCT_AMBIGUOUS": {
    "action_type": "set_shock_action",
    "options": [
      {
        "value": "ADD_METADATA",
        "label": "Add shock metadata",
        "tooltip": "Populates missing shock_node_id, shock_unit, and shock_scale from DAG spec. Required for counterfactual scenarios."
      },
      {
        "value": "ACCEPT",
        "label": "Accept as-is",
        "tooltip": "Keeps edge without shock metadata. Edge will not be usable in counterfactual scenarios."
      }
    ]
  },
  "FREQUENCY_ALIGNMENT_ERROR": {
    "action_type": "set_freq_action",
    "options": [
      {
        "value": "AGGREGATE_Q",
        "label": "Aggregate to quarterly",
        "tooltip": "Aggregates higher-frequency data to quarterly using the DAG-specified method (average for flows, end-of-period for stocks)."
      },
      {
        "value": "AGGREGATE_A",
        "label": "Aggregate to annual",
        "tooltip": "Aggregates to annual frequency. Loses short-run dynamics but may be necessary for data availability reasons."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)",
        "tooltip": "Keeps mixed frequencies with documentation. Only appropriate if the estimator handles mixed frequencies natively."
      }
    ]
  },
  "FREQUENCY_SCALING_MISMATCH": {
    "action_type": "set_scaling_action",
    "options": [
      {
        "value": "NORMALIZE",
        "label": "Normalize to common unit",
        "tooltip": "Rescales coefficients to a common time unit (quarterly convention). Ensures cross-run comparability."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps different time units with documentation. Cross-run comparisons will include unit conversion caveats."
      }
    ]
  },
  "EXTRACTION_PROVENANCE_GAPS": {
    "action_type": "set_provenance_action",
    "options": [
      {
        "value": "ADD_SOURCE",
        "label": "Add source reference",
        "tooltip": "Adds source document, page, and table reference to the data extraction metadata for audit trail."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (low risk)",
        "tooltip": "Accepts without provenance. Appropriate for public market data or well-known statistical series."
      }
    ]
  },
  "SMALL_SAMPLE_INFERENCE": {
    "action_type": "set_sample_action",
    "options": [
      {
        "value": "CAP_B",
        "label": "Cap rating to B",
        "tooltip": "Limits credibility rating to B, reflecting asymptotic approximation risk with N &lt; 30. Automatic default action."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps current rating with documented small-sample caveat. Only if you have justification for asymptotic validity."
      },
      {
        "value": "RE_ESTIMATE",
        "label": "Flag for re-estimation",
        "tooltip": "Queues re-estimation with wild bootstrap standard errors for more reliable small-sample inference."
      }
    ]
  },
  "PANEL_TOO_FEW_UNITS": {
    "action_type": "set_panel_action",
    "options": [
      {
        "value": "CAP_B",
        "label": "Cap rating to B",
        "tooltip": "Limits rating to B due to cluster-robust SE unreliability with &lt; 5 units. Automatic default action."
      },
      {
        "value": "WILD_BOOTSTRAP",
        "label": "Use wild cluster bootstrap",
        "tooltip": "Re-estimates with wild cluster bootstrap (Webb weights) for valid few-cluster inference. May widen confidence intervals."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps current estimate with documented caveat about few-cluster inference fragility."
      }
    ]
  },
  "LOO_INSTABILITY": {
    "action_type": "set_loo_action",
    "options": [
      {
        "value": "CAP_C",
        "label": "Cap rating to C",
        "tooltip": "Limits rating to C reflecting result fragility to single-unit exclusion. Signals low confidence in generalizability."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps current rating with documented LOO instability caveat. Identify the influential unit in the rationale."
      },
      {
        "value": "RE_ESTIMATE",
        "label": "Flag for re-estimation",
        "tooltip": "Queues re-estimation with the influential unit excluded or winsorized. Produces a robustness comparison."
      }
    ]
  },
  "BREAKS_UNMODELED": {
    "action_type": "set_breaks_action",
    "options": [
      {
        "value": "ADD_REGIME",
        "label": "Add regime dummy",
        "tooltip": "Adds a structural break dummy at the detected break date. Allows coefficient to differ across regimes."
      },
      {
        "value": "SPLIT_SAMPLE",
        "label": "Split sample estimation",
        "tooltip": "Estimates separately for each regime. Provides regime-specific coefficients for targeted counterfactuals."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps pooled estimate with caveat about coefficient averaging across regimes."
      }
    ]
  },
  "MULTIPLE_TESTING_DRIFT": {
    "action_type": "set_testing_action",
    "options": [
      {
        "value": "BONFERRONI",
        "label": "Apply Bonferroni correction",
        "tooltip": "Adjusts p-values for the number of specifications tested. Conservative but protects against false discoveries."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps unadjusted p-values with documentation of the specification search. Appropriate for pre-planned robustness."
      },
      {
        "value": "RESET_BUDGET",
        "label": "Reset spec budget",
        "tooltip": "Resets the specification budget counter. Use only if the additional specs were pre-planned and documented."
      }
    ]
  },
  "NONSTATIONARY_LEVELS_RISK": {
    "action_type": "set_stationarity_action",
    "options": [
      {
        "value": "DIFFERENCE",
        "label": "First-difference",
        "tooltip": "Applies first-differencing to both variables. Removes trends but loses long-run level information."
      },
      {
        "value": "ECM",
        "label": "Use ECM specification",
        "tooltip": "Uses Error Correction Model to preserve long-run relationship while modeling short-run dynamics. Requires cointegration."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)",
        "tooltip": "Keeps levels specification with documentation. Only valid if you have theoretical reasons for level relationships."
      }
    ]
  },
  "RESIDUAL_AUTOCORR_DETECTED": {
    "action_type": "set_autocorr_action",
    "options": [
      {
        "value": "INCREASE_HAC",
        "label": "Increase HAC bandwidth",
        "tooltip": "Increases Newey-West kernel bandwidth to better capture serial correlation. May widen standard errors."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps current HAC bandwidth with documented autocorrelation caveat. Appropriate for mild autocorrelation."
      }
    ]
  },
  "REGIME_BREAK_SUSPECTED": {
    "action_type": "set_regime_action",
    "options": [
      {
        "value": "ADD_BREAK",
        "label": "Add structural break",
        "tooltip": "Adds break dummy and interaction terms at the detected break date. Allows before/after comparison."
      },
      {
        "value": "SPLIT_SAMPLE",
        "label": "Split sample",
        "tooltip": "Estimates separately for pre-break and post-break periods. Provides regime-specific coefficients."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps pooled estimate with documented regime instability caveat."
      }
    ]
  },
  "LEADS_SIGNIFICANT_TIMING_FAIL": {
    "action_type": "set_timing_action",
    "options": [
      {
        "value": "BLOCK_PROPAGATION",
        "label": "Block from propagation",
        "tooltip": "Removes edge from all propagation paths. Automatic action for timing failures. Edge kept for diagnostic purposes."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat (document)",
        "tooltip": "Keeps edge with documented timing failure. Only valid if leads reflect anticipated policy changes, not reverse causation."
      },
      {
        "value": "RE_ESTIMATE",
        "label": "Flag for re-estimation",
        "tooltip": "Queues re-estimation with adjusted shock timing or additional lead/lag structure to investigate timing failure."
      }
    ]
  },
  "HAC_LAG_SENSITIVITY_HIGH": {
    "action_type": "set_hac_action",
    "options": [
      {
        "value": "USE_FIXED_BW",
        "label": "Fix HAC bandwidth",
        "tooltip": "Uses a fixed, data-driven bandwidth (Andrews 1991). Removes sensitivity to ad hoc bandwidth choice."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps current estimate with documented bandwidth sensitivity caveat. Report results across multiple bandwidths."
      }
    ]
  },
  "SELECTION_PUBLIC_BANK_ONLY": {
    "action_type": "set_selection_action",
    "options": [
      {
        "value": "ADD_DISCLAIMER",
        "label": "Add report disclaimer",
        "tooltip": "Adds explicit sample restriction disclaimer to the system report. Results clearly labeled as public-bank-only."
      },
      {
        "value": "CAP_SCOPE",
        "label": "Cap counterfactual scope",
        "tooltip": "Restricts counterfactual predictions to public banks only. Prevents extrapolation to non-sampled bank types."
      },
      {
        "value": "ACCEPT",
        "label": "Accept as-is",
        "tooltip": "No action taken. Use only if the target population is specifically public banks."
      }
    ]
  },
  "SURVIVORSHIP_BIAS_RISK": {
    "action_type": "set_survivorship_action",
    "options": [
      {
        "value": "ADD_DISCLAIMER",
        "label": "Add report disclaimer",
        "tooltip": "Adds survivorship bias disclaimer. Notes that estimates may understate negative effects due to exit selection."
      },
      {
        "value": "SENSITIVITY_CHECK",
        "label": "Run sensitivity check",
        "tooltip": "Re-estimates including failed/merged banks up to their last observation. Compares with survivor-only estimates."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Keeps survivor-only estimate with documented caveat about potential downward bias in negative effect estimates."
      }
    ]
  },
  "COVERAGE_GAP_EXTERNAL_VALIDITY": {
    "action_type": "set_coverage_action",
    "options": [
      {
        "value": "ADD_DISCLAIMER",
        "label": "Add report disclaimer",
        "tooltip": "Adds coverage gap disclaimer. Documents which segments of the target population are missing from the sample."
      },
      {
        "value": "ACCEPT_CAVEAT",
        "label": "Accept with caveat",
        "tooltip": "Accepts with documented coverage limitation. Notes direction of likely bias from missing segments."
      }
    ]
  },
  "RATING_DIAGNOSTICS_CONFLICT": {
    "action_type": "set_rating",
    "options": [
      {
        "value": "DOWNGRADE_B",
        "label": "Downgrade to B",
        "tooltip": "Downgrades from A to B due to failed diagnostics. Standard action to maintain rating-evidence consistency."
      },
      {
        "value": "DOWNGRADE_C",
        "label": "Downgrade to C",
        "tooltip": "Downgrades to C for severe diagnostic failures (multiple failed checks or critical timing failure)."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)",
        "tooltip": "Keeps A rating despite diagnostic issues. Requires strong justification documented in rationale."
      }
    ]
  },
  "N_REPORTING_INCONSISTENT": {
    "action_type": "set_n_action",
    "options": [
      {
        "value": "FIX_REPORT",
        "label": "Fix report N",
        "tooltip": "Updates the system report header to match EdgeCard N_eff. Standard fix for reporting inconsistencies."
      },
      {
        "value": "FIX_EDGECARD",
        "label": "Fix EdgeCard N_eff",
        "tooltip": "Updates EdgeCard N_eff to match report header. Use only if the report header is the authoritative source."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (document)",
        "tooltip": "Keeps inconsistency with documentation. Only if the discrepancy reflects a deliberate methodological choice."
      }
    ]
  },
  "CROSS_EVIDENCE_CONFLICT": {
    "action_type": "set_conflict_action",
    "options": [
      {
        "value": "PREFER_STRUCTURAL",
        "label": "Prefer structural edge",
        "tooltip": "Uses the structural (better-identified) edge estimate. The conflicting reduced-form edge is demoted to diagnostic-only."
      },
      {
        "value": "PREFER_REDUCED",
        "label": "Prefer reduced-form edge",
        "tooltip": "Uses the reduced-form edge estimate. The structural edge is demoted. Appropriate if structural identification is suspect."
      },
      {
        "value": "ACCEPT_BOTH",
        "label": "Accept both (document)",
        "tooltip": "Keeps both estimates with documented conflict. Reports will show both with an explicit conflict warning."
      }
    ]
  },
  "UNIT_MISSING_IN_EDGECARD": {
    "action_type": "set_unit_action",
    "options": [
      {
        "value": "ADD_UNITS",
        "label": "Add units from spec",
        "tooltip": "Auto-populates treatment_unit and outcome_unit from the DAG node specifications. Standard auto-fix."
      },
      {
        "value": "ACCEPT",
        "label": "Accept (not critical)",
        "tooltip": "Keeps edge without explicit units. Only for edges not used in propagation where unit ambiguity is acceptable."
      }
    ]
  },
  "_default": {
    "action_type": "resolve",
    "options": [
      {
        "value": "ACCEPT",
        "label": "Accept",
        "tooltip": "Accepts the issue without further action. The issue is marked as resolved."
      },
      {
        "value": "REJECT",
        "label": "Reject",
        "tooltip": "Rejects the flagged finding. The edge remains as-is but the rejection is logged for audit."
      },
      {
        "value": "ESCALATE",
        "label": "Escalate",
        "tooltip": "Escalates to senior reviewer or domain expert. Issue remains open until resolved by escalation target."
      }
    ]
  }
};
const GENERATED_AT = "2026-02-11 18:32:12 UTC";
const ISSUE_GUIDANCE = {
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:fx_to_cpi_tradable": "**Finding**: The edge **fx_to_cpi_tradable** has a statistically significant estimated effect (**\u03b2 = 0.113**, **SE = 0.028**, **p = 0.0001**, **N = 1200**) while being labeled **IDENTIFIED_CAUSAL** under **IMMUTABLE_EVIDENCE**.\n\n**Concern**: Even with **p = 0.0001**, statistical significance alone does not justify a causal claim, and with **no failed diagnostics reported** there is still an identification gap: the evidence presented supports a precisely estimated association but does not document the specific quasi-experimental/exogeneity conditions required for **IDENTIFIED_CAUSAL**.\n\n**Recommendation**: **Downgrade the claim level from IDENTIFIED_CAUSAL to ASSOCIATIONAL (or \u201cNOT_IDENTIFIED\u201d) unless you can explicitly document the identification argument** tied to \u201cIMMUTABLE_EVIDENCE\u201d (e.g., a clearly exogenous FX shock/assignment mechanism), keeping **\u03b2 = 0.113 (p = 0.0001)** as strong evidence of association but not, by itself, causation.",
  "RATING_DIAGNOSTICS_CONFLICT:cpi_to_nbk_rate": "**Finding**: The cpi_to_nbk_rate edge is rated **A** even though the estimated effect is essentially null (**coefficient = -0.5353**, **SE = 13.9656**, **p = 0.9694**, **N = 67**) and it **fails sign_consistency**.\n\n**Concern**: An **A-rating** is not credible here because **sign_consistency failed**, indicating the estimated direction is unstable across horizons/specifications in the local projections setup, and the extremely weak statistical signal (**p = 0.9694**) makes any causal directional claim at the **BLOCKED_ID** level highly unreliable.\n\n**Recommendation**: **Downgrade or block** this edge for causal interpretation (at minimum remove the **A** rating) unless you can resolve the **sign_consistency** failure (e.g., by tightening the LP specification/horizon set or addressing instability); with **p = 0.9694**, the practical default should be to treat this as **no evidence of an effect** rather than an A-rated causal link.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_npl_kspi_annual": "**Finding**: The edge **shock_to_npl_kspi_annual** is highly statistically significant with a coefficient of **349.16** (SE **33.42**), **p = 1.51e-25**, but it is only claimed at **REDUCED_FORM** identification with **N = 8** and a failed diagnostic **effective_obs**.\n\n**Concern**: With only **8 observations** and a failed **effective_obs** diagnostic, the extremely small p-value is not credible evidence of a causal effect\u2014local projections can produce spuriously \u201cprecise\u201d inference when the effective sample size is too small, so causal validity is weak despite the large t-statistic implied by 349.16/33.42.\n\n**Recommendation**: Treat this result as **non-causal / exploratory** and **do not use it for causal claims or policy decisions** unless you can (i) raise effective sample size (e.g., longer time series / pooled panel), and (ii) re-estimate with inference robust to small samples (e.g., small-sample/HAC adjustments or bootstrap) and only then reconsider whether an identified design (beyond **REDUCED_FORM**) is defensible.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_npl_sector": "**Finding**: The edge **shock_to_npl_sector** is statistically significant in the reduced form (**coef = -46.55**, **SE = 13.42**, **p = 0.0029**, **N = 48**) under **PANEL_LP_EXPOSURE_FE**, despite a **Rating = C**.\n\n**Concern**: Because the **claim level is REDUCED_FORM** and key robustness/validity checks failed (**leave_one_bank_out** suggests the estimate may be driven by one bank; **regime_break** indicates instability across time/regimes), the significant **-46.55** cannot be treated as a causal effect and is at high risk of being non-identified or non-generalizable.\n\n**Recommendation**: Treat this as **descriptive reduced-form evidence only** (do not use for causal claims or policy counterfactuals) and re-estimate with (i) bank-influence mitigation or diagnostics-based exclusion/weighting to address the **leave_one_bank_out** failure and (ii) explicit regime controls/splitting or break-robust specifications to resolve **regime_break**; if the magnitude/sign remains similar after passing both diagnostics, then you can consider upgrading identification strength, otherwise downgrade the result to \u201cunstable/fragile.\u201d",
  "LOO_INSTABILITY:shock_to_npl_sector": "**Finding**: The edge **shock_to_npl_sector** has a large negative estimate (**\u03b2 = -46.55**, **SE = 13.42**, **p = 0.00293**, **N = 48**), but it is flagged **HIGH** severity because leave-one-out causes a **sign flip or >50% magnitude change**.\n\n**Concern**: Despite the low p-value, the **leave_one_bank_out** failure and **regime_break** failure indicate the estimate is likely being driven by one (or a few) banks and/or a structural break, so the reduced-form causal interpretation is fragile and may not generalize across units or time.\n\n**Recommendation**: Do not treat this as a stable causal effect as-is; re-estimate the **PANEL_LP_EXPOSURE_FE** specification with explicit break handling (e.g., split-sample or break dummies) and influence-robust inference (e.g., report leave-one-bank-out range and downweight/diagnose influential banks), and only keep the edge if the coefficient remains directionally consistent and within ~50% of **-46.55** across these checks (otherwise downgrade or exclude from the causal graph).",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_cor_kspi_annual": "**Finding**: The estimated effect on `shock_to_cor_kspi_annual` is **360.118** (SE **45.442**) with **p = 2.28e-15** using **N = 8** annual local projections, but the claim level is only **REDUCED_FORM** and diagnostics flag **effective_obs** as failed.\n\n**Concern**: Despite extreme statistical significance, the **failed effective_obs diagnostic** with only **8 observations** means the inference likely overstates precision (effective sample size/independent variation is insufficient), so the **360.118** coefficient cannot be treated as a credible causal effect\u2014at best it is a reduced-form association.\n\n**Recommendation**: Treat this edge as **not causally identified** and **downgrade or suppress causal claims** unless you can (i) fix the **effective_obs** failure (e.g., increase usable time periods/horizons, correct overlapping-horizon SEs, or adjust specification) and (ii) provide an identification strategy beyond reduced-form\u2014otherwise report it explicitly as **descriptive reduced-form** with **N = 8** and failed diagnostic.",
  "RATING_DIAGNOSTICS_CONFLICT:vix_to_fx": "**Finding**: The vix_to_fx edge is rated **A** even though the estimated effect is **-0.0324** with **SE = 0.1099** and **p = 0.7681 (N = 190)**, alongside a **failed sign_consistency** diagnostic.\n\n**Concern**: With a highly insignificant coefficient (p = 0.7681) and **sign_consistency failing**, the direction of the effect is unstable across specifications/horizons, so treating this reduced-form LOCAL_PROJECTIONS result as \u201cA\u201d-quality causal evidence risks a false directional claim.\n\n**Recommendation**: **Downgrade the rating (at least to B/C) and treat the sign as indeterminate** unless you can resolve sign_consistency (e.g., pre-specify horizon/spec, report the full impulse-response path and robustness set); if you must keep it, restrict the claim to \u201cno detectable reduced-form effect\u201d given the wide uncertainty implied by SE = 0.1099 and p = 0.7681.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:oil_supply_to_income": "**Finding**: The oil_supply \u2192 income edge is being flagged because it is statistically significant (p = 0.0030) while the claim level is only **REDUCED_FORM** (no identified causal coefficient is reported: Coefficient/SE/N/Design all N/A).\n\n**Concern**: With no identification strategy or supporting diagnostics (failed diagnostics: none reported, but also no design information), the p = 0.0030 likely reflects correlation/reduced-form association and can be driven by confounding, simultaneity, or common shocks, so treating it as \u201coil supply causes income\u201d would be causally invalid.\n\n**Recommendation**: Do **not** interpret this as a causal effect; either (i) keep the edge explicitly labeled as reduced-form association, or (ii) upgrade to an identified design by specifying and estimating a causal estimand (e.g., an instrument for oil supply, a DiD/event-study around exogenous supply disruptions, or a structural time-series/VAR with credible exclusion restrictions) and then report the causal coefficient, SE, N, and identification diagnostics before making causal claims.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:cpi_to_nominal_income": "**Finding**: The edge **cpi_to_nominal_income** shows a statistically significant association (**\u03b2 = 0.65**, **SE = 0.18**, **p = 0.0003**, **N = 80**) while being labeled **IDENTIFIED_CAUSAL** under an **IMMUTABLE_EVIDENCE** design.\n\n**Concern**: Even with no failed diagnostics, a very small p-value (0.0003) only supports that the estimate differs from zero\u2014not that the **0.65** effect is causally identified\u2014so the \u201cIDENTIFIED_CAUSAL\u201d claim risks overstating causal validity given the design label \u201cIMMUTABLE_EVIDENCE.\u201d\n\n**Recommendation**: Downgrade the claim from **IDENTIFIED_CAUSAL** to an associational claim unless you can document an explicit identification argument (e.g., exogenous CPI variation or a valid design like IV/DiD/RDD); otherwise keep the estimate (**0.65**) but relabel it as correlational despite its strong significance (**p = 0.0003**).",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:global_activity_to_income": "**Finding**: The reduced-form estimate for the edge **global_activity \u2192 income** is statistically significant (**p = 0.0030**) while the claim level is explicitly **REDUCED_FORM** (no identified causal coefficient/SE/N reported).\n\n**Concern**: Because no identification strategy is provided (no design, coefficient, SE, N, or diagnostics beyond \u201cnone\u201d), the **p = 0.0030** only supports correlation/predictive association and can still be driven by confounding, reverse causality, or simultaneity\u2014so treating it as causal would be invalid.\n\n**Recommendation**: Keep the relationship labeled **associational** unless you can upgrade to an identified design (e.g., IV with relevance/exclusion evidence, DiD with pre-trends, RDD with continuity tests, or panel with credible exogeneity); otherwise, use the result only for prediction/description and explicitly avoid causal language despite the strong significance (**p = 0.0030**).",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:portfolio_mix_to_rwa": "**Finding**: The edge **portfolio_mix_to_rwa \u2192 rwa** is statistically significant (**coef = 18,195.96**, **SE = 3,952.75**, **p = 4.16e-06**, **N = 16**) despite a blocked identification claim (**claim_level = BLOCKED_ID**) under **LOCAL_PROJECTIONS**.\n\n**Concern**: With **N = 16** and a failed **effective_obs** diagnostic, the \u201csignificant\u201d estimate likely reflects weak/insufficient effective sample support and/or unstable inference, so the very small **p-value (4.16e-06)** does not resolve endogeneity (e.g., reverse causality, omitted variables) and threatens causal validity.\n\n**Recommendation**: Treat this relationship as **non-causal for decisioning** (keep **BLOCKED_ID** and do not act on the **18,195.96** effect) unless you can fix identification by increasing effective observations and strengthening design (e.g., add credible exogenous variation/instruments or tighter controls and re-run LP with checks that **effective_obs** passes).",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:expenditure_to_payments_revenue": "**Finding**: The edge **expenditure_to_payments_revenue** is statistically significant (**coef = 333.41**, **SE = 70.95**, **p = 2.62e-06**, **N = 7**) under **LOCAL_PROJECTIONS**, but it is only supported at **claim_level = REDUCED_FORM** and has a failed diagnostic (**effective_obs**).\n\n**Concern**: Despite the very small p-value, causal validity is weak because **effective_obs failed** and the sample is extremely small (**N = 7**), so the estimate may be driven by low effective information (and reduced-form significance alone does not identify a causal channel).\n\n**Recommendation**: Treat this relationship as **associational/forecasting-only** and do **not** use it for causal decisions until you (i) fix the **effective_obs** issue (e.g., reduce horizons/lags or simplify the LP specification to increase usable observations) and (ii) add an identification strategy beyond reduced form (e.g., credible exogenous shock/instrument or stronger controls), otherwise the **333.41** estimate should be considered too fragile for causal interpretation.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:nbk_rate_to_cor": "**Finding**: The estimated effect on the edge **nbk_rate_to_cor** is **0.35596** (SE **0.11934**), statistically significant with **p=0.00286** using **N=18** under **LOCAL_PROJECTIONS**, despite a **BLOCKED_ID** claim level and a failed **effective_obs** diagnostic.\n\n**Concern**: The combination of **BLOCKED_ID** identification and a failed **effective_obs** check means the nominal significance (**p=0.00286**) is not credible evidence of a causal effect\u2014your effective sample/information content is likely too low or too correlated for the reported SE, so inference may be overstated and the coefficient **0.35596** may reflect confounding or small-sample artifacts.\n\n**Recommendation**: Do **not** treat this edge as causal; either **downgrade to descriptive/associational** reporting (keep the coefficient but remove causal language) or **re-estimate with stronger identification and sufficient effective observations** (e.g., expand the sample beyond **18**, reduce lag/horizon complexity, use robust small-sample inference, and add/justify an identification strategy) before unblocking the claim.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_cor_kspi": "**Finding**: The edge **shock_to_cor_kspi** is highly statistically significant with **\u03b2 = 85.96**, **SE = 7.40**, **p = 3.57e-31** (N=26) under **LOCAL_PROJECTIONS**, despite the issue flag that \u201cp=0.0000 but claim_level=.\u201d  \n\n**Concern**: With **claim level = REDUCED_FORM** and **no failed diagnostics reported**, the result supports a strong reduced-form association but does not, by itself, justify a causal interpretation\u2014especially given the small sample (**N=26**) where identification assumptions (exogeneity of the shock, no omitted confounding, correct timing) are not verified by significance alone.  \n\n**Recommendation**: Keep the estimate as **reduced-form evidence** (do not upgrade to structural/causal language) and, if a causal claim is needed, add explicit identification support (e.g., document shock exogeneity, include robustness to alternative controls/specifications and pre-trend/lead tests in the local projections) before treating **\u03b2 = 85.96 (p = 3.57e-31)** as causal.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_npl_kspi": "**Finding**: The edge **shock_to_npl_kspi** is highly statistically significant with **\u03b2 = 72.80**, **SE = 10.30**, and **p = 1.55e-12** (N = 26), but it is labeled **REDUCED_FORM** rather than identified causal.\n\n**Concern**: Despite the very small p-value, a **REDUCED_FORM** local-projections estimate (and **no failed diagnostics reported**) still does not rule out omitted variables, anticipation, or correlated shocks, so treating **\u03b2 = 72.80** as causal would overstate causal validity given the **B** rating and small sample (**N = 26**).\n\n**Recommendation**: Use this estimate as **descriptive/associational evidence** only (report it explicitly as reduced-form), and if a causal claim is required, **upgrade identification** by introducing an explicit exogenous shock/instrument or credible quasi-experimental variation and then re-estimate LP with robustness checks (otherwise keep the edge but **downgrade causal language/claim strength** while noting the large magnitude and **p = 1.55e-12**).",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:oil_supply_to_brent": "**Finding**: The estimated effect on the edge **oil_supply_to_brent** is **-0.0517** (SE **0.00541**), which is highly statistically significant (**p = 1.22e-21**, N=306) under **LOCAL_PROJECTIONS**, even though the **claim_level is REDUCED_FORM**.\n\n**Concern**: Because this is explicitly **reduced-form**, the very strong significance (p\u22480) does **not** identify a causal oil-supply shock effect on Brent\u2014it's consistent with reverse causality, omitted variables, or anticipatory/expectations channels, and **no failed diagnostics** does not substitute for an identification strategy.\n\n**Recommendation**: Keep the result as **descriptive/predictive reduced-form evidence** (report **-0.0517** with p=1.22e-21) and **do not make causal claims** unless you upgrade identification (e.g., a clearly exogenous supply-shock instrument or narrative shock series with stated exogeneity and timing restrictions), in which case rerun LP with that identification and reassess.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:shock_to_cor_sector": "**Finding**: The edge **shock_to_cor_sector \u2192 cor_sector** is statistically significant with **\u03b2 = 36.18** (SE = **6.69**), **p = 4.75e-05** using **N = 48** under **PANEL_LP_EXPOSURE_FE**, but it is only labeled at **claim_level = REDUCED_FORM**.\n\n**Concern**: Despite the very small p-value (**4.75e-05**), causal validity is undermined because the key robustness check **leave_one_bank_out failed**, indicating the estimate may be driven by a single influential bank (or a small subset), so the significant reduced-form association may not generalize or identify a causal effect.\n\n**Recommendation**: Treat this as **non-identified/fragile** and **do not use it for causal claims** until you (i) diagnose influence by re-estimating after dropping each bank to identify which exclusion breaks the result and (ii) either adjust the design (e.g., reweight/trim influential exposure banks, redefine exposure, or use a specification that reduces single-bank leverage) or report it explicitly as **sensitive reduced-form evidence** with the leave-one-bank-out failure front-and-center.",
  "LOO_INSTABILITY:shock_to_cor_sector": "**Finding**: The edge `shock_to_cor_sector` is large and statistically strong in-sample (coef = **36.18**, SE = **6.69**, p = **4.75e-05**, N = **48**), but it fails **leave_one_bank_out** with **LOO_INSTABILITY** (sign flip or >50% magnitude change when dropping a single bank).\n\n**Concern**: With **HIGH** LOO instability in a **PANEL_LP_EXPOSURE_FE** reduced-form, the estimated **36.18** effect is likely being driven by one (or a few) influential banks, so the causal claim is not robust and may not generalize\u2014especially given the overall **Rating: C** and small N (**48**).\n\n**Recommendation**: Do not use this edge for causal decision-making as-is; re-estimate and report bank-level influence (identify the bank(s) whose removal flips the sign/changes >50%), and either (i) pre-specify and justify exclusion/winsorization of the influential unit(s) or (ii) move to an estimator/inference that is less sensitive (e.g., robust to influential clusters) and downgrade the conclusion to \u201cfragile/unsupported\u201d unless the coefficient remains stable under these checks.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:fx_to_real_expenditure": "**Finding**: The edge **fx_to_real_expenditure** has an estimated coefficient of **-0.10** (SE **0.04**) with **p=0.012** (N=**60**), yet the issue flags it as \u201csignificant but not identified\u201d despite the current **Claim level = IDENTIFIED_CAUSAL**.\n\n**Concern**: With **no failed diagnostics reported**, the main causal-validity risk is a **mismatch between statistical significance (p=0.012) and the evidentiary basis needed for identification**, meaning the **IDENTIFIED_CAUSAL** label may be overstated if the \u201cIMMUTABLE_EVIDENCE\u201d design does not actually rule out confounding/reverse causality for this relationship.\n\n**Recommendation**: **Keep the estimate (-0.10, p=0.012) as an association but downgrade the claim from IDENTIFIED_CAUSAL to a weaker level (e.g., \u201cassociational\u201d/\u201csuggestive\u201d) unless you can explicitly document the identification argument implied by the IMMUTABLE_EVIDENCE design (e.g., why fx variation is exogenous to real expenditure), in which case retain IDENTIFIED_CAUSAL and add that justification to resolve the flag.**",
  "LOO_INSTABILITY:nbk_rate_to_cor_sector": "**Finding**: The estimated effect on `nbk_rate_to_cor_sector` is 0.1349 with SE 1.3889 and p=0.9258 (N=30), and the leave-one-bank-out diagnostic shows a sign flip or >50% magnitude change.\n\n**Concern**: With p=0.9258 and an instability diagnostic failing (`leave_one_bank_out`), the estimate is both statistically uninformative and not robust to the removal of a single bank, implying the reduced-form association is likely driven by one influential unit and is not credible for causal interpretation under this PANEL_LP_EXPOSURE_FE design.\n\n**Recommendation**: Do not use this edge for causal claims; either (i) downgrade/omit it from the main results and report it only as unstable/noisy, or (ii) re-estimate with influence-robust strategies (identify the influential bank(s), report leave-one-out estimates, consider trimming/winsorizing exposures, and/or use robust methods like median/Huber M-estimation or reweighting) before reconsidering inclusion.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:nbk_rate_to_deposit_cost": "**Finding**: The edge **nbk_rate_to_deposit_cost** is statistically significant (**\u03b2 = 0.2227**, **SE = 0.0618**, **p = 0.0003135**, **N = 18**) under **LOCAL_PROJECTIONS**, but it is marked **Claim level = BLOCKED_ID** with failed diagnostics (**effective_obs**, **residual_ac1**).\n\n**Concern**: Despite the low p-value, causal validity is not supported because identification is explicitly blocked and the failed diagnostics indicate (i) too few effective observations given **N = 18** and (ii) autocorrelated residuals (failed **residual_ac1**), both of which can make the reported **p = 0.0003135** materially overstate evidence against the null and undermine the causal interpretation of **\u03b2 = 0.2227**.\n\n**Recommendation**: Treat this edge as **non-causal/associational only** (do not use it for causal claims or policy simulation) unless you can unblock identification (e.g., a defensible exogenous shock/instrument or design change) and re-estimate with inference robust to serial correlation (e.g., LP with HAC/Newey\u2013West or block bootstrap) while also addressing the **effective_obs** failure, because with **N = 18** the current \u201csignificant\u201d result is not decision-safe.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:oil_demand_to_income": "**Finding**: The edge **oil_demand_to_income** is flagged because it is statistically significant (**p = 0.0030**) but the current claim level is **REDUCED_FORM**, and there is **no identified causal effect estimate reported** (Coefficient/SE/N/Design are **N/A**).\n\n**Concern**: With only a reduced-form association (and no failed diagnostics reported), the **p = 0.0030** result can reflect confounding, reverse causality, or simultaneity, so treating this as causal would be invalid despite statistical significance.\n\n**Recommendation**: Keep the claim explicitly **associational/predictive** unless you can upgrade to an **identified design** (e.g., valid IV, DiD, RD, or controlled adjustment with justified ignorability) and then report an actual **coefficient, SE, N, and identification checks**; otherwise, downgrade interpretation and document that **p = 0.0030 supports correlation only, not causation**.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:loan_portfolio_to_rwa": "**Finding**: The edge `loan_portfolio_to_rwa \u2192 rwa` shows a positive estimated coefficient of **0.5714**, and the issue message reports **p=0.0000** (despite the edge table listing **SE=0.0** and **p-value=None**, with **N=None**).\n\n**Concern**: With **SE=0.0** and **N missing**, the reported **p=0.0000** is not interpretable as statistical evidence, and the tool\u2019s flag (\u201c**SIGNIFICANT_BUT_NOT_IDENTIFIED**\u201d / **claim_level=REDUCED_FORM**) indicates that\u2014even if significant\u2014this association may be **reduced-form** and not a defensible causal effect, though **no diagnostics failed**.\n\n**Recommendation**: Treat this edge as **non-identified / accounting-identity-driven** under the **ACCOUNTING_BRIDGE** design and **downgrade the claim to reduced-form unless you can supply valid uncertainty (nonzero SE, explicit N) and a clear identification argument**, because the current \u201csignificance\u201d signal (p=0.0000 with SE=0.0 and N=None) is effectively a computation/definition artifact rather than causal evidence.",
  "SIGNIFICANT_BUT_NOT_IDENTIFIED:cor_to_capital": "**Finding**: The edge **cor_to_capital** shows a large estimated effect (**coefficient = -22.4**) but the uncertainty stats are internally inconsistent (**SE = 0.0**, **p-value = None**, **N = None**) while the issue flag reports \u201c**p=0.0000**\u201d alongside a blocked-identification condition.\n\n**Concern**: With **SE=0.0** and missing **N/p-value**, the apparent \u201c**p=0.0000**\u201d is not interpretable and can be a numerical/artifact-driven significance signal rather than evidence of a valid causal estimate\u2014so despite **Claim level: IDENTIFIED_CAUSAL** and **no failed diagnostics**, the estimate is not auditably identified and risks a false causal conclusion.\n\n**Recommendation**: **Block causal use and treat as non-identified until the inference metadata is corrected**\u2014specifically, recompute/verify **N**, a non-degenerate **SE**, and a consistent **p-value** under the **ACCOUNTING_BRIDGE** design (or rerun with robust/clustered SEs as appropriate), and only then decide whether **-22.4** is a stable identified causal effect or an accounting/estimation artifact.",
  "RATING_DIAGNOSTICS_CONFLICT:oil_supply_to_fx": "**Finding**: The estimated effect on edge **oil_supply_to_fx** is essentially zero (**coef = 0.0004479**) and completely statistically insignificant (**p = 0.9972**, **SE = 0.1277**, **N = 187**) despite receiving an **A** rating.\n\n**Concern**: An **A** rating is not credible when the estimate provides no evidentiary support for an effect (p \u2248 1), so the rating likely reflects a scoring/logic conflict (even though \u201cFailed diagnostics: none\u201d) and could be misinterpreted as \u201chigh-confidence causal effect\u201d rather than \u201chigh-confidence null.\u201d\n\n**Recommendation**: Downgrade the rating from **A** to reflect \u201cno detectable effect\u201d (or split the rating into separate dimensions: **identification/diagnostics = A** but **evidence strength = D/F** given **p = 0.9972**), and treat this edge as **not supporting a causal impact** in decision-making unless the goal is explicitly to document a precisely estimated null.",
  "RATING_DIAGNOSTICS_CONFLICT:oil_demand_to_fx": "**Finding**: The edge oil_demand_to_fx has a negative coefficient of **-0.2983** with **p = 0.0641** (SE **0.1611**, N **187**) but is assigned an **A rating** while the record shows **no failed diagnostics**.\n\n**Concern**: The stated issue (\u201cA-rating despite failed diagnostics\u201d) is not supported by the provided diagnostics (none failed), so the high-severity conflict likely reflects a **metadata/flagging error**; however, independently of that, the estimate is only **marginally significant at 10% (not at 5%)**, which weakens the evidential strength one would typically associate with an A-rated reduced-form local projection.\n\n**Recommendation**: **Resolve the conflict by correcting the diagnostic flag (since none failed) and downgrade or qualify the rating** (e.g., to reflect **p = 0.0641** as \u201csuggestive\u201d rather than \u201cstrong\u201d evidence) unless your rating policy explicitly permits A ratings for reduced-form LP results that are only significant at the 10% level."
};
const ORPHAN_EXPLANATIONS = {
  "global_activity_shock": "**Role**: `global_activity_shock` is meant to capture exogenous swings in world real activity (IGREA innovations) that should propagate into Kazakhstan mainly through external demand and global risk/commodity channels.\n\n**Blocker (ESTIMATION)**: The DAG already routes \u201cglobal conditions\u201d through `oil_demand_shock -> kzt_usd` and `vix_shock -> kzt_usd` (and then into `brent_price`, CPI, and `nbk_policy_rate`), so while `global_activity_shock` conceptually affects `oil_demand_shock`, `brent_price`, and/or `vix_shock`, those additional edges have not been estimated/parameterized and would be partly duplicative given the existing global-factor nodes that are already wired.\n\n**Path forward**: Estimate and fix a single, identified linkage\u2014e.g., add and estimate `global_activity_shock -> oil_demand_shock` (and optionally test whether `global_activity_shock -> vix_shock` adds incremental explanatory power beyond `vix_shock`) using the same external IGREA series and then keep only the non-redundant edge(s); otherwise remove `global_activity_shock` if it does not add variation beyond the existing `oil_demand_shock`/`vix_shock` structure.",
  "E_import_share": "**Role**: `E_import_share` is a *time-invariant exposure* node meant to capture cross-regional heterogeneity in how exchange-rate\u2013driven tradable inflation passes through to local prices, incomes, and ultimately bank credit risk.\n\n**Blocker (DESIGN)**: The current DAG is effectively a **single time-series macro \u2192 banking** structure (e.g., `oil_*_shock/vix_shock -> kzt_usd -> cpi_* -> nbk_policy_rate -> {deposit_cost_kspi, cor_kspi}` plus the IV path `imported_inflation_instrument -> {npl_kspi, cor_kspi}`), so there is **no region panel/outcome node or interaction structure** where a static regional share can enter\u2014without region-level outcomes, wiring `E_import_share` would be either non-identified (purely cross-sectional) or would implicitly require an unmodeled design like `kzt_usd \u00d7 E_import_share -> cpi_tradable` / `real_expenditure` that the DAG does not currently support.\n\n**Path forward**: Add a region (or bank-region) panel layer and encode heterogeneous pass-through by introducing interaction/shift-share edges such as `(kzt_usd, brent_price) -> imported_inflation_instrument` with `E_import_share` as the exposure (or explicitly `kzt_usd \u00d7 E_import_share -> cpi_tradable_region` / `real_expenditure_region -> payments_revenue_kspi_region`), then estimate with a Bartik/DiD-style specification using region fixed effects; otherwise remove `E_import_share` as redundant in a purely aggregate DAG.",
  "wage_income": "**Role**: `wage_income` is the labor-market channel linking macro conditions (oil/FX/inflation/monetary policy) to households\u2019 ability to service debt and consume, which would in turn affect bank asset quality (e.g., `npl_kspi`, `cor_kspi`) and transaction activity (`payments_revenue_kspi`).\n\n**Blocker (REDUNDANT)**: In the current DAG, household income already enters through `nominal_income` with the edge `cpi_headline -> nominal_income` (and spending through `real_expenditure`, plus FX/inflation/IV routes into `npl_kspi`/`cor_kspi`), so adding `wage_income` without a distinct, separately identified path would duplicate the same household-income/consumption channel and create ambiguity about whether effects run via wages versus broader income components.\n\n**Path forward**: Either remove `wage_income` as redundant, or re-wire it only if you can make it non-overlapping with `nominal_income`\u2014e.g., redefine `nominal_income` as *non-wage income* and add edges like `nbk_policy_rate -> wage_income` (labor demand) and `wage_income -> real_expenditure` / `wage_income -> npl_kspi` / `wage_income -> cor_kspi`, then estimate/validate those links with a wage-specific series and an identification strategy that separates wage shocks from price-indexation already captured by `cpi_headline -> nominal_income`.",
  "nominal_expenditure": "**Role**: `nominal_expenditure` is the nominal-spending counterpart to `real_expenditure`, intended to carry the price-level (CPI) channel from inflation/exchange-rate shocks into household demand and thus into banks\u2019 payments-related income.\n\n**Blocker (REDUNDANT)**: In the current DAG structure the demand-to-banks channel is already operationalized via `real_expenditure -> payments_revenue_kspi`, while the price-level channel is separately represented via `cpi_headline -> nominal_income` and the FX-to-inflation links (`kzt_usd -> cpi_tradable/nontradable`), so wiring `nominal_expenditure` would duplicate the same \u201cnominal vs real\u201d mapping unless you also specify how it differs from the existing real-spending node (e.g., via CPI deflation/identity).\n\n**Path forward**: Either (i) remove `nominal_expenditure` as truly redundant, or (ii) make it non-redundant by adding the missing structural links/identity\u2014e.g., `nominal_expenditure -> real_expenditure` (deflation) and/or `cpi_headline -> nominal_expenditure` plus `nominal_income -> nominal_expenditure` (budget constraint)\u2014and then decide whether `payments_revenue_kspi` should load on nominal rather than real spending (swap/add `nominal_expenditure -> payments_revenue_kspi`) to reflect how payments revenues scale with transaction values.",
  "npl_aggregate": "**Role**: `npl_aggregate` is meant to capture system-wide asset quality (sector NPLs) as a macro-financial outcome that should move with external shocks (oil, FX, inflation) and monetary conditions, and potentially mediate their effect on bank-level balance-sheet variables.\n\n**Blocker (DATA)**: The current DAG already has an NPL outcome wired at the bank level (`imported_inflation_instrument -> npl_kspi`), but there is no ingested/compatible mapping between NBK\u2019s sector NPL definition and the KSPI NPL measure (coverage, methodology, breaks, frequency, and timing), so adding edges like `kzt_usd -> npl_aggregate`, `nbk_policy_rate -> npl_aggregate`, or linking `npl_aggregate <-> npl_kspi` would risk mixing non-comparable series and creating ambiguous, non-identified paths relative to the existing `shock_to_npl_kspi` edge.\n\n**Path forward**: Ingest and harmonize the NBK aggregate NPL series to the DAG\u2019s timing/frequency and definitions (document breaks, align to KSPI\u2019s perimeter or build a bridge/measurement model), then wire it as either (i) a separate macro outcome driven by existing macro nodes (e.g., `kzt_usd`, `cpi_headline`, `nbk_policy_rate`, oil shocks) or (ii) an aggregator/measurement node fed by `npl_kspi` (and other bank NPLs if available); if harmonization shows it is effectively the same signal as `npl_kspi`, remove it as redundant.",
  "deposits_kspi": "**Role**: `deposits_kspi` is the funding-quantity state variable for Kaspi\u2014capturing how the liability base responds to macro conditions and pricing (`deposit_cost_kspi`) and, in turn, constrains balance-sheet expansion (e.g., `loan_portfolio_kspi`, `rwa_kspi`, and ultimately `k2_ratio_kspi`).\n\n**Blocker (DESIGN)**: In this DAG, the natural edges you\u2019d want\u2014most immediately `deposit_cost_kspi -> deposits_kspi` (price\u2013quantity of deposits) and `nominal_income/real_expenditure -> deposits_kspi` (household liquidity/savings channel), and then `deposits_kspi -> loan_portfolio_kspi` (funding constraint)\u2014are not wired because deposits and deposit rates are jointly determined by Kaspi\u2019s funding strategy and growth plans (e.g., expected loan growth/asset yields and risk, proxied by `loan_portfolio_kspi`, `cor_kspi`, `npl_kspi`), creating simultaneity and reverse causality with no existing exogenous shifter in the current graph beyond `nbk_policy_rate -> deposit_cost_kspi`.\n\n**Path forward**: Add an identification device for deposit supply (e.g., an exogenous \u201cdeposit competition/liquidity\u201d shifter such as systemwide deposit rate changes or competitor-specific funding shocks, regulatory liquidity events, or high-frequency policy surprises) and then wire the core triangle explicitly\u2014`nbk_policy_rate -> deposit_cost_kspi -> deposits_kspi` and `deposits_kspi -> loan_portfolio_kspi`\u2014while controlling/structuring feedback from `loan_portfolio_kspi` (and/or `cor_kspi`, `npl_kspi`) to `deposit_cost_kspi` to avoid backdoor paths.",
  "ppop_kspi": "**Role**: `ppop_kspi` is the core profitability node that should aggregate KSPI\u2019s operating income channels (e.g., payments revenue) net of operating costs, and act as the upstream driver of internal capital generation alongside credit losses.\n\n**Blocker (ESTIMATION)**: Although the DAG already contains clear candidate parents\u2014most directly `payments_revenue_kspi -> ppop_kspi` (revenue component) and plausibly `deposit_cost_kspi -> ppop_kspi` (funding-cost pressure on net interest income), with downstream links like `ppop_kspi -> total_capital_kspi` (retained earnings)\u2014these links have not been wired because PPOP is a bank-internal accounting aggregate that is jointly determined with balance-sheet choices (`loan_portfolio_kspi`, `portfolio_mix_kspi`) and omitted opex dynamics, making a naive regression of PPOP on the existing connected nodes non-credible without a dedicated identification/measurement step.\n\n**Path forward**: Unblock by (i) decomposing PPOP into modeled subcomponents already in the DAG (e.g., add/ingest an opex proxy and NII drivers, then wire `real_expenditure -> payments_revenue_kspi -> ppop_kspi` and `nbk_policy_rate -> deposit_cost_kspi -> ppop_kspi`), and (ii) treating `ppop_kspi -> total_capital_kspi` as a mechanical/identity edge via retained earnings once dividend/payout assumptions (or data) are introduced.",
  "marketplace_revenue_kspi": "**Role**: `marketplace_revenue_kspi` is meant to capture the non-banking (e-commerce marketplace) earnings channel through which Kazakhstan\u2019s macro conditions can affect KSPI\u2019s consolidated profitability and, indirectly, its balance-sheet strength.\n\n**Blocker (ESTIMATION)**: While the existing DAG already wires macro demand and inflation/exchange-rate forces into `payments_revenue_kspi` via `real_expenditure -> payments_revenue_kspi`, the analogous mapping from the current macro block (`kzt_usd`, `cpi_*`, `nominal_income`, `real_expenditure`, `nbk_policy_rate`) into *marketplace* revenue is not yet specified/estimated (i.e., candidate edges like `real_expenditure -> marketplace_revenue_kspi` and/or `nominal_income -> marketplace_revenue_kspi` are conceptually plausible but currently unquantified and could double-count the same consumption channel already used for payments without a separate identification).\n\n**Path forward**: Add and estimate a distinct demand-side link\u2014start with `real_expenditure -> marketplace_revenue_kspi` (and optionally `kzt_usd -> marketplace_revenue_kspi` if pass-through/import content is material)\u2014then validate that it is empirically separable from the already-modeled `real_expenditure -> payments_revenue_kspi` channel (e.g., using segment disclosures and a multivariate/VAR or local-projection setup with the existing exogenous shocks to avoid conflating common demand movements).",
  "fintech_revenue_kspi": "**Role**: `fintech_revenue_kspi` is the outcome-side business-line node meant to capture Kaspi.kz\u2019s lending/fintech revenue response to macro conditions (rates, FX/inflation-driven demand) and to KSPI\u2019s balance-sheet/credit channel (loan growth and asset quality).\n\n**Blocker (ESTIMATION)**: In the current DAG, the obvious parent channels are already represented but only wired into other outcomes\u2014e.g., `nbk_policy_rate -> deposit_cost_kspi` and `nbk_policy_rate -> cor_kspi`, plus `loan_portfolio_kspi -> rwa_kspi` (mechanical) and `real_expenditure -> payments_revenue_kspi`; however, no edge has been estimated/validated that maps these existing drivers into `fintech_revenue_kspi` (and without that, adding links like `nbk_policy_rate -> fintech_revenue_kspi`, `loan_portfolio_kspi -> fintech_revenue_kspi`, or `npl_kspi/cor_kspi -> fintech_revenue_kspi` risks mis-specification and double-counting within the KSPI block).\n\n**Path forward**: Estimate and then wire a minimal, identified set of parents\u2014start with `loan_portfolio_kspi -> fintech_revenue_kspi` (scale effect) and `nbk_policy_rate -> fintech_revenue_kspi` (pricing/margin effect), using the already-modeled macro variation (`imported_inflation_instrument`, `oil_*_shock`, `vix_shock` feeding into `kzt_usd -> cpi_headline -> nbk_policy_rate`) as exogenous sources, and add `cor_kspi`/`npl_kspi` only if you can separately identify a credit-loss/constraint effect on lending revenue."
};
const CAUSAL_ASSESSMENTS = {};

// ── Helpers ──────────────────────────────────────────────────────────────
function escHtml(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

var PROVENANCE_LABELS = {
    'manual': 'Manual',
    'paper_scout': 'PaperScout',
    'data_scout': 'DataScout',
    'discovery_agent': 'Discovery'
};

function provenanceBadge(src) {
    if (!src) return '';
    var label = PROVENANCE_LABELS[src] || src;
    return '<span class="provenance-badge ' + escHtml(src) + '">' + escHtml(label) + '</span>';
}

function renderMarkdown(s) {
    if (!s) return '';
    var h = escHtml(s);
    // Bold: **text** or __text__
    h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    h = h.replace(/__(.+?)__/g, '<strong>$1</strong>');
    // Italic: *text* or _text_ (but not inside already-converted strong)
    h = h.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
    h = h.replace(/(?<!_)_(?!_)(.+?)(?<!_)_(?!_)/g, '<em>$1</em>');
    // Inline code: `text`
    h = h.replace(/`([^`]+)`/g, '<code style="background:#e8e8e8;padding:1px 3px;font-size:9px;">$1</code>');
    // Bullet lists: lines starting with - or *
    h = h.replace(/^[\-\*]\s+(.+)$/gm, '<li>$1</li>');
    h = h.replace(/((?:<li>.*<\/li>\s*)+)/g, '<ul style="margin:4px 0 4px 16px;padding:0;">$1</ul>');
    // Numbered lists: lines starting with 1. 2. etc
    h = h.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
    // Line breaks: double newline -> paragraph break, single newline -> <br>
    h = h.replace(/\n\n+/g, '</p><p style="margin:4px 0;">');
    h = h.replace(/\n/g, '<br>');
    h = '<p style="margin:4px 0;">' + h + '</p>';
    return h;
}

function renderGuidanceSections(s) {
    if (!s) return '';
    // Split into Finding / Concern / Recommendation sections
    var sections = [
        {key: 'finding', re: /\*\*Finding\*\*:\s*/i},
        {key: 'concern', re: /\*\*Concern\*\*:\s*/i},
        {key: 'recommendation', re: /\*\*Recommendation\*\*:\s*/i}
    ];
    // Find section boundaries
    var parts = [];
    var text = s;
    var indices = [];
    sections.forEach(function(sec) {
        var m = text.match(sec.re);
        if (m) indices.push({key: sec.key, idx: text.indexOf(m[0]), len: m[0].length, label: sec.key.charAt(0).toUpperCase() + sec.key.slice(1)});
    });
    indices.sort(function(a, b) { return a.idx - b.idx; });

    if (indices.length === 0) {
        // No structured sections found, fall back to plain markdown
        return renderMarkdown(s);
    }

    var html = '';
    for (var i = 0; i < indices.length; i++) {
        var start = indices[i].idx + indices[i].len;
        var end = (i + 1 < indices.length) ? indices[i + 1].idx : text.length;
        var body = text.substring(start, end).trim();
        html += '<div class="pd-section ' + indices[i].key + '">' +
            '<div class="pd-section-label">' + escHtml(indices[i].label) + '</div>' +
            renderMarkdown(body) +
            '</div>';
    }
    return html;
}

function formatBeta(beta) {
    if (beta === null || beta === undefined) return '--';
    if (beta === 0) return '0';
    var abs = Math.abs(beta);
    if (abs >= 10000) return (beta / 1000).toFixed(0) + 'k';
    if (abs >= 1000) return (beta / 1000).toFixed(1) + 'k';
    if (abs >= 100) return beta.toFixed(0);
    if (abs >= 10) return beta.toFixed(1);
    if (abs >= 1) return beta.toFixed(1);
    if (abs >= 0.01) return beta.toFixed(2);
    if (abs >= 0.001) return beta.toFixed(3);
    return beta.toExponential(1);
}
function fmtP(p) {
    if (p === null || p === undefined) return '--';
    if (p < 0.0001) return p.toExponential(2);
    return p.toFixed(4);
}

function getEdgeColor(d) {
    var isNull = d.pvalue !== null && d.pvalue !== undefined && d.pvalue >= 0.05;
    if (isNull) return '#999';
    return EDGE_TYPE_COLORS[d.edge_type] || '#2563eb';
}
function isEdgeNull(d) {
    return d.pvalue !== null && d.pvalue !== undefined && d.pvalue >= 0.05;
}

// ── Decision state ───────────────────────────────────────────────────────
var decisions = {}; // issue_key -> {value, rationale}

// Flatten all issues across edges for the sidebar
var allIssues = [];
var SEVERITY_ORDER = {CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3};
EDGES.forEach(function(e) {
    if (e.issues && e.issues.length > 0) {
        e.issues.forEach(function(issue) {
            allIssues.push({
                edge_id: e.id,
                issue_key: issue.issue_key || (issue.rule_id + ':' + e.id),
                rule_id: issue.rule_id,
                severity: issue.severity,
                message: issue.message
            });
        });
    }
});
allIssues.sort(function(a, b) {
    var sa = SEVERITY_ORDER[a.severity] || 99;
    var sb = SEVERITY_ORDER[b.severity] || 99;
    if (sa !== sb) return sa - sb;
    return a.edge_id.localeCompare(b.edge_id);
});
var totalIssues = allIssues.length;

function countResolved() {
    var c = 0;
    for (var k in decisions) {
        if (decisions[k] && decisions[k].value) c++;
    }
    return c;
}

function updateProgress() {
    var resolved = countResolved();
    var pct = totalIssues > 0 ? (resolved / totalIssues * 100) : 0;
    document.getElementById('pitfallProgressFill').style.width = pct + '%';
    document.getElementById('pitfallProgressLabel').textContent = resolved + ' / ' + totalIssues + ' resolved';
}

// ── Setup ────────────────────────────────────────────────────────────────
document.getElementById('dagSubtitle').textContent =
    NODES.length + ' nodes, ' + EDGES.length + ' edges';
document.getElementById('statNodes').textContent = NODES.length;

// Compute node layers via topological distance from roots
var inDegree = {};
NODES.forEach(function(n) { inDegree[n.id] = 0; });
EDGES.forEach(function(e) { inDegree[e.target] = (inDegree[e.target] || 0) + 1; });

var layers = {};
var visited = {};
function computeLayer(nodeId) {
    if (visited[nodeId]) return layers[nodeId] || 0;
    visited[nodeId] = true;
    var incoming = EDGES.filter(function(e) { return e.target === nodeId; });
    if (incoming.length === 0) { layers[nodeId] = 0; return 0; }
    var maxParent = 0;
    incoming.forEach(function(e) {
        var pLayer = computeLayer(e.source);
        if (pLayer + 1 > maxParent) maxParent = pLayer + 1;
    });
    layers[nodeId] = maxParent;
    return maxParent;
}
NODES.forEach(function(n) { computeLayer(n.id); });
NODES.forEach(function(n) { n.layer = layers[n.id] || 0; });

// Populate type filter
var typeSet = {};
EDGES.forEach(function(e) { typeSet[e.edge_type || 'causal'] = true; });
var typeFilter = document.getElementById('typeFilter');
Object.keys(typeSet).sort().forEach(function(t) {
    var opt = document.createElement('option');
    opt.value = t;
    opt.textContent = EDGE_TYPE_LABELS[t] || t;
    typeFilter.appendChild(opt);
});

// Build legend
var legendContainer = document.getElementById('legendContainer');
Object.keys(typeSet).sort().forEach(function(t) {
    var color = EDGE_TYPE_COLORS[t] || '#2563eb';
    var div = document.createElement('div');
    div.className = 'legend-item';
    div.innerHTML = '<div class="legend-line" style="background:' + color + '"></div>' +
        (EDGE_TYPE_LABELS[t] || t);
    legendContainer.appendChild(div);
});
var nullLeg = document.createElement('div');
nullLeg.className = 'legend-item';
nullLeg.innerHTML = '<div class="legend-line dashed" style="border-color:#999"></div>Null / Insig.';
legendContainer.appendChild(nullLeg);

// ── Build pitfall sidebar ────────────────────────────────────────────────
var pitfallList = document.getElementById('pitfallList');

if (allIssues.length === 0) {
    pitfallList.innerHTML = '<div class="pitfall-empty">No open issues.</div>';
} else {
    allIssues.forEach(function(issue) {
        var ruleInfo = RULE_DESCRIPTIONS[issue.rule_id] || {};
        var actCfg = ACTIONS_BY_RULE[issue.rule_id] || ACTIONS_BY_RULE['_default'] || {};
        var options = actCfg.options || [];

        var div = document.createElement('div');
        div.className = 'pitfall-item';
        div.setAttribute('data-issue-key', issue.issue_key);
        div.setAttribute('data-edge-id', issue.edge_id);

        // Build options HTML
        var optHtml = '<option value="">-- select action --</option>';
        options.forEach(function(o) {
            optHtml += '<option value="' + escHtml(o.value) + '" data-tooltip="' + escHtml(o.tooltip || '') + '">' + escHtml(o.label) + '</option>';
        });

        var llmText = ISSUE_GUIDANCE[issue.issue_key] || '';
        var llmHtml = llmText ?
            '<div class="pd-llm-guidance"><div class="pd-llm-guidance-title">AI Analysis</div>' +
            renderGuidanceSections(llmText) + '</div>' : '';

        // Build static text (Why it matters + Decision guidance)
        var staticHtml = '';
        if (ruleInfo.explanation || ruleInfo.guidance) {
            var staticContent =
                (ruleInfo.explanation ? '<div class="pd-label">Why it matters:</div><div class="pd-text">' + ruleInfo.explanation + '</div>' : '') +
                (ruleInfo.guidance ? '<div class="pd-label">Decision guidance:</div><div class="pd-guidance">' + ruleInfo.guidance + '</div>' : '');
            if (llmText) {
                // Collapse when AI Analysis is present
                staticHtml = '<details class="pd-static-ref"><summary>Reference</summary>' + staticContent + '</details>';
            } else {
                staticHtml = staticContent;
            }
        }

        // Strategy tag and verdict badge for pitfall items
        var edgeObj = EDGES.find(function(e2) { return e2.id === issue.edge_id; });
        var stratTag = (edgeObj && edgeObj.strategy_type) ?
            '<span class="strategy-tag">' + escHtml(edgeObj.strategy_type.replace(/_/g, ' ')) + '</span>' : '';
        var provBadge = (edgeObj && edgeObj.provenance_source) ? provenanceBadge(edgeObj.provenance_source) : '';
        var caText = (edgeObj && edgeObj.causal_assessment) ? edgeObj.causal_assessment :
            (CAUSAL_ASSESSMENTS[issue.edge_id] || '');
        var verdict = extractVerdict(caText);
        var verdictBadge = verdict ?
            '<span class="id-badge ' + verdict + '">' + verdict + '</span>' : '';
        var caHtml = caText ?
            '<div class="causal-assessment"><div class="causal-assessment-title">Causal Assessment</div>' +
            renderCausalAssessment(caText) + '</div>' : '';

        div.innerHTML =
            '<div class="pitfall-item-header" data-header="1">' +
                '<span class="pitfall-edge">' + escHtml(issue.edge_id) + '</span>' +
                '<span class="pitfall-severity ' + issue.severity + '">' + issue.severity + '</span>' +
                verdictBadge + provBadge + stratTag +
                '<span class="pitfall-resolved-check">&#10003;</span>' +
            '</div>' +
            '<div class="pitfall-msg">' + escHtml(issue.message) + '</div>' +
            '<div class="pitfall-decision" data-decision-key="' + escHtml(issue.issue_key) + '">' +
                llmHtml +
                caHtml +
                staticHtml +
                '<div class="pd-label">Action:</div>' +
                '<select data-key="' + escHtml(issue.issue_key) + '">' + optHtml + '</select>' +
                '<div class="pd-tooltip-area" data-tip-for="' + escHtml(issue.issue_key) + '"></div>' +
                '<input type="text" data-rationale="' + escHtml(issue.issue_key) + '" placeholder="Justification (optional)...">' +
                '<div class="pd-buttons">' +
                    '<button class="pd-btn pd-btn-confirm" data-confirm="' + escHtml(issue.issue_key) + '">Confirm</button>' +
                    '<button class="pd-btn" data-defer="' + escHtml(issue.issue_key) + '">Defer</button>' +
                '</div>' +
            '</div>';

        pitfallList.appendChild(div);
    });
}

// ── Add clean-edge entries (edges without issues) ────────────────────────
var edgesWithIssues = {};
allIssues.forEach(function(i) { edgesWithIssues[i.edge_id] = true; });

var cleanEdges = EDGES.filter(function(e) { return !edgesWithIssues[e.id]; });
if (cleanEdges.length > 0) {
    var divider = document.createElement('div');
    divider.className = 'pitfall-divider';
    divider.textContent = 'Assessed Edges (' + cleanEdges.length + ')';
    pitfallList.appendChild(divider);

    cleanEdges.forEach(function(edge) {
        var div = document.createElement('div');
        div.className = 'pitfall-item clean-edge';
        div.setAttribute('data-edge-id', edge.id);

        var ratingHtml = edge.rating ? '<span class="pitfall-rating">' + escHtml(edge.rating) + '</span>' : '';
        var statsHtml = '';
        if (edge.point !== null && edge.point !== undefined) {
            statsHtml = '<div class="pitfall-stats">' +
                '\u03B2=' + formatBeta(edge.point) +
                (edge.pvalue !== null && edge.pvalue !== undefined ? '  p=' + fmtP(edge.pvalue) : '') +
                (edge.design ? '  ' + escHtml(edge.design) : '') +
                '</div>';
        }

        var annText = edge.llm_annotation || '';
        var annHtml = annText ?
            '<div class="pd-llm-guidance"><div class="pd-llm-guidance-title">AI Analysis</div>' +
            renderMarkdown(annText) + '</div>' : '';

        // Strategy tag, provenance badge, and verdict badge for clean edges
        var cleanStratTag = edge.strategy_type ?
            '<span class="strategy-tag">' + escHtml(edge.strategy_type.replace(/_/g, ' ')) + '</span>' : '';
        var cleanProvBadge = edge.provenance_source ? provenanceBadge(edge.provenance_source) : '';
        var cleanCaText = edge.causal_assessment || CAUSAL_ASSESSMENTS[edge.id] || '';
        var cleanVerdict = extractVerdict(cleanCaText);
        var cleanVerdictBadge = cleanVerdict ?
            '<span class="id-badge ' + cleanVerdict + '">' + cleanVerdict + '</span>' : '';
        var cleanCaHtml = cleanCaText ?
            '<div class="causal-assessment"><div class="causal-assessment-title">Causal Assessment</div>' +
            renderCausalAssessment(cleanCaText) + '</div>' : '';

        div.innerHTML =
            '<div class="pitfall-item-header" data-header="1">' +
                '<span class="pitfall-edge">' + escHtml(edge.id) + '</span>' +
                ratingHtml + cleanVerdictBadge + cleanProvBadge + cleanStratTag +
            '</div>' +
            statsHtml +
            '<div class="pitfall-decision" data-decision-key="edge:' + escHtml(edge.id) + '">' +
                annHtml +
                cleanCaHtml +
            '</div>';

        pitfallList.appendChild(div);
    });
}

updateProgress();

// ── Click-to-highlight + expand ──────────────────────────────────────────
var currentHighlightEdge = null;

function highlightEdge(edgeId) {
    // Remove previous highlight
    links.classed('highlighted', false);
    // Apply highlight to matching link
    links.each(function(d) {
        if (d.id === edgeId) {
            d3.select(this).classed('highlighted', true);
        }
    });
    currentHighlightEdge = edgeId;

    // Pan/zoom to edge midpoint
    var edgeData = EDGES.find(function(e) { return e.id === edgeId; });
    if (edgeData && edgeData.source && edgeData.target) {
        var sx = edgeData.source.x || edgeData.source;
        var sy = edgeData.source.y || edgeData.source;
        var tx = edgeData.target.x || edgeData.target;
        var ty = edgeData.target.y || edgeData.target;
        if (typeof sx === 'number' && typeof tx === 'number') {
            var mx = (sx + tx) / 2;
            var my = (sy + ty) / 2;
            var svgEl = document.getElementById('graph');
            var w = svgEl.clientWidth;
            var h = svgEl.clientHeight;
            var t = d3.zoomIdentity.translate(w/2 - mx, h/2 - my);
            svg.transition().duration(500).call(zoomBehavior.transform, t);
        }
    }
}

function markEdgeResolved(edgeId) {
    // Check if ALL issues for this edge are resolved
    var edgeIssues = allIssues.filter(function(i) { return i.edge_id === edgeId; });
    var allResolved = edgeIssues.every(function(i) {
        return decisions[i.issue_key] && decisions[i.issue_key].value;
    });
    if (allResolved) {
        links.each(function(d) {
            if (d.id === edgeId) {
                d3.select(this).classed('edge-resolved', true).classed('critical-issue', false).classed('highlighted', false);
            }
        });
    }
}

// Event delegation on pitfall list
pitfallList.addEventListener('click', function(e) {
    var target = e.target;

    // Confirm button
    if (target.hasAttribute('data-confirm')) {
        e.stopPropagation();
        var key = target.getAttribute('data-confirm');
        if (!decisions[key] || !decisions[key].value) {
            alert('Please select an action before confirming.');
            return;
        }
        var item = pitfallList.querySelector('[data-issue-key="' + key + '"]');
        if (item) {
            item.classList.add('resolved');
            var sel = item.querySelector('select[data-key="' + key + '"]');
            if (sel) sel.classList.add('decided');
        }
        var edgeId = null;
        allIssues.forEach(function(i) { if (i.issue_key === key) edgeId = i.edge_id; });
        if (edgeId) markEdgeResolved(edgeId);
        updateProgress();
        return;
    }

    // Defer button
    if (target.hasAttribute('data-defer')) {
        e.stopPropagation();
        var key2 = target.getAttribute('data-defer');
        var item2 = pitfallList.querySelector('[data-issue-key="' + key2 + '"]');
        if (item2) {
            item2.classList.remove('active');
            var panel = item2.querySelector('.pitfall-decision');
            if (panel) panel.classList.remove('open');
        }
        links.classed('highlighted', false);
        return;
    }

    // Don't toggle when clicking inside decision panel controls
    if (target.tagName === 'SELECT' || target.tagName === 'INPUT' || target.tagName === 'OPTION') return;

    // Find the pitfall-item
    var pitfallItem = target.closest('.pitfall-item');
    if (!pitfallItem) return;

    // Toggle active state
    var wasActive = pitfallItem.classList.contains('active');

    // Deactivate all
    pitfallList.querySelectorAll('.pitfall-item').forEach(function(el) {
        el.classList.remove('active');
        var p = el.querySelector('.pitfall-decision');
        if (p) p.classList.remove('open');
    });
    links.classed('highlighted', false);

    if (!wasActive) {
        pitfallItem.classList.add('active');
        var decPanel = pitfallItem.querySelector('.pitfall-decision');
        if (decPanel) decPanel.classList.add('open');
        var eid = pitfallItem.getAttribute('data-edge-id');
        if (eid) highlightEdge(eid);
    }
});

// Action dropdown change
pitfallList.addEventListener('change', function(e) {
    if (e.target.tagName !== 'SELECT' || !e.target.hasAttribute('data-key')) return;
    var key = e.target.getAttribute('data-key');
    var val = e.target.value;
    if (!decisions[key]) decisions[key] = {value: '', rationale: ''};
    decisions[key].value = val;

    if (val) {
        e.target.classList.add('decided');
    } else {
        e.target.classList.remove('decided');
    }

    // Show tooltip for selected option
    var tipArea = pitfallList.querySelector('[data-tip-for="' + key + '"]');
    if (tipArea) {
        var selectedOpt = e.target.options[e.target.selectedIndex];
        tipArea.textContent = selectedOpt ? (selectedOpt.getAttribute('data-tooltip') || '') : '';
    }
});

// Rationale input
pitfallList.addEventListener('input', function(e) {
    if (e.target.tagName !== 'INPUT' || !e.target.hasAttribute('data-rationale')) return;
    var key = e.target.getAttribute('data-rationale');
    if (!decisions[key]) decisions[key] = {value: '', rationale: ''};
    decisions[key].rationale = e.target.value;
});

// ── Export ────────────────────────────────────────────────────────────────
document.getElementById('exportBtn').addEventListener('click', function() {
    var analystId = document.getElementById('analystId').value.trim();
    var now = new Date().toISOString();
    var decisionList = [];

    for (var key in decisions) {
        var dec = decisions[key];
        if (!dec.value) continue;
        var parts = key.split(':', 1);
        var ruleId = parts[0] || '';
        var edgeId = key.substring(ruleId.length + 1);
        var actCfg = ACTIONS_BY_RULE[ruleId] || ACTIONS_BY_RULE['_default'] || {};
        decisionList.push({
            issue_key: key,
            edge_id: edgeId,
            rule_id: ruleId,
            action: actCfg.action_type || 'unknown',
            value: dec.value,
            rationale: dec.rationale || '',
            status: 'CLOSED',
            source: 'dag_visualization'
        });
    }

    var output = {
        generated_at: now,
        analyst_id: analystId || 'anonymous',
        panel_built_at: GENERATED_AT,
        decisions: decisionList
    };

    var blob = new Blob([JSON.stringify(output, null, 2)], {type: 'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    var dateStr = now.slice(0,10).replace(/-/g,'');
    a.href = url;
    a.download = 'dag_viz_decisions_' + dateStr + '.json';
    a.click();
    URL.revokeObjectURL(url);
});

// ── D3 Graph ─────────────────────────────────────────────────────────────
var svg = d3.select('#graph');
var width = window.innerWidth;
var height = window.innerHeight;
svg.attr('width', width).attr('height', height);

// Arrow markers
var defs = svg.append('defs');
var defaultColors = Object.values(EDGE_TYPE_COLORS).concat(['#999']);
var colorSet = {};
defaultColors.forEach(function(c) { colorSet[c] = true; });
Object.keys(colorSet).forEach(function(color) {
    defs.append('marker')
        .attr('id', 'arrow-' + color.replace('#', ''))
        .attr('viewBox', '0 -3 6 6')
        .attr('refX', 18)
        .attr('refY', 0)
        .attr('markerWidth', 5)
        .attr('markerHeight', 5)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-3L6,0L0,3')
        .attr('fill', color);
});

var g = svg.append('g');
var zoomBehavior = d3.zoom().scaleExtent([0.3, 3]).on('zoom', function(e) { g.attr('transform', e.transform); });
svg.call(zoomBehavior);

var simulation = d3.forceSimulation(NODES)
    .force('link', d3.forceLink(EDGES).id(function(d) { return d.id; }).distance(120).strength(0.3))
    .force('charge', d3.forceManyBody().strength(-400))
    .force('center', d3.forceCenter(width / 2, height / 2))
    .force('y', d3.forceY(function(d) { return 80 + d.layer * 90; }).strength(0.7))
    .force('x', d3.forceX(width / 2).strength(0.02))
    .force('collision', d3.forceCollide(40));

var linkGroup = g.append('g');
var links = linkGroup.selectAll('path')
    .data(EDGES)
    .enter()
    .append('path')
    .attr('class', function(d) { return 'link' + (isEdgeNull(d) ? ' null' : '') + (d.has_critical_issue ? ' critical-issue' : ''); })
    .attr('stroke', function(d) { return getEdgeColor(d); })
    .attr('stroke-width', function(d) { return d.pvalue !== null && d.pvalue < 0.05 ? 2.5 : 1.5; })
    .attr('marker-end', function(d) { return 'url(#arrow-' + getEdgeColor(d).replace('#', '') + ')'; })
    .on('mouseover', showEdgeTooltip)
    .on('mouseout', hideTooltip);

var labelGroup = g.append('g');
var labelBgs = labelGroup.selectAll('rect')
    .data(EDGES)
    .enter()
    .append('rect')
    .attr('class', 'label-bg')
    .attr('rx', 2)
    .attr('ry', 2);

var linkLabels = labelGroup.selectAll('text')
    .data(EDGES)
    .enter()
    .append('text')
    .attr('class', 'link-label')
    .text(function(d) { return formatBeta(d.point); });

var nodeGroup = g.append('g');
var node = nodeGroup.selectAll('g')
    .data(NODES)
    .enter()
    .append('g')
    .attr('class', 'node')
    .call(d3.drag()
        .on('start', function(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
        .on('drag', function(e, d) { d.fx = e.x; d.fy = e.y; })
        .on('end', function(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }))
    .on('mouseover', showNodeTooltip)
    .on('mouseout', hideTooltip);

// Check if node has ID risks from any edge
var nodeIdRisks = {};
EDGES.forEach(function(e) {
    if (e.id_risks && Object.keys(e.id_risks).length > 0) {
        nodeIdRisks[e.source] = true;
        nodeIdRisks[e.target] = true;
    }
});

node.append('circle')
    .attr('r', 18)
    .attr('class', function(d) {
        var cls = '';
        if (d.latent) cls += ' latent';
        if (d.orphan) cls += ' orphan';
        if (nodeIdRisks[d.id]) cls += ' id-risk';
        return cls;
    });
node.append('text').attr('dy', 4).text(function(d) { return d.label; });

var tooltip = d3.select('#tooltip');

function showEdgeTooltip(e, d) {
    var html = '<h3>' + d.source.id.replace(/_/g, ' ') + ' &rarr; ' + d.target.id.replace(/_/g, ' ') + '</h3>';
    html += '<div class="tooltip-row"><span class="tooltip-label">Edge ID</span><span class="tooltip-value">' + d.id + '</span></div>';
    html += '<div class="tooltip-row"><span class="tooltip-label">Type</span><span class="tooltip-value">' + (EDGE_TYPE_LABELS[d.edge_type] || d.edge_type) + '</span></div>';
    if (d.point !== null && d.point !== undefined) {
        html += '<div class="tooltip-row"><span class="tooltip-label">&beta;</span><span class="tooltip-value">' + d.point.toFixed(4) + '</span></div>';
    }
    if (d.se !== null && d.se !== undefined) {
        html += '<div class="tooltip-row"><span class="tooltip-label">SE</span><span class="tooltip-value">' + d.se.toFixed(4) + '</span></div>';
    }
    if (d.pvalue !== null && d.pvalue !== undefined) {
        html += '<div class="tooltip-row"><span class="tooltip-label">p-value</span><span class="tooltip-value ' + (isEdgeNull(d) ? 'null' : '') + '">' + fmtP(d.pvalue) + '</span></div>';
    }
    if (d.claim_level) html += '<div class="tooltip-row"><span class="tooltip-label">Claim</span><span class="tooltip-value">' + d.claim_level + '</span></div>';
    if (d.rating) html += '<div class="tooltip-row"><span class="tooltip-label">Rating</span><span class="tooltip-value">' + d.rating + '</span></div>';
    if (d.design) html += '<div class="tooltip-row"><span class="tooltip-label">Design</span><span class="tooltip-value">' + d.design + '</span></div>';
    if (d.strategy_type) html += '<div class="tooltip-row"><span class="tooltip-label">ID Strategy</span><span class="tooltip-value">' + d.strategy_type.replace(/_/g, ' ') + '</span></div>';
    if (d.strategy_argument) html += '<div class="tooltip-row"><span class="tooltip-label">Argument</span><span class="tooltip-value" style="text-align:left;font-weight:400;font-size:10px">' + d.strategy_argument + '</span></div>';
    if (d.provenance_source) {
        var srcLabel = PROVENANCE_LABELS[d.provenance_source] || d.provenance_source;
        var srcExtra = d.provenance_detail ? ' (' + escHtml(d.provenance_detail) + ')' : '';
        html += '<div class="tooltip-row"><span class="tooltip-label">Source</span><span class="tooltip-value">' + escHtml(srcLabel) + srcExtra + '</span></div>';
    }
    if (d.diagnostics && d.diagnostics.length > 0) {
        var passed = d.diagnostics.filter(function(x) { return x.passed; }).length;
        html += '<div class="tooltip-row"><span class="tooltip-label">Diagnostics</span><span class="tooltip-value">' + passed + '/' + d.diagnostics.length + ' pass</span></div>';
    }
    if (d.interpretation) html += '<div class="tooltip-row"><span class="tooltip-label">Interpretation</span><span class="tooltip-value" style="text-align:left;font-weight:400">' + d.interpretation + '</span></div>';
    if (d.llm_annotation) {
        html += '<div class="tooltip-annotation">' + d.llm_annotation + '</div>';
    }
    if (d.issues && d.issues.length > 0) {
        html += '<div class="tooltip-issues">';
        d.issues.forEach(function(issue) {
            html += '<div class="tooltip-issue ' + (issue.severity || '').toLowerCase() + '">[' + issue.severity + '] ' + escHtml(issue.message) + '</div>';
        });
        html += '</div>';
    }
    tooltip.html(html).style('left', (e.pageX + 15) + 'px').style('top', (e.pageY - 15) + 'px').classed('visible', true);
}

function renderOrphanSections(s) {
    if (!s) return '';
    // Match **Role**, **Blocker**, **Blocker (TYPE)**, **Path forward**
    var sections = [
        {key: 'role', re: /\*\*Role\*\*:\s*/i},
        {key: 'blocker', re: /\*\*Blocker(?:\s*\([^)]*\))?\*\*:\s*/i},
        {key: 'path-forward', re: /\*\*Path\s+forward\*\*:\s*/i}
    ];
    var indices = [];
    sections.forEach(function(sec) {
        var m = s.match(sec.re);
        if (m) {
            // Extract label from matched text (e.g. "Blocker (DATA)")
            var raw = m[0].replace(/\*\*/g, '').replace(/:\s*$/, '').trim();
            indices.push({key: sec.key, idx: s.indexOf(m[0]), len: m[0].length, label: raw});
        }
    });
    indices.sort(function(a, b) { return a.idx - b.idx; });
    if (indices.length === 0) return '<div style="font-size:10px;color:#555">' + escHtml(s) + '</div>';
    var html = '';
    for (var i = 0; i < indices.length; i++) {
        var start = indices[i].idx + indices[i].len;
        var end = (i + 1 < indices.length) ? indices[i + 1].idx : s.length;
        var body = s.substring(start, end).trim();
        html += '<div class="tooltip-orphan-section ' + indices[i].key + '">' +
            '<div class="tooltip-orphan-label">' + escHtml(indices[i].label) + '</div>' +
            '<div style="font-size:10px">' + escHtml(body) + '</div></div>';
    }
    return html;
}

function extractVerdict(s) {
    if (!s) return '';
    var m = s.match(/\*\*Verdict\*\*:\s*(STRONG|MODERATE|WEAK|ABSENT)/i);
    return m ? m[1].toUpperCase() : '';
}

function renderCausalAssessment(s) {
    if (!s) return '';
    var sections = [
        {key: 'finding', re: /\*\*Strategy\*\*:\s*/i, label: 'Strategy'},
        {key: 'concern', re: /\*\*Strengths\*\*:\s*/i, label: 'Strengths'},
        {key: 'recommendation', re: /\*\*Vulnerabilities\*\*:\s*/i, label: 'Vulnerabilities'},
        {key: 'finding', re: /\*\*Verdict\*\*:\s*/i, label: 'Verdict'}
    ];
    var indices = [];
    sections.forEach(function(sec) {
        var m = s.match(sec.re);
        if (m) indices.push({key: sec.key, idx: s.indexOf(m[0]), len: m[0].length, label: sec.label});
    });
    indices.sort(function(a, b) { return a.idx - b.idx; });
    if (indices.length === 0) return renderMarkdown(s);
    var html = '';
    for (var i = 0; i < indices.length; i++) {
        var start = indices[i].idx + indices[i].len;
        var end = (i + 1 < indices.length) ? indices[i + 1].idx : s.length;
        var body = s.substring(start, end).trim();
        var cls = indices[i].key;
        if (indices[i].label === 'Strengths') cls = 'recommendation';
        if (indices[i].label === 'Vulnerabilities') cls = 'concern';
        html += '<div class="pd-section ' + cls + '">' +
            '<div class="pd-section-label">' + escHtml(indices[i].label) + '</div>' +
            renderMarkdown(body) + '</div>';
    }
    return html;
}

function showNodeTooltip(e, d) {
    var html = '<h3>' + d.label + '</h3>';
    html += '<div class="tooltip-row"><span class="tooltip-label">ID</span><span class="tooltip-value">' + d.id + '</span></div>';
    if (d.description) html += '<div class="tooltip-row"><span class="tooltip-label">Description</span><span class="tooltip-value" style="text-align:left;font-weight:400">' + d.description + '</span></div>';
    if (d.unit) html += '<div class="tooltip-row"><span class="tooltip-label">Unit</span><span class="tooltip-value">' + d.unit + '</span></div>';
    if (d.frequency) html += '<div class="tooltip-row"><span class="tooltip-label">Frequency</span><span class="tooltip-value">' + d.frequency + '</span></div>';
    if (d.latent) html += '<div class="tooltip-row"><span class="tooltip-label">Observed</span><span class="tooltip-value null">Latent (unobserved)</span></div>';
    if (d.provenance_source) {
        var nodeSrcLabel = PROVENANCE_LABELS[d.provenance_source] || d.provenance_source;
        html += '<div class="tooltip-row"><span class="tooltip-label">Source</span><span class="tooltip-value">' + escHtml(nodeSrcLabel) + '</span></div>';
    }
    if (d.orphan) {
        var orphanText = ORPHAN_EXPLANATIONS[d.id] || '';
        html += '<div class="tooltip-orphan">';
        html += '<span class="tooltip-orphan-tag">UNWIRED</span>';
        if (d.provenance_source) html += provenanceBadge(d.provenance_source);
        if (orphanText) {
            html += renderOrphanSections(orphanText);
        } else {
            html += '<div style="font-size:10px;color:#999;font-style:italic">No edges connect this node. Run with --llm-annotate for analysis.</div>';
        }
        html += '</div>';
    }
    tooltip.html(html).style('left', (e.pageX + 15) + 'px').style('top', (e.pageY - 15) + 'px').classed('visible', true);
}

function hideTooltip() { tooltip.classed('visible', false); }

function getLabelPos(d) {
    var dx = d.target.x - d.source.x;
    var dy = d.target.y - d.source.y;
    var dist = Math.sqrt(dx*dx + dy*dy) || 1;
    var t = 0.4;
    var mx = d.source.x + dx * t;
    var my = d.source.y + dy * t;
    var offset = 12;
    var px = -dy / dist * offset;
    var py = dx / dist * offset;
    return { x: mx + px, y: my + py };
}

simulation.on('tick', function() {
    links.attr('d', function(d) {
        var dx = d.target.x - d.source.x, dy = d.target.y - d.source.y;
        var dr = Math.sqrt(dx * dx + dy * dy) * 1.8;
        return 'M' + d.source.x + ',' + d.source.y + 'A' + dr + ',' + dr + ' 0 0,1 ' + d.target.x + ',' + d.target.y;
    });
    linkLabels.each(function(d) {
        var pos = getLabelPos(d);
        d3.select(this).attr('x', pos.x).attr('y', pos.y);
    });
    labelBgs.each(function(d, i) {
        var pos = getLabelPos(d);
        var textNode = linkLabels.nodes()[i];
        var bbox = textNode.getBBox();
        d3.select(this)
            .attr('x', pos.x - bbox.width/2 - 2)
            .attr('y', pos.y - bbox.height/2 - 1)
            .attr('width', bbox.width + 4)
            .attr('height', bbox.height + 2);
    });
    node.attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
});

// ── Filters ──────────────────────────────────────────────────────────────
function applyFilters() {
    var typeVal = document.getElementById('typeFilter').value;
    var ratVal = document.getElementById('ratingFilter').value;
    var showNullVal = document.getElementById('showNull').checked;
    var showLabelsVal = document.getElementById('showLabels').checked;

    var isVisible = function(d) {
        if (typeVal !== 'all' && d.edge_type !== typeVal) return false;
        if (ratVal !== 'all' && d.rating !== ratVal) return false;
        if (!showNullVal && isEdgeNull(d)) return false;
        return true;
    };

    links.style('display', function(d) { return isVisible(d) ? null : 'none'; });
    linkLabels.style('display', function(d) { return (isVisible(d) && showLabelsVal) ? null : 'none'; });
    labelBgs.style('display', function(d) { return (isVisible(d) && showLabelsVal) ? null : 'none'; });

    var visible = EDGES.filter(isVisible);
    document.getElementById('statEdges').textContent = visible.length;
    document.getElementById('statA').textContent = visible.filter(function(e) { return e.rating === 'A'; }).length;
    document.getElementById('statB').textContent = visible.filter(function(e) { return e.rating === 'B'; }).length;
    document.getElementById('statC').textContent = visible.filter(function(e) { return e.rating === 'C'; }).length;
    var visibleIssues = visible.reduce(function(s, e) { return s + (e.issues ? e.issues.length : 0); }, 0);
    document.getElementById('statIssues').textContent = visibleIssues;
    var identified = visible.filter(function(e) { return e.claim_level === 'IDENTIFIED_CAUSAL'; }).length;
    document.getElementById('statIdentified').textContent = identified;
}

document.getElementById('typeFilter').addEventListener('change', applyFilters);
document.getElementById('ratingFilter').addEventListener('change', applyFilters);
document.getElementById('showNull').addEventListener('change', applyFilters);
document.getElementById('showLabels').addEventListener('change', applyFilters);

applyFilters();
    </script>
</body>
</html>